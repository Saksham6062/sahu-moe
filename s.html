<html lang="en" __gchrome_remoteframetoken="dd6719336bd701e2ff67c87ce14fb555"><head><style>
        @import url(https://fonts.googleapis.com/css?family=Google+Sans+Text);
        html {
          font-family: 'Google Sans Text', 'Google Sans';
          font-size: 14px;
          color-scheme: light dark;
          background: light-dark(white, black);
          color: light-dark(black, white);
        }
        </style>
        
        <script type="importmap">{"imports":{"@modelcontextprotocol/sdk/":"https://esm.sh/@modelcontextprotocol/sdk/dist/esm/","https://esm.sh/@modelcontextprotocol/sdk@^1.11.0/es2022/":"https://esm.sh/@modelcontextprotocol/sdk@^1.11.0/es2022/dist/esm/","https://esm.sh/@modelcontextprotocol/sdk@^1.11.0/client/index?target=es2022":"https://esm.sh/@modelcontextprotocol/sdk@^1.11.0/dist/esm/client/index?target=es2022","https://esm.sh/@modelcontextprotocol/sdk@^1.11.0/types?target=es2022":"https://esm.sh/@modelcontextprotocol/sdk@^1.11.0/dist/esm/types?target=es2022","@/index":"data:application/javascript;base64,","@":"data:application/javascript;base64,"}}</script>
        <script>
          window.APPLET_FILES = ["index.tsx","metadata.json","index.html"];
          </script>
        <script type="module">
        (() => {
  if (window.self === window.top) {
    // Do not run the shim in the main window, only in iframes.
    return;
  }

  window.API_KEY = 'GEMINI_API_KEY';
  window.GEMINI_API_KEY = 'GEMINI_API_KEY';
  window.process = window.process || {};
  window.process.env = window.process.env || {};
  window.process.env.API_KEY = window.API_KEY;
  window.process.env.GEMINI_API_KEY = window.GEMINI_API_KEY;

  const bootstrapChannel = new Promise((resolve) => {
    window.addEventListener('message', (event) => {
      if (event.origin !== 'https://aistudio.google.com') {
        return;
      }

      if (event.data.type === 'bootstrap') {
        resolve({
          port: event.ports[0],
          urlPatterns:
              event.data.urlPatterns.map((pattern) => new RegExp(pattern)),
        });
      }
    });
  });

  window.aistudio = window.aistudio || {
    handleFullscreenEsc: true,
    getHostUrl: async function() {
      const hostPort = (await bootstrapChannel).port;
      return new Promise((resolve) => {
        const channel = new MessageChannel();
        hostPort.postMessage(
            {type: 'get_host_url'},
            [channel.port2]);
        const port = channel.port1;
        port.onmessage = (message) => {
          resolve(message.data.url);
        };
      });
    },
    hasSelectedApiKey: async function() {
      const hostPort = (await bootstrapChannel).port;
      return new Promise((resolve) => {
        const channel = new MessageChannel();
        hostPort.postMessage(
            {type: 'has_selected_api_key'},
            [channel.port2]);
        const port = channel.port1;
        port.onmessage = (message) => {
          resolve(message.data);
        };
      });
    },
    openSelectKey: async function() {
      const hostPort = (await bootstrapChannel).port;
      const channel = new MessageChannel();
      hostPort.postMessage(
          {type: 'open_select_key'},
          [channel.port2]);
    },
    getModelQuota: async function(model) {
      const hostPort = (await bootstrapChannel).port;
      return new Promise((resolve) => {
        const channel = new MessageChannel();
        hostPort.postMessage(
            {type: 'get_model_quota', model},
            [channel.port2]);
        const port = channel.port1;
        port.onmessage = (message) => {
          resolve(message.data.modelQuota);
        };
      });
    },
  };

  const nativeFetch = window.fetch;

  /**
   * @param {string | URL | Request} resource The resource of the fetch request.
   * @param {RequestInit} options The options of the fetch request.
   * @return {Promise!} The promise of the fetch request.
   */
  async function fetch(resource, options) {
    const config = await bootstrapChannel;

    const request = resource instanceof Request ?
      resource.clone() :
      new Request(resource, options);

    if (!config.urlPatterns.some((pattern) => request.url.match(pattern))) {
      return nativeFetch(resource, options);
    }
    const hostPort = config.port;

    const channel = new MessageChannel();
    const port = channel.port1;
    let bodyBytes;
    const transfer = [channel.port2];
    const parts = [];
    const buffer = await request.arrayBuffer();
    if (buffer.byteLength) {
      bodyBytes = buffer;
      transfer.push(bodyBytes);
    }
    hostPort.postMessage(
        {
          type: 'fetch',
          url: request.url,
          method: request.method,
          headers: [...request.headers.entries()],
          body: bodyBytes,
        },
        transfer);

    let streamController;
    const body = new ReadableStream({
      start(controller) {
        streamController = controller;
      },
    });
    let resolveReceive;
    const receivePromise = new Promise((resolve) => {
      resolveReceive = resolve;
    });
    port.onmessage = (message) => {
      switch (message.data.type) {
        case 'response':
          resolveReceive(new Response(body, {
            status: message.data.status,
            statusText: message.data.statusText,
            headers: new Headers(message.data.headers),
          }));
          break;
        case 'body':
          streamController.enqueue(message.data.data);
          break;
        case 'body_done':
          streamController.close();
          break;
      }
    };
    return receivePromise;
  }

  Object.defineProperty(window, 'fetch', {
    get: function() {
      return fetch;
    },
  });

  // See details in: https://github.com/angular/angular/issues/63064.
  function patchHistoryStateFunctionForAngular(originalFn, baseHref) {
    return (state, unused, url) => {
      if (typeof url === 'string' && !url.startsWith('blob:')) {
        url = baseHref + url;
      }
      return originalFn.apply(window.history, [state, unused, url]);
    };
  }

  if (false) {
    const baseHref = window.location.href;
    window.history.replaceState = patchHistoryStateFunctionForAngular(window.history.replaceState, baseHref);
    window.history.pushState = patchHistoryStateFunctionForAngular(window.history.pushState, baseHref);
  }

  const originalWebSocket = window.WebSocket;
  class ProxiedWebSocket extends EventTarget {
    /**
     * @param {string} url The url of the websocket.
     * @param {Object!} protocols The protocols of the websocket.
     */
    constructor(url, protocols) {
      super();
      this.url = url;
      this.protocols = protocols;

      this.open();
    }

    /** Opens the websocket. */
    async open() {
      const hostPort = (await bootstrapChannel).port;
      const channel = new MessageChannel();
      hostPort.postMessage(
          {type: 'websocket_open', url: this.url, protocols: this.protocols},
          [channel.port2]);
      this.port = channel.port1;
      this.port.onmessage = (message) => {
        if (message.data.type === 'close') {
          const event = new CloseEvent('close', {
            code: message.data.code,
            reason: message.data.reason,
            wasClean: message.data.wasClean,
          });
          if (this.onclose) {
            this.onclose(event);
          }
          this.dispatchEvent(event);
          return;
        } else if (message.data.type === 'open') {
          const event = new Event('open');
          if (this.onopen) {
            this.onopen(event);
          }
          this.dispatchEvent(event);
          return;
        } else if (message.data.type === 'message') {
          let data = message.data.data;
          if (message.data.messageType === 'text' || message.data.messageType === 'message') {
            data = new TextDecoder().decode(data);
          }
          const event = new MessageEvent('message', {
            data,
            type: message.data.messageType,
          });
          if (this.onmessage) {
            this.onmessage(event);
          }
          this.dispatchEvent(event);
          return;
        } else if (message.data.type === 'error') {
          const event = new ErrorEvent('error', {
            message: message.data.message,
          });
          if (this.onerror) {
            this.onerror(event);
          }
          this.dispatchEvent(event);
          return;
        }
        console.error('received unknown message in frame', event.data);
      };
    }
    /**
     * @param {string|ArrayBuffer!} data The data to send.
     */
    send(data) {
      if (typeof data === 'string') {
        this.port.postMessage({type: 'send', data});
      } else {
        this.port.postMessage({type: 'send', data}, [data.buffer]);
      }
    }

    /**
     * @param {number} code The code of the close event.
     * @param {string} reason The reason of the close event.
     */
    close(code, reason) {
      this.port.postMessage({type: 'close', code, reason});
    }
  }

  /**
   * @param {string} url The url of the websocket.
   * @param {Object!} protocols The protocols of the websocket.
   * @return {WebSocket!} The websocket.
   */
  function createWebSocket(url, protocols) {
    // This should come from the bootstrap channel, but we want this to
    // work for the synchronous constructor here.
    if (url.startsWith('wss://generativelanguage.googleapis.com/')) {
      return Reflect.construct(ProxiedWebSocket, [url, protocols]);
    }
    return Reflect.construct(originalWebSocket, [url, protocols]);
  }

  Object.defineProperty(window, 'WebSocket', {
    get: function() {
      const fn = createWebSocket;
      Object.keys(originalWebSocket).forEach((key) => {
        Object.defineProperty(fn, key, {
          value: originalWebSocket[key],
        });
      });
      return fn;
    },
  });

  async function instrumentErrorReporting() {
    const errors = [];
    let hostPort;

    function reportError(message) {
      if (!hostPort) {
        errors.push(message);
      } else {
        hostPort.postMessage({type: 'error', message: message}, message);
      }
    }

    function serialize(args) {
      return args.map((a) => {
        if (a instanceof Error || a instanceof ErrorEvent) {
          return a.message;
        }
        if(a instanceof CloseEvent) {
          return {code: a.code, reason: a.reason, wasClean: a.wasClean};
        }
        if( a instanceof Map) {
          return JSON.parse(JSON.stringify([...a.entries()]));
        }
        if( a instanceof Set) {
          return JSON.parse(JSON.stringify([...a.values()]));
        }
        if (a instanceof Object) {
          return JSON.parse(JSON.stringify(a));
        }
        return a;
      });
    }

    const originalConsole = window.console;
    const originalConsoleLog = window.console.log;
    const originalConsoleError = window.console.error;
    const originalConsoleWarn = window.console.warn;
    const originalConsoleDebug = window.console.debug;
    window.console = {
      ...originalConsole,
      log: (message, ...args) => {
        originalConsoleLog.apply(window.console, [message, ...args]);
        const combined = serialize([message, ...args]);
        reportError({type: 'console_log', message: combined });
      },
      debug: (message, ...args) => {
        originalConsoleDebug.apply(window.console, [message, ...args]);
        const combined = serialize([message, ...args]);
        reportError({type: 'console_debug', message: combined });
      },
      error: (message, ...args) => {
        originalConsoleError.apply(window.console, [message, ...args]);
        const combined = serialize([message, ...args]);
        reportError({type: 'console_error', message: combined });
      },
      warn: (message, ...args) => {
        originalConsoleWarn.apply(window.console, [message, ...args]);
        const combined = serialize([message, ...args]);
        reportError({type: 'console_warn', message: combined });
      },
    };

    window.onerror = (message, source, lineno, colno, error) => {
      reportError({type: 'error', message: serialize([message]), source, lineno, colno, error});
    };

    window.onunhandledrejection = (event) => {
      reportError({type: 'unhandledrejection', message: serialize([event.reason])});
    };

    window.alert = (message) => {
      reportError({type: 'alert', message: serialize([message]) });
    };

    hostPort = (await bootstrapChannel).port;
    for(const error of errors) {
      hostPort.postMessage({type: 'error', message: error});
    }
  }

  const availableFiles = new Set(window.APPLET_FILES || []);

  instrumentErrorReporting();

  if (false) {
    const notifyLocationChange = async () => {
      const hostPort = (await bootstrapChannel).port;
      hostPort.postMessage({type: 'locationchange', href: location.href});
    };

    // Send initial state on load.
    notifyLocationChange();

    const originalPushState = history.pushState;
    history.pushState = (...args) => {
      originalPushState.apply(history, args);
      notifyLocationChange();
    };

    const originalReplaceState = history.replaceState;
    history.replaceState = (...args) => {
      originalReplaceState.apply(history, args);
      notifyLocationChange();
    };
    window.addEventListener('popstate', (e) => {
      notifyLocationChange();
    });
  }

  window.addEventListener('hashchange', async (e) =>{
    const config = await bootstrapChannel;
    const hostPort = config.port;
    hostPort.postMessage({type: 'hashchange', hash: window.location.hash});
    if (false) {
      hostPort.postMessage({
        type: 'locationchange',
        href: location.href,
      });
    }
  });

  if (true) {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/html2canvas-pro';
    script.onload = () => {
      window.addEventListener('message', async (event) => {
        if (event.data?.type === 'capture-screenshot') {
          try {
            const canvas = await html2canvas(document.documentElement, {
              logging: false,
              useCORS: true,
              backgroundColor: null,
              scale: 1,
            });
            const hostPort = (await bootstrapChannel).port;
            hostPort.postMessage(
              {
                type: 'screenshot-result',
                dataUrl: canvas.toDataURL('image/png'),
                requestId: event.data.requestId,
                scrollX: document.body.scrollLeft,
                scrollY: document.body.scrollTop,
              },
            );
          } catch (e) {
            const hostPort = (await bootstrapChannel).port;
            hostPort.postMessage(
              {
                type: 'screenshot-error',
                error: e.message,
                requestId: event.data.requestId,
              });
          }
        }
      });
    };
    document.head.appendChild(script);
  }

  if (false) {
    const MAX_ANCESTOR_LEVEL = 3;
    const MAX_DESCENDANT_LEVEL = 3;

    function getElementSelector(el) {
      if (!el || el.nodeType !== 1) {
        return '';
      }
      const parts = [];
      while(el && el.nodeType === 1 && el.tagName.toLowerCase() !== 'body') {
        let part = el.tagName.toLowerCase();
        if (el.id) {
          part += '#' + CSS.escape(el.id);
        }

        const parent = el.parentElement;
        if (parent) {
          let nth = 1;
          let prev = el.previousElementSibling;
          while(prev) {
            if (prev.tagName === el.tagName) {
              nth++;
            }
            prev = prev.previousElementSibling;
          }
          part += ':nth-of-type(' + nth + ')';
        }

        parts.unshift(part);
        el = el.parentElement;
      }
      return parts.join(' > ');
    }

    function getDomTreeAsString(element, depth, maxDepth) {
      if (!element || element.nodeType !== 1 || depth > maxDepth) {
        return '';
      }
      const tagName = element.tagName.toLowerCase();
      let attrs = [];
      if (element.id) {
        attrs.push('id="' + element.id + '"');
      }
      if (element.classList.length > 0) {
        attrs.push('class="' + element.classList.value + '"');
      }
      const attrString = attrs.length > 0 ? ' ' + attrs.join(' ') : '';

      let content = '';
      for (const node of element.childNodes) {
        if (node.nodeType === 1) { // Element node
          content += getDomTreeAsString(node, depth + 1, maxDepth);
        } else if (node.nodeType === 3) { // Text node
          content += node.textContent;
        }
      }

      return '<' + tagName + attrString + '>' + content + '</' + tagName + '>';
    }

    function getElementInfo(element) {
      const selector = getElementSelector(element);
      let levelsUp = 0;
      let root = element;
      while(levelsUp < MAX_ANCESTOR_LEVEL && root.parentElement && root.parentElement.tagName.toLowerCase() !== 'html') {
        root = root.parentElement;
        levelsUp++;
      }
      const domString = getDomTreeAsString(root, 0, levelsUp + MAX_DESCENDANT_LEVEL);
      const styles = window.getComputedStyle(element);
      const css = {};
      for (let i = 0; i < styles.length; i++) {
        const key = styles[i];
        css[key] = styles.getPropertyValue(key);
      }
      return { selector, domString, css };
    }

    const style = document.createElement('style');
    style.textContent =
    '.aistudio-hover-highlight { box-shadow: inset 0 0 0 0.5px white, inset 0 0 0 1.5px rgba(128,128,128,0.6) !important; }' +
    '.aistudio-active-highlight { box-shadow: inset 0 0 0 0.5px white, inset 0 0 0 1.5px #87a9ff !important; }' +
    '#aistudio-focus-mode-tag { position: absolute; display: none; background: #87a9ff; border-radius: 4px; border: 0.5px solid white; z-index: 10000; text-transform: lowercase; padding: 2px 4px; color: #32302c; font-family: Inter, sans-serif; font-size: 12px; font-style: normal; font-weight: 400; line-height: 16px; pointer-events: none; }' +
    '#aistudio-hover-mode-tag { position: absolute; display: none; background: rgba(128,128,128,0.6); border-radius: 4px; border: 0.5px solid white; z-index: 10000; text-transform: lowercase; padding: 2px 4px; color: white; font-family: Inter, sans-serif; font-size: 12px; font-style: normal; font-weight: 400; line-height: 16px; pointer-events: none; }';
    document.head.appendChild(style);

    let hoveredElement = null;
    let activeElement = null;
    let focusTag = null;
    let hoverTag = null;
    let resizeObserver = null;
    let iframeLoaded = false;
    let designModeEnabled = false;
    let designModeStyle = null;
    let designModeOverlay = null;

    function ensureFocusTag() {
      if (!focusTag) {
        focusTag = document.createElement('div');
        focusTag.id = 'aistudio-focus-mode-tag';
        document.body.appendChild(focusTag);
      }
    }

    function cleanupActiveElement() {
      if (!activeElement) return;
      activeElement.classList.remove('aistudio-active-highlight');
      activeElement.removeAttribute('data-aistudio-tag-name');
      if (resizeObserver) {
        resizeObserver.unobserve(activeElement);
      }
      window.removeEventListener('resize', positionFocusTag);
      window.removeEventListener('scroll', positionFocusTag, true);
    }

    function positionFocusTag() {
      requestAnimationFrame(() => {
        if (!activeElement || !focusTag) return;
        focusTag.style.display = 'inline-flex';
        const rect = activeElement.getBoundingClientRect();
        focusTag.style.top = (rect.top + window.scrollY - focusTag.offsetHeight - 5) + 'px';
        focusTag.style.left = (rect.left + window.scrollX) + 'px';
      });
    }

    function positionHoverTag() {
      if (!hoveredElement || !hoverTag || hoveredElement === activeElement) {
        if (hoverTag) hoverTag.style.display = 'none';
        return;
      }
      requestAnimationFrame(() => {
        hoverTag.style.display = 'inline-flex';
        const rect = hoveredElement.getBoundingClientRect();
        hoverTag.style.top = (rect.top + window.scrollY - hoverTag.offsetHeight - 5) + 'px';
        hoverTag.style.left = (rect.left + window.scrollX) + 'px';
      });
    }

    if (window.ResizeObserver) {
      resizeObserver = new ResizeObserver(() => {
        positionFocusTag();
      });
    }

    function setHoveredElement(element) {
      if (!designModeEnabled || !iframeLoaded) return;

      if (!hoverTag) {
        hoverTag = document.createElement('div');
        hoverTag.id = 'aistudio-hover-mode-tag';
        document.body.appendChild(hoverTag);
      }

      if (hoveredElement && hoveredElement !== activeElement) {
        hoveredElement.classList.remove('aistudio-hover-highlight');
      }
      hoverTag.style.display = 'none';

      hoveredElement = element;

      if (hoveredElement && hoveredElement !== activeElement) {
        hoveredElement.classList.add('aistudio-hover-highlight');
        hoverTag.textContent = hoveredElement.tagName.toLowerCase();
        positionHoverTag();
      }
    }

    async function setActiveElement(element) {
      if (!designModeEnabled || !iframeLoaded) return;

      ensureFocusTag();
      cleanupActiveElement();
      focusTag.style.display = 'none';

      // Clear hover from new active element if it was hovered
      if (element) {
        element.classList.remove('aistudio-hover-highlight');
      }

      activeElement = element;

      if (activeElement) {
        activeElement.setAttribute('data-aistudio-tag-name', activeElement.tagName);
        activeElement.classList.add('aistudio-active-highlight');
        focusTag.textContent = activeElement.tagName.toLowerCase();
        positionFocusTag();
        if (resizeObserver) {
          resizeObserver.observe(activeElement);
        }
        window.addEventListener('resize', positionFocusTag);
        window.addEventListener('scroll', positionFocusTag, true);

        // Notify host about selected element
        const info = getElementInfo(activeElement);
        window.parent.postMessage({
          type: 'element-selected',
          element: info,
        }, '*');
      }
    }

    function getElementAtPoint(x, y) {
      const elements = document.elementsFromPoint(x, y);
      for (const el of elements) {
        if (el.id === 'aistudio-focus-mode-tag' ||
            el.id === 'aistudio-hover-mode-tag' ||
            el.id === 'aistudio-design-mode-overlay') {
          continue;
        }
        return el;
      }
      return null;
    }

    function onMouseMove(e) {
      if (!designModeEnabled) return;
      const element = getElementAtPoint(e.clientX, e.clientY);
      setHoveredElement(element);
    }

    function onClick(e) {
      if (!designModeEnabled) return;
      e.preventDefault();
      e.stopPropagation();
      const element = getElementAtPoint(e.clientX, e.clientY);
      if (element && element !== document.body) {
        setActiveElement(element);
      }
    }

    function onKeyDown(e) {
      if (!designModeEnabled) return;
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        e.stopPropagation();
        const element = document.activeElement;
        if (element && element !== document.body) {
          setActiveElement(element);
        }
      }
    }

    function enableDesignMode() {
      if (designModeEnabled) return;
      designModeEnabled = true;
      designModeStyle = document.createElement('style');
      designModeStyle.textContent =
        'button:disabled, input:disabled, select:disabled, textarea:disabled, ' +
        '[disabled], [aria-disabled="true"] { pointer-events: auto !important; }';
      document.head.appendChild(designModeStyle);
      designModeOverlay = document.createElement('div');
      designModeOverlay.id = 'aistudio-design-mode-overlay';
      designModeOverlay.style.cssText =
        'position: fixed; top: 0; left: 0; width: 100%; height: 100%; ' +
        'z-index: 9999; cursor: default; background: transparent;';
      designModeOverlay.addEventListener('mousemove', onMouseMove);
      designModeOverlay.addEventListener('mousedown', onClick);
      designModeOverlay.addEventListener('keydown', onKeyDown);
      document.body.appendChild(designModeOverlay);
    }

    function disableDesignMode() {
      if (!designModeEnabled) return;
      if (designModeOverlay) {
        designModeOverlay.removeEventListener('mousemove', onMouseMove);
        designModeOverlay.removeEventListener('mousedown', onClick);
        designModeOverlay.removeEventListener('keydown', onKeyDown);
        designModeOverlay.remove();
        designModeOverlay = null;
      }
      setHoveredElement(null);
      clearActiveElement();
      if (designModeStyle) {
        designModeStyle.remove();
        designModeStyle = null;
      }
      designModeEnabled = false;
    }

    function clearActiveElement() {
      ensureFocusTag();
      cleanupActiveElement();
      focusTag.style.display = 'none';
      activeElement = null;
    }

    window.addEventListener('load', () => {
      iframeLoaded = true;
    });

    window.addEventListener('message', async (event) => {
      if (event.data?.type === 'set-design-mode') {
        if (event.data.enabled) {
          enableDesignMode();
        } else {
          disableDesignMode();
        }
      } else if (event.data?.type === 'highlight-element-by-selector') {
        try {
          const selector = event.data.selector;
          if (selector) {
            const element = document.querySelector(selector);
            setActiveElement(element);
          } else {
            setActiveElement(null);
          }
        } catch (e) {
          setActiveElement(null);
        }
      } else if (event.data?.type === 'change-element-style') {
        try {
          const selector = event.data.selector;
          if (selector) {
            const element = document.querySelector(selector);
            if (element) {
              element.style.setProperty(
                event.data.property,
                event.data.value,
                'important',
              );
              positionFocusTag();
            }
          }
        } catch (e) {}
      }
    });
  }

  window.addEventListener('keydown', async (event) => {
    if (event.key === 'Escape' && window.aistudio?.handleFullscreenEsc) {
      const hostPort = (await bootstrapChannel).port;
      hostPort.postMessage({type: 'exit-fullscreen'});
    }
  });
})();
// # sourceURL=iframe_shim.js
        </script>
        <style>
        @import url(https://fonts.googleapis.com/css?family=Google+Sans+Text);
        html {
          font-family: 'Google Sans Text', 'Google Sans';
          font-size: 14px;
          color-scheme: light dark;
          background: light-dark(white, black);
          color: light-dark(black, white);
        }
        </style>
        
                <script>
          window.APPLET_FILES = ["index.tsx","metadata.json","index.html"];
          </script>
        <script type="module">
        (() => {
  if (window.self === window.top) {
    return;
  }
  window.API_KEY = 'GEMINI_API_KEY';
  window.GEMINI_API_KEY = 'GEMINI_API_KEY';
  window.process = window.process || {};
  window.process.env = window.process.env || {};
  window.process.env.API_KEY = window.API_KEY;
  window.process.env.GEMINI_API_KEY = window.GEMINI_API_KEY;

  const bootstrapChannel = new Promise((resolve) => {
    window.addEventListener('message', (event) => {
      if (event.origin !== 'https://aistudio.google.com') return;
      if (event.data.type === 'bootstrap') {
        resolve({
          port: event.ports[0],
          urlPatterns: event.data.urlPatterns.map((pattern) => new RegExp(pattern)),
        });
      }
    });
  });

  const nativeFetch = window.fetch;
  async function fetch(resource, options) {
    const config = await bootstrapChannel;
    const request = resource instanceof Request ? resource.clone() : new Request(resource, options);
    if (!config.urlPatterns.some((pattern) => request.url.match(pattern))) {
      return nativeFetch(resource, options);
    }
    const hostPort = config.port;
    const channel = new MessageChannel();
    const port = channel.port1;
    let bodyBytes;
    const transfer = [channel.port2];
    const buffer = await request.arrayBuffer();
    if (buffer.byteLength) {
      bodyBytes = buffer;
      transfer.push(bodyBytes);
    }
    hostPort.postMessage({
          type: 'fetch',
          url: request.url,
          method: request.method,
          headers: [...request.headers.entries()],
          body: bodyBytes,
        }, transfer);

    let streamController;
    const body = new ReadableStream({
      start(controller) { streamController = controller; },
    });
    let resolveReceive;
    const receivePromise = new Promise((resolve) => { resolveReceive = resolve; });
    port.onmessage = (message) => {
      switch (message.data.type) {
        case 'response':
          resolveReceive(new Response(body, {
            status: message.data.status,
            statusText: message.data.statusText,
            headers: new Headers(message.data.headers),
          }));
          break;
        case 'body': streamController.enqueue(message.data.data); break;
        case 'body_done': streamController.close(); break;
      }
    };
    return receivePromise;
  }
  Object.defineProperty(window, 'fetch', { get: function() { return fetch; } });
})();
</script>
        <base href="https://ai.studio">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <title>SAHU 1 Agents - AI Multi-Expert System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/docx@8.2.0/build/index.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root { --bg-primary: #ffffff; --bg-secondary: #f8f8f8; --bg-tertiary: #efefef; --text-primary: #1a1a1a; --text-secondary: #525252; --accent: #667eea; --accent-hover: #5a6fd6; --border: #e0e0e0; }
        .dark-mode { --bg-primary: #0a0a0a; --bg-secondary: #141414; --bg-tertiary: #1e1e1e; --text-primary: #e5e5e5; --text-secondary: #a3a3a3; --accent: #667eea; --accent-hover: #7c8ff0; --border: #2a2a2a; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { background-color: var(--bg-primary); color: var(--text-primary); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; }
        .sidebar { background-color: var(--bg-secondary); border-color: var(--border); }
        .message-user { background: linear-gradient(135deg, var(--accent) 0%, #764ba2 100%); }
        .message-assistant { background-color: var(--bg-tertiary); }
        .input-area { background-color: var(--bg-secondary); border-color: var(--border); }
        .expert-card { background-color: var(--bg-tertiary); border: 1px solid var(--border); transition: all 0.3s ease; }
        .expert-card.thinking { border-color: #f59e0b; box-shadow: 0 0 15px rgba(245, 158, 11, 0.15); }
        .expert-card.complete { border-color: #22c55e; }
        .expert-card.error { border-color: #ef4444; }
        .expert-card.unsafe { border-color: #ef4444; background-color: rgba(239, 68, 68, 0.05); }
        .typing-indicator span { animation: typing 1.4s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); opacity: 0.5; } 30% { transform: translateY(-6px); opacity: 1; } }
        .scrollbar-thin::-webkit-scrollbar { width: 5px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: var(--bg-secondary); }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        pre code { display: block; padding: 12px; background: #1a1a1a; border-radius: 8px; overflow-x: auto; font-family: 'SF Mono', Monaco, monospace; font-size: 12px; line-height: 1.5; color: #e5e5e5; }
        .thinking-block { background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 12px; font-size: 13px; display: none; }
        .deepthink-active .thinking-block { display: block; }
        .thinking-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: #d97706; font-weight: 600; font-size: 12px; }
        .aggregator-response { background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(102, 126, 234, 0.1) 100%); border: 2px solid var(--accent); }
        .stage-1 { border-color: #f59e0b; background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(245, 158, 11, 0.1) 100%); }
        .stage-2 { border-color: #06b6d4; background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(6, 182, 212, 0.1) 100%); }
        .stage-3 { border-color: #22c55e; background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(34, 197, 94, 0.1) 100%); }
        .file-preview { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-top: 12px; }
        .export-buttons { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 10px; }
        .export-btn { padding: 8px 14px; border-radius: 8px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); min-height: 40px; }
        .export-btn:hover { background: var(--accent); color: white; border-color: var(--accent); }
        .export-btn.sparkle-btn { background: linear-gradient(135deg, rgba(236, 72, 153, 0.15), rgba(168, 85, 247, 0.15)); border-color: rgba(236, 72, 153, 0.3); color: #db2777; }
        .export-btn.sparkle-btn:hover { background: linear-gradient(135deg, #ec4899, #8b5cf6); color: white; border-color: transparent; }
        .toast { animation: slideIn 0.3s ease-out; position: fixed; bottom: 80px; right: 16px; z-index: 1000; padding: 12px 20px; border-radius: 10px; color: white; display: flex; align-items: center; gap: 10px; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .provider-badge { font-size: 10px; padding: 3px 8px; border-radius: 6px; font-weight: 600; margin-bottom: 4px; display: inline-block; }
        .provider-huggingface { background: rgba(255, 213, 0, 0.2); color: #ca8a04; }
        .provider-openrouter { background: rgba(168, 85, 247, 0.2); color: #9333ea; }
        .provider-groq { background: rgba(249, 115, 22, 0.2); color: #ea580c; }
        .provider-together { background: rgba(34, 197, 94, 0.2); color: #16a34a; }
        .provider-cerebras { background: rgba(99, 102, 241, 0.2); color: #6366f1; }
        .provider-sambanova { background: rgba(14, 165, 233, 0.2); color: #0284c7; }
        .provider-fireworks { background: rgba(239, 68, 68, 0.2); color: #dc2626; }
        .provider-routeway { background: rgba(16, 185, 129, 0.2); color: #059669; }
        .provider-mistral { background: rgba(251, 146, 60, 0.2); color: #ea580c; }
        .provider-gemini { background: rgba(59, 130, 246, 0.2); color: #2563eb; }
        .provider-longcat { background: rgba(139, 92, 246, 0.2); color: #7c3aed; }
        .provider-ollama { background: rgba(75, 85, 99, 0.2); color: #374151; }
        .provider-zenmusk { background: rgba(236, 72, 153, 0.2); color: #be185d; }
        .provider-ionet { background: rgba(6, 182, 212, 0.2); color: #0891b2; }
        .provider-nvidia { background: rgba(118, 185, 0, 0.2); color: #76b900; }
        .stage-btn { padding: 4px 10px; font-size: 11px; border-radius: 6px; cursor: pointer; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-secondary); transition: all 0.2s; min-width: 32px; text-align: center; }
        .stage-btn:hover { border-color: var(--accent); }
        .stage-btn.active-1 { background: #f59e0b; color: white; border-color: #f59e0b; }
        .stage-btn.active-2 { background: #06b6d4; color: white; border-color: #06b6d4; }
        .stage-btn.active-3 { background: #22c55e; color: white; border-color: #22c55e; }
        .fallback-indicator { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: rgba(249, 115, 22, 0.2); color: #ea580c; }
        .model-card { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.2s; background: var(--bg-secondary); }
        .model-card:hover { border-color: var(--accent); }
        .model-card.selected { border-color: var(--accent); background: rgba(102, 126, 234, 0.1); }
        .sidebar { position: fixed; left: -100%; top: 0; bottom: 0; z-index: 100; width: 85%; max-width: 300px; transition: left 0.3s ease; overflow-y: auto; }
        .sidebar.open { left: 0; }
        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; }
        .sidebar-overlay.show { display: block; }
        .blur-content { filter: blur(5px); user-select: none; pointer-events: none; }
        .safety-overlay { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.8); z-index: 10; border-radius: inherit; }
        .dark-mode .safety-overlay { background: rgba(0, 0, 0, 0.8); }
        @media (min-width: 768px) { .sidebar { position: relative; left: 0; width: 280px; } .sidebar-overlay { display: none !important; } }
        @media (max-width: 480px) { .export-btn span { display: none; } .export-btn { padding: 10px 12px; } }
    </style>
<style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.fixed{position:fixed}.relative{position:relative}.inset-0{inset:0px}.z-50{z-index:50}.mx-auto{margin-left:auto;margin-right:auto}.mb-2{margin-bottom:0.5rem}.mb-3{margin-bottom:0.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mr-1{margin-right:0.25rem}.mr-2{margin-right:0.5rem}.mt-2{margin-top:0.5rem}.block{display:block}.flex{display:flex}.grid{display:grid}.hidden{display:none}.h-10{height:2.5rem}.h-14{height:3.5rem}.h-16{height:4rem}.h-2{height:0.5rem}.h-5{height:1.25rem}.h-full{height:100%}.h-screen{height:100vh}.h-4{height:1rem}.max-h-32{max-height:8rem}.max-h-\[85vh\]{max-height:85vh}.w-10{width:2.5rem}.w-16{width:4rem}.w-2{width:0.5rem}.w-5{width:1.25rem}.w-full{width:100%}.w-4{width:1rem}.min-w-0{min-width:0px}.max-w-3xl{max-width:48rem}.max-w-4xl{max-width:56rem}.max-w-lg{max-width:32rem}.max-w-md{max-width:28rem}.flex-1{flex:1 1 0%}@keyframes pulse{50%{opacity:.5}}.animate-pulse{animation:pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite}.cursor-pointer{cursor:pointer}.resize-none{resize:none}.grid-cols-1{grid-template-columns:repeat(1, minmax(0, 1fr))}.grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-end{align-items:flex-end}.items-center{align-items:center}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-2{gap:0.5rem}.gap-3{gap:0.75rem}.space-y-1 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.25rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.25rem * var(--tw-space-y-reverse))}.space-y-2 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.5rem * var(--tw-space-y-reverse))}.space-y-3 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.75rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.75rem * var(--tw-space-y-reverse))}.space-y-4 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.overflow-hidden{overflow:hidden}.overflow-y-auto{overflow-y:auto}.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.rounded-2xl{border-radius:1rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:0.5rem}.rounded-xl{border-radius:0.75rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-r{border-right-width:1px}.border-t{border-top-width:1px}.border-\[var\(--border\)\]{border-color:var(--border)}.bg-\[var\(--accent\)\]{background-color:var(--accent)}.bg-\[var\(--bg-secondary\)\]{background-color:var(--bg-secondary)}.bg-\[var\(--bg-tertiary\)\]{background-color:var(--bg-tertiary)}.bg-black\/60{background-color:rgb(0 0 0 / 0.6)}.bg-green-500{--tw-bg-opacity:1;background-color:rgb(34 197 94 / var(--tw-bg-opacity, 1))}.bg-transparent{background-color:transparent}.bg-yellow-50{--tw-bg-opacity:1;background-color:rgb(254 252 232 / var(--tw-bg-opacity, 1))}.bg-gradient-to-br{background-image:linear-gradient(to bottom right, var(--tw-gradient-stops))}.bg-gradient-to-r{background-image:linear-gradient(to right, var(--tw-gradient-stops))}.from-\[\#667eea\]{--tw-gradient-from:#667eea var(--tw-gradient-from-position);--tw-gradient-to:rgb(102 126 234 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.to-\[\#764ba2\]{--tw-gradient-to:#764ba2 var(--tw-gradient-to-position)}.p-2{padding:0.5rem}.p-3{padding:0.75rem}.p-4{padding:1rem}.px-2{padding-left:0.5rem;padding-right:0.5rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.px-4{padding-left:1rem;padding-right:1rem}.px-5{padding-left:1.25rem;padding-right:1.25rem}.py-0\.5{padding-top:0.125rem;padding-bottom:0.125rem}.py-1\.5{padding-top:0.375rem;padding-bottom:0.375rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.py-2\.5{padding-top:0.625rem;padding-bottom:0.625rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.pb-2{padding-bottom:0.5rem}.pb-3{padding-bottom:0.75rem}.text-left{text-align:left}.text-center{text-align:center}.font-mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}.text-2xl{font-size:1.5rem;line-height:2rem}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:0.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-semibold{font-weight:600}.leading-relaxed{line-height:1.625}.text-\[\#667eea\]{--tw-text-opacity:1;color:rgb(102 126 234 / var(--tw-text-opacity, 1))}.text-\[var\(--accent\)\]{color:var(--accent)}.text-\[var\(--text-secondary\)\]{color:var(--text-secondary)}.text-blue-500{--tw-text-opacity:1;color:rgb(59 130 246 / var(--tw-text-opacity, 1))}.text-green-500{--tw-text-opacity:1;color:rgb(34 197 94 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.text-yellow-500{--tw-text-opacity:1;color:rgb(234 179 8 / var(--tw-text-opacity, 1))}.text-yellow-700{--tw-text-opacity:1;color:rgb(161 98 7 / var(--tw-text-opacity, 1))}.accent-\[var\(--accent\)\]{accent-color:var(--accent)}.shadow-2xl{--tw-shadow:0 25px 50px -12px rgb(0 0 0 / 0.25);--tw-shadow-colored:0 25px 50px -12px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-xl{--tw-shadow:0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.outline-none{outline:2px solid transparent;outline-offset:2px}.ring-2{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000)}.ring-\[var\(--accent\)\]{--tw-ring-color:var(--accent)}.backdrop-blur-sm{--tw-backdrop-blur:blur(4px);-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-colors{transition-property:color, background-color, border-color, fill, stroke, -webkit-text-decoration-color;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, -webkit-text-decoration-color;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-transform{transition-property:transform;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.hover\:bg-\[var\(--accent-hover\)\]:hover{background-color:var(--accent-hover)}.hover\:bg-\[var\(--bg-tertiary\)\]:hover{background-color:var(--bg-tertiary)}.hover\:bg-\[var\(--border\)\]:hover{background-color:var(--border)}.focus\:border-\[var\(--accent\)\]:focus{border-color:var(--accent)}.focus\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}.active\:scale-95:active{--tw-scale-x:.95;--tw-scale-y:.95;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.disabled\:opacity-50:disabled{opacity:0.5}@media (prefers-color-scheme: dark){.dark\:bg-yellow-900\/30{background-color:rgb(113 63 18 / 0.3)}.dark\:text-yellow-300{--tw-text-opacity:1;color:rgb(253 224 71 / var(--tw-text-opacity, 1))}}</style><script src="https://cdn.jsdelivr.net/npm/html2canvas-pro"></script></head>
<body class="h-screen overflow-hidden">
    <div id="sidebarOverlay" class="sidebar-overlay show" onclick="toggleSidebar()"></div>
    
    <div id="app" class="flex h-full">
        <aside id="sidebar" class="sidebar flex flex-col border-r border-[var(--border)] open">
            <div class="p-4 border-b border-[var(--border)]">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-[#667eea] to-[#764ba2] flex items-center justify-center shadow-lg">
                        <i class="fas fa-robot text-white"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg gradient-text">SAHU 1 Agents</h1>
                        <p class="text-xs text-[var(--text-secondary)]">Multi-Provider MoE</p>
                    </div>
                </div>
            </div>

            <div class="p-3">
                <button onclick="newChat()" class="w-full py-3 px-4 rounded-xl bg-gradient-to-r from-[#667eea] to-[#764ba2] text-white font-semibold flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-transform">
                    <i class="fas fa-plus"></i>
                    New Chat
                </button>
            </div>

            <div class="px-3 pb-2">
                <label class="text-xs text-[var(--text-secondary)] mb-2 block font-medium">Active Providers</label>
                <div id="providerCheckboxes" class="grid grid-cols-2 gap-2">
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors ring-2 ring-[var(--accent)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleProvider('huggingface', this.checked)" __gchrome_uniqueid="1">
                    <span class="text-xs truncate">HuggingFace</span>
                </label>
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors ">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" onchange="toggleProvider('openrouter', this.checked)" __gchrome_uniqueid="2">
                    <span class="text-xs truncate">OpenRouter</span>
                </label>
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors ">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" onchange="toggleProvider('groq', this.checked)" __gchrome_uniqueid="3">
                    <span class="text-xs truncate">Groq</span>
                </label>
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors ">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" onchange="toggleProvider('together', this.checked)" __gchrome_uniqueid="4">
                    <span class="text-xs truncate">Together AI</span>
                </label>
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors ">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" onchange="toggleProvider('cerebras', this.checked)" __gchrome_uniqueid="5">
                    <span class="text-xs truncate">Cerebras</span>
                </label>
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors ">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" onchange="toggleProvider('sambanova', this.checked)" __gchrome_uniqueid="6">
                    <span class="text-xs truncate">SambaNova</span>
                </label>
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors ">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" onchange="toggleProvider('fireworks', this.checked)" __gchrome_uniqueid="7">
                    <span class="text-xs truncate">Fireworks AI</span>
                </label>
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors ">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" onchange="toggleProvider('routeway', this.checked)" __gchrome_uniqueid="8">
                    <span class="text-xs truncate">Routeway</span>
                </label>
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors ">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" onchange="toggleProvider('mistral', this.checked)" __gchrome_uniqueid="9">
                    <span class="text-xs truncate">Mistral</span>
                </label>
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors ">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" onchange="toggleProvider('gemini', this.checked)" __gchrome_uniqueid="10">
                    <span class="text-xs truncate">Gemini</span>
                </label>
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors ">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" onchange="toggleProvider('longcat', this.checked)" __gchrome_uniqueid="11">
                    <span class="text-xs truncate">LongCat</span>
                </label>
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors ">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" onchange="toggleProvider('ollama', this.checked)" __gchrome_uniqueid="12">
                    <span class="text-xs truncate">Ollama Cloud</span>
                </label>
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors ">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" onchange="toggleProvider('zenmusk', this.checked)" __gchrome_uniqueid="13">
                    <span class="text-xs truncate">ZenMusk</span>
                </label>
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors ">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" onchange="toggleProvider('ionet', this.checked)" __gchrome_uniqueid="14">
                    <span class="text-xs truncate">io.net</span>
                </label>
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors ">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" onchange="toggleProvider('nvidia', this.checked)" __gchrome_uniqueid="15">
                    <span class="text-xs truncate">Nvidia</span>
                </label></div>
            </div>

            <div class="px-3 pb-3">
                <button onclick="openModelSelector()" class="w-full py-3 px-4 rounded-xl bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm flex items-center justify-between active:scale-95 transition-transform">
                    <span class="flex items-center gap-2">
                        <i class="fas fa-cubes text-[var(--accent)]"></i>
                        Configure Models
                    </span>
                    <span id="selectedModelCount" class="text-xs bg-[var(--accent)] text-white px-2 py-0.5 rounded-full">0</span>
                </button>
            </div>

            <div class="px-3 pb-3 space-y-2">
                <label class="flex items-center justify-between p-3 bg-[var(--bg-tertiary)] rounded-xl cursor-pointer">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-shield-alt text-green-500"></i>
                        <span class="text-sm">Auto Fallback</span>
                    </div>
                    <input type="checkbox" id="autoFallback" checked="" class="w-5 h-5 accent-[var(--accent)]" onchange="saveAutoFallback()" __gchrome_uniqueid="16">
                </label>

                <label class="flex items-center justify-between p-3 bg-[var(--bg-tertiary)] rounded-xl cursor-pointer">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-user-shield text-blue-500"></i>
                        <span class="text-sm">Shield Gemma Safety</span>
                    </div>
                    <input type="checkbox" id="shieldGemmaCheck" class="w-5 h-5 accent-[var(--accent)]" onchange="saveShieldGemma()" __gchrome_uniqueid="17">
                </label>
            </div>

            <div class="flex-1 overflow-y-auto scrollbar-thin px-3">
                <p class="text-xs text-[var(--text-secondary)] mb-2 font-medium">Recent Chats</p>
                <div id="chatHistory" class="space-y-1"></div>
            </div>

            <div class="p-3 border-t border-[var(--border)] space-y-1">
                <button onclick="openSettings()" class="w-full py-3 px-4 rounded-xl hover:bg-[var(--bg-tertiary)] flex items-center gap-3 transition-colors active:scale-95">
                    <i class="fas fa-cog text-[var(--text-secondary)]"></i>
                    <span class="text-sm">Settings</span>
                </button>
                <button onclick="openSourceCode()" class="w-full py-3 px-4 rounded-xl hover:bg-[var(--bg-tertiary)] flex items-center gap-3 transition-colors active:scale-95">
                    <i class="fas fa-code text-[var(--text-secondary)]"></i>
                    <span class="text-sm">View Code</span>
                </button>
                <button onclick="toggleTheme()" class="w-full py-3 px-4 rounded-xl hover:bg-[var(--bg-tertiary)] flex items-center gap-3 transition-colors active:scale-95">
                    <i id="themeIcon" class="fas fa-moon text-[var(--text-secondary)]"></i>
                    <span class="text-sm" id="themeText">Dark Mode</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full min-w-0">
            <header class="h-14 border-b border-[var(--border)] flex items-center justify-between px-4 bg-[var(--bg-secondary)]">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="p-2 rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors active:scale-95">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-robot text-[var(--accent)]"></i>
                        <span class="font-semibold text-sm">SAHU 1 Agents</span>
                    </div>
                </div>
                
                <div id="connectionStatus" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-[var(--bg-tertiary)]">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span class="text-xs">Ready</span>
                </div>
            </header>

            <div id="chatArea" class="flex-1 overflow-y-auto scrollbar-thin p-4">
                <div id="welcomeScreen" class="h-full flex flex-col items-center justify-center px-4">
                    <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-[#667eea] to-[#764ba2] flex items-center justify-center mb-6 shadow-xl">
                        <i class="fas fa-robot text-2xl text-white"></i>
                    </div>
                    <h2 class="text-xl font-bold mb-2 gradient-text text-center">SAHU 1 Agents</h2>
                    <p class="text-[var(--text-secondary)] mb-4 text-center text-sm max-w-md">
                        Multi-provider AI with <strong>auto fallback</strong> and <strong>3-stage aggregation</strong>
                    </p>
                    <div class="flex flex-wrap justify-center gap-2 mb-6">
                        <span class="provider-badge provider-huggingface">HuggingFace</span>
                        <span class="provider-badge provider-openrouter">OpenRouter</span>
                        <span class="provider-badge provider-groq">Groq</span>
                        <span class="provider-badge provider-together">Together</span>
                        <span class="provider-badge provider-cerebras">Cerebras</span>
                        <span class="provider-badge provider-sambanova">SambaNova</span>
                        <span class="provider-badge provider-fireworks">Fireworks</span>
                        <span class="provider-badge provider-routeway">Routeway</span>
                        <span class="provider-badge provider-mistral">Mistral</span>
                        <span class="provider-badge provider-gemini">Gemini</span>
                        <span class="provider-badge provider-longcat">LongCat</span>
                        <span class="provider-badge provider-ollama">Ollama Cloud</span>
                        <span class="provider-badge provider-zenmusk">ZenMusk</span>
                        <span class="provider-badge provider-ionet">io.net</span>
                        <span class="provider-badge provider-nvidia">Nvidia</span>
                    </div>
                    <div class="grid grid-cols-1 gap-3 w-full max-w-md">
                        <button onclick="quickPrompt('Build a modern landing page with hero section')" class="p-4 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--border)] text-left transition-all active:scale-98">
                            <i class="fas fa-globe text-[#667eea] mb-2"></i>
                            <p class="text-sm font-medium">Landing Page</p>
                            <p class="text-xs text-[var(--text-secondary)]">Hero, features, footer</p>
                        </button>
                        <button onclick="quickPrompt('Explain quantum computing simply')" class="p-4 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--border)] text-left transition-all active:scale-98">
                            <i class="fas fa-atom text-yellow-500 mb-2"></i>
                            <p class="text-sm font-medium">Explanation</p>
                            <p class="text-xs text-[var(--text-secondary)]">Quantum computing basics</p>
                        </button>
                    </div>
                </div>

                <div id="messagesContainer" class="hidden space-y-4 max-w-4xl mx-auto"></div>
            </div>

            <div class="p-3 border-t border-[var(--border)] bg-[var(--bg-secondary)] safe-area-bottom">
                <div class="max-w-3xl mx-auto">
                    <div id="fileUploadPreview" class="hidden mb-3"></div>
                    <div class="input-area rounded-2xl border p-3 shadow-sm relative">
                        <div class="flex items-end gap-3">
                            <button onclick="triggerFileUpload()" class="p-2 rounded-xl hover:bg-[var(--bg-tertiary)] text-[var(--text-secondary)] transition-colors active:scale-95" title="Upload file">
                                <i class="fas fa-paperclip text-lg"></i>
                            </button>
                            <button onclick="toggleDeepThink()" id="deepThinkBtn" class="p-2 rounded-xl hover:bg-[var(--bg-tertiary)] text-[var(--text-secondary)] transition-colors active:scale-95" title="Toggle Deepthink">
                                <i class="fas fa-trophy"></i>
                            </button>
                            <input type="file" id="fileInput" class="hidden" accept=".txt,.pdf,.doc,.docx,.md,.json,.csv,.js,.py,.html,.css" onchange="handleFileUpload(event)">
                            <textarea id="userInput" placeholder="Ask anything..." class="flex-1 bg-transparent resize-none outline-none max-h-32 text-base leading-relaxed" rows="1" onkeydown="handleKeyDown(event)" oninput="autoResize(this)" __gchrome_uniqueid="18"></textarea>
                            <button onclick="sendMessage()" id="sendBtn" class="p-3 rounded-xl bg-gradient-to-r from-[#667eea] to-[#764ba2] text-white transition-all disabled:opacity-50 active:scale-95 shadow-lg">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-center text-[var(--text-secondary)] mt-2">
                        15 Providers  Auto Fallback  Extended Thinking
                    </p>
                </div>
            </div>
        </main>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl w-full max-w-lg max-h-[85vh] overflow-hidden shadow-2xl flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-[var(--border)]">
                <h2 class="text-lg font-bold flex items-center gap-2">
                    <i class="fas fa-cog text-[var(--accent)]"></i>
                    API Keys
                </h2>
                <button onclick="closeSettings()" class="p-2 rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-2 bg-yellow-50 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 text-xs px-4 py-2">
                <i class="fas fa-lock mr-1"></i> Keys are stored securely in your browser's LocalStorage.
            </div>
            <div class="p-4 space-y-3 overflow-y-auto flex-1" id="apiKeyInputs">
                <div class="p-3 bg-[var(--bg-tertiary)] rounded-xl">
                    <div class="flex items-center gap-2 mb-2"><span></span><span class="font-medium text-sm">HuggingFace</span></div>
                    <input type="password" id="key_huggingface" placeholder="Paste API Key here (auto-saved)" class="w-full p-3 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none" __gchrome_uniqueid="19">
                </div>
                <div class="p-3 bg-[var(--bg-tertiary)] rounded-xl">
                    <div class="flex items-center gap-2 mb-2"><span></span><span class="font-medium text-sm">OpenRouter</span></div>
                    <input type="password" id="key_openrouter" placeholder="Paste API Key here (auto-saved)" class="w-full p-3 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none" __gchrome_uniqueid="20">
                </div>
                <div class="p-3 bg-[var(--bg-tertiary)] rounded-xl">
                    <div class="flex items-center gap-2 mb-2"><span></span><span class="font-medium text-sm">Groq</span></div>
                    <input type="password" id="key_groq" placeholder="Paste API Key here (auto-saved)" class="w-full p-3 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none" __gchrome_uniqueid="21">
                </div>
                <div class="p-3 bg-[var(--bg-tertiary)] rounded-xl">
                    <div class="flex items-center gap-2 mb-2"><span></span><span class="font-medium text-sm">Together AI</span></div>
                    <input type="password" id="key_together" placeholder="Paste API Key here (auto-saved)" class="w-full p-3 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none" __gchrome_uniqueid="22">
                </div>
                <div class="p-3 bg-[var(--bg-tertiary)] rounded-xl">
                    <div class="flex items-center gap-2 mb-2"><span></span><span class="font-medium text-sm">Cerebras</span></div>
                    <input type="password" id="key_cerebras" placeholder="Paste API Key here (auto-saved)" class="w-full p-3 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none" __gchrome_uniqueid="23">
                </div>
                <div class="p-3 bg-[var(--bg-tertiary)] rounded-xl">
                    <div class="flex items-center gap-2 mb-2"><span></span><span class="font-medium text-sm">SambaNova</span></div>
                    <input type="password" id="key_sambanova" placeholder="Paste API Key here (auto-saved)" class="w-full p-3 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none" __gchrome_uniqueid="24">
                </div>
                <div class="p-3 bg-[var(--bg-tertiary)] rounded-xl">
                    <div class="flex items-center gap-2 mb-2"><span></span><span class="font-medium text-sm">Fireworks AI</span></div>
                    <input type="password" id="key_fireworks" placeholder="Paste API Key here (auto-saved)" class="w-full p-3 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none" __gchrome_uniqueid="25">
                </div>
                <div class="p-3 bg-[var(--bg-tertiary)] rounded-xl">
                    <div class="flex items-center gap-2 mb-2"><span></span><span class="font-medium text-sm">Routeway</span></div>
                    <input type="password" id="key_routeway" placeholder="Paste API Key here (auto-saved)" class="w-full p-3 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none" __gchrome_uniqueid="26">
                </div>
                <div class="p-3 bg-[var(--bg-tertiary)] rounded-xl">
                    <div class="flex items-center gap-2 mb-2"><span></span><span class="font-medium text-sm">Mistral</span></div>
                    <input type="password" id="key_mistral" placeholder="Paste API Key here (auto-saved)" class="w-full p-3 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none" __gchrome_uniqueid="27">
                </div>
                <div class="p-3 bg-[var(--bg-tertiary)] rounded-xl">
                    <div class="flex items-center gap-2 mb-2"><span></span><span class="font-medium text-sm">Gemini</span></div>
                    <input type="password" id="key_gemini" placeholder="Paste API Key here (auto-saved)" class="w-full p-3 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none" __gchrome_uniqueid="28">
                </div>
                <div class="p-3 bg-[var(--bg-tertiary)] rounded-xl">
                    <div class="flex items-center gap-2 mb-2"><span></span><span class="font-medium text-sm">LongCat</span></div>
                    <input type="password" id="key_longcat" placeholder="Paste API Key here (auto-saved)" class="w-full p-3 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none" __gchrome_uniqueid="29">
                </div>
                <div class="p-3 bg-[var(--bg-tertiary)] rounded-xl">
                    <div class="flex items-center gap-2 mb-2"><span></span><span class="font-medium text-sm">Ollama Cloud</span></div>
                    <input type="password" id="key_ollama" placeholder="Paste API Key here (auto-saved)" class="w-full p-3 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none" __gchrome_uniqueid="30">
                </div>
                <div class="p-3 bg-[var(--bg-tertiary)] rounded-xl">
                    <div class="flex items-center gap-2 mb-2"><span></span><span class="font-medium text-sm">ZenMusk</span></div>
                    <input type="password" id="key_zenmusk" placeholder="Paste API Key here (auto-saved)" class="w-full p-3 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none" __gchrome_uniqueid="31">
                </div>
                <div class="p-3 bg-[var(--bg-tertiary)] rounded-xl">
                    <div class="flex items-center gap-2 mb-2"><span></span><span class="font-medium text-sm">io.net</span></div>
                    <input type="password" id="key_ionet" placeholder="Paste API Key here (auto-saved)" class="w-full p-3 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none" __gchrome_uniqueid="32">
                </div>
                <div class="p-3 bg-[var(--bg-tertiary)] rounded-xl">
                    <div class="flex items-center gap-2 mb-2"><span></span><span class="font-medium text-sm">Nvidia</span></div>
                    <input type="password" id="key_nvidia" placeholder="Paste API Key here (auto-saved)" class="w-full p-3 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none" __gchrome_uniqueid="33">
                </div></div>
            <div class="p-4 border-t border-[var(--border)] flex justify-end gap-3">
                <button onclick="closeSettings()" class="px-4 py-2.5 rounded-xl hover:bg-[var(--bg-tertiary)] transition-colors text-sm">Cancel</button>
                <button onclick="saveSettings()" class="px-5 py-2.5 rounded-xl bg-gradient-to-r from-[#667eea] to-[#764ba2] text-white font-medium text-sm active:scale-95">
                    <i class="fas fa-save mr-2"></i>Save All
                </button>
            </div>
        </div>
    </div>

    <div id="sourceCodeModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl w-full max-w-4xl max-h-[85vh] overflow-hidden shadow-2xl flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-[var(--border)]">
                <h2 class="text-lg font-bold flex items-center gap-2"><i class="fas fa-code text-[var(--accent)]"></i> App Source Code</h2>
                <button onclick="closeSourceCode()" class="p-2 rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 flex-1 overflow-hidden flex flex-col">
                 <div class="flex items-center justify-between mb-2">
                    <p class="text-xs text-[var(--text-secondary)]">Single file application.</p>
                    <button onclick="copySourceCode()" class="text-xs bg-[var(--accent)] text-white px-3 py-1.5 rounded-lg hover:bg-[var(--accent-hover)] transition-colors"><i class="fas fa-copy mr-1"></i> Copy All</button>
                </div>
                <textarea id="sourceCodeViewer" readonly="" class="w-full flex-1 p-3 text-xs font-mono bg-[var(--bg-tertiary)] border border-[var(--border)] rounded-xl resize-none focus:outline-none focus:border-[var(--accent)]" onclick="this.select()" __gchrome_uniqueid="34"></textarea>
            </div>
            <div class="p-4 border-t border-[var(--border)] flex justify-end">
                 <button onclick="closeSourceCode()" class="px-5 py-2.5 rounded-xl bg-gradient-to-r from-[#667eea] to-[#764ba2] text-white font-medium text-sm active:scale-95">Close</button>
            </div>
        </div>
    </div>

    <div id="modelSelectorModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl w-full max-w-4xl max-h-[85vh] overflow-hidden shadow-2xl flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-[var(--border)]">
                <h2 class="text-lg font-bold flex items-center gap-2"><i class="fas fa-cubes text-[var(--accent)]"></i> Model Configuration</h2>
                <button onclick="closeModelSelector()" class="p-2 rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 overflow-y-auto flex-1">
                <p class="text-sm text-[var(--text-secondary)] mb-4">Select models and assign aggregator stages (1/2/3). Use "Select All" to quickly select active provider models.</p>
                <div id="modelSelectorContent" class="space-y-4"></div>
            </div>
            <div class="p-4 border-t border-[var(--border)] flex justify-between items-center gap-3">
                <div class="text-sm text-[var(--text-secondary)]"><span id="modalSelectedCount">0</span> selected</div>
                <div class="flex gap-3">
                    <button onclick="closeModelSelector()" class="px-4 py-2.5 rounded-xl hover:bg-[var(--bg-tertiary)] transition-colors text-sm">Cancel</button>
                    <button onclick="saveModelSelection()" class="px-5 py-2.5 rounded-xl bg-gradient-to-r from-[#667eea] to-[#764ba2] text-white font-medium text-sm active:scale-95"><i class="fas fa-check mr-2"></i>Apply</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const MODEL_CONFIGS = {
            'sarvamai/sarvam-m': { max_tokens: 30000 }, 'qwen/qwq-32b': { max_tokens: 30000 }, 'qwen/qwen2.5-7b-instruct': { max_tokens: 30000 }, 'mistralai/mamba-codestral-7b-v0.1': { max_tokens: 30000 },
            'google/gemma-3-1b-it': { max_tokens: 30000 }, 'google/gemma-3n-e4b-it': { max_tokens: 30000 }, 'ibm/granite-3.3-8b-instruct': { max_tokens: 60000 }, 'microsoft/phi-4-mini-flash-reasoning': { max_tokens: 60000 },
            'mistralai/mixtral-8x22b-instruct-v0.1': { max_tokens: 60000 }, 'thudm/chatglm3-6b': { max_tokens: 8000 }, 'google/gemma-7b': { max_tokens: 8000, noSystemRole: true },
            'google/gemma-2-27b-it': { max_tokens: 8000, noSystemRole: true }, 'nvidia/nemotron-4-mini-hindi-4b-instruct': { max_tokens: 4000 }, 'microsoft/phi-3-medium-4k-instruct': { max_tokens: 4000 },
            'google/shieldgemma-9b': { max_tokens: 1024 }
        };

        const PROVIDERS = {
            huggingface: { name: 'HuggingFace', endpoint: 'https://router.huggingface.co/v1/chat/completions', keyName: 'sahu_huggingface_key', color: 'huggingface', icon: '', models: { 'GLM-4.7': 'zai-org/GLM-4.7', 'GLM-4.7-Flash': 'zai-org/GLM-4.7-Flash', 'ERNIE-4.5-VL': 'baidu/ERNIE-4.5-VL-424B-A47B-Base-PT', 'DeepSeek-V3.2': 'deepseek-ai/DeepSeek-V3.2', 'DeepSeek-R1': 'deepseek-ai/DeepSeek-R1', 'DeepSeek-R1-Distill': 'deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B', 'Qwen3-Coder': 'Qwen/Qwen3-Coder-480B-A35B-Instruct', 'Qwen3-Thinking': 'Qwen/Qwen3-235B-A22B-Thinking-2507', 'Mistral-7B': 'mistralai/Mistral-7B-Instruct-v0.3', 'Kimi-K2-Thinking': 'moonshotai/Kimi-K2-Thinking', 'Kimi-K2': 'moonshotai/Kimi-K2-Instruct', 'Kimi-K2.5': 'moonshotai/Kimi-K2.5', 'gpt-oss-120b': 'openai/gpt-oss-120b', 'gpt-oss-20b': 'openai/gpt-oss-20b', 'MiMo-V2-Flash': 'XiaomiMiMo/MiMo-V2-Flash', 'MiniMax-M2.1': 'MiniMaxAI/MiniMax-M2.1', 'Olmo-3.1-Instruct': 'allenai/Olmo-3.1-32B-Instruct', 'Olmo-3.1-Think': 'allenai/Olmo-3.1-32B-Think', 'Llama-3.3-70B': 'meta-llama/Llama-3.3-70B-Instruct', 'NextCoder-32B': 'microsoft/NextCoder-32B', 'KAT-Dev': 'Kwaipilot/KAT-Dev' } },
            openrouter: { name: 'OpenRouter', endpoint: 'https://openrouter.ai/api/v1/chat/completions', keyName: 'sahu_openrouter_key', color: 'openrouter', icon: '', models: { 'trinity-large': 'arcee-ai/trinity-large-preview:free', 'solar-pro-3': 'upstage/solar-pro-3:free', 'lfm-thinking': 'liquid/lfm-2.5-1.2b-thinking:free', 'lfm-instruct': 'liquid/lfm-2.5-1.2b-instruct:free', 'molmo-2-8b': 'allenai/molmo-2-8b:free', 'nemotron-30b': 'nvidia/nemotron-3-nano-30b-a3b:free', 'trinity-mini': 'arcee-ai/trinity-mini:free', 'tng-r1t-chimera': 'tngtech/tng-r1t-chimera:free', 'nemotron-12b-vl': 'nvidia/nemotron-nano-12b-v2-vl:free', 'qwen3-next-80b': 'qwen/qwen3-next-80b-a3b-instruct:free', 'nemotron-9b': 'nvidia/nemotron-nano-9b-v2:free', 'glm-4.5-air': 'z-ai/glm-4.5-air:free', 'qwen3-coder': 'qwen/qwen3-coder:free', 'deepseek-r1t2-chimera': 'tngtech/deepseek-r1t2-chimera:free', 'deepseek-r1': 'deepseek/deepseek-r1-0528:free', 'qwen3-4b': 'qwen/qwen3-4b:free', 'deepseek-r1t-chimera': 'tngtech/deepseek-r1t-chimera:free', 'mistral-small': 'mistralai/mistral-small-3.1-24b-instruct:free', 'qwen-2.5-vl': 'qwen/qwen-2.5-vl-7b-instruct:free', 'hermes-3-405b': 'nousresearch/hermes-3-llama-3.1-405b:free', 'llama-3.1-405b': 'meta-llama/llama-3.1-405b-instruct:free', 'nova-2-lite': 'amazon/nova-2-lite-v1' } },
            groq: { name: 'Groq', endpoint: 'https://api.groq.com/openai/v1/chat/completions', keyName: 'sahu_groq_key', color: 'groq', icon: '', models: { 'gpt-oss-120b': 'openai/gpt-oss-120b', 'gpt-oss-20b': 'openai/gpt-oss-20b', 'qwen3-32b': 'qwen/qwen3-32b', 'llama-3.1-8b': 'llama-3.1-8b-instant', 'llama-3.3-70b': 'llama-3.3-70b-versatile', 'llama-4-maverick': 'meta-llama/llama-4-maverick-17b-128e-instruct', 'llama-4-scout': 'meta-llama/llama-4-scout-17b-16e-instruct', 'kimi-k2-instruct': 'moonshotai/kimi-k2-instruct', 'kimi-k2-0905': 'moonshotai/kimi-k2-instruct-0905', 'groq-compound': 'groq/compound' } },
            together: { name: 'Together AI', endpoint: 'https://api.together.xyz/v1/chat/completions', keyName: 'sahu_together_key', color: 'together', icon: '', models: { 'glm-4.7': 'zai-org/GLM-4.7', 'llama-4-maverick': 'meta-llama/Llama-4-Maverick-17B-128E-Instruct-FP8', 'deepseek-r1': 'deepseek-ai/DeepSeek-R1-0528-tput', 'ministral-14b': 'mistralai/Ministral-3-14B-Instruct-2512', 'trinity-mini': 'arcee-ai/trinity-mini', 'cogito-671b': 'deepcogito/cogito-v2-1-671b', 'glm-4.5-air': 'zai-org/GLM-4.5-Air-FP8', 'qwen3-next-80b': 'Qwen/Qwen3-Next-80B-A3B-Thinking', 'gemma-3n': 'google/gemma-3n-E4B-it', 'nemotron-9b': 'nvidia/NVIDIA-Nemotron-Nano-9B-v2', 'llama-4-scout': 'meta-llama/Llama-4-Scout-17B-16E-Instruct', 'cogito-405b': 'deepcogito/cogito-v2-preview-llama-405B', 'cogito-109b': 'deepcogito/cogito-v2-preview-llama-109B-MoE' } },
            cerebras: { name: 'Cerebras', endpoint: 'https://api.cerebras.ai/v1/chat/completions', keyName: 'sahu_cerebras_key', color: 'cerebras', icon: '', models: { 'qwen-3-32b': 'qwen-3-32b', 'qwen-3-235b': 'qwen-3-235b-a22b-instruct-2507', 'gpt-oss-120b': 'gpt-oss-120b', 'llama-3.3-70b': 'llama-3.3-70b', 'llama-3.1-8b': 'llama3.1-8b', 'zai-glm-4.7': 'zai-glm-4.7' } },
            sambanova: { name: 'SambaNova', endpoint: 'https://api.sambanova.ai/v1/chat/completions', keyName: 'sahu_sambanova_key', color: 'sambanova', icon: '', models: { 'allam-7b': 'ALLaM-7B-Instruct-preview', 'deepseek-r1': 'DeepSeek-R1-0528', 'deepseek-r1-distill-70b': 'DeepSeek-R1-Distill-Llama-70B', 'deepseek-v3.1': 'DeepSeek-V3.1', 'deepseek-v3.1-terminus': 'DeepSeek-V3.1-Terminus', 'deepseek-v3.2': 'DeepSeek-V3.2', 'llama-swallow-70b': 'Llama-3.3-Swallow-70B-Instruct-v0.4', 'llama-4-maverick': 'Llama-4-Maverick-17B-128E-Instruct', 'llama-3.1-8b': 'Meta-Llama-3.1-8B-Instruct', 'llama-3.3-70b': 'Meta-Llama-3.3-70B-Instruct', 'gpt-oss-120b': 'gpt-oss-120b', 'qwen3-235b': 'Qwen3-235B', 'qwen3-32b': 'Qwen3-32B' } },
            fireworks: { name: 'Fireworks AI', endpoint: 'https://api.fireworks.ai/inference/v1/chat/completions', keyName: 'sahu_fireworks_key', color: 'fireworks', icon: '', models: { 'kimi-k2p5': 'accounts/fireworks/models/kimi-k2p5', 'minimax-m2p1': 'accounts/fireworks/models/minimax-m2p1', 'glm-4p7': 'accounts/fireworks/models/glm-4p7', 'deepseek-v3p2': 'accounts/fireworks/models/deepseek-v3p2', 'qwen3-vl-235b-thinking': 'accounts/fireworks/models/qwen3-vl-235b-a22b-thinking', 'deepseek-r1-0528': 'accounts/fireworks/models/deepseek-r1-0528', 'qwen3-235b-thinking': 'accounts/fireworks/models/qwen3-235b-a22b-thinking-2507', 'deepseek-v3p1': 'accounts/fireworks/models/deepseek-v3p1', 'glm-4p6': 'accounts/fireworks/models/glm-4p6', 'minimax-m2': 'accounts/fireworks/models/minimax-m2', 'qwen3-coder-480b': 'accounts/fireworks/models/qwen3-coder-480b-a35b-instruct' } },
            routeway: { name: 'Routeway', endpoint: 'https://api.routeway.ai/v1/chat/completions', keyName: 'sahu_routeway_key', color: 'routeway', icon: '', models: { 'Opus-4.5': 'claude-opus-4.5', 'Sonnet-4.5': 'claude-sonnet-4.5', 'Haiku-4.5': 'claude-haiku-4.5', 'o3-mini-high': 'o3-mini-high', 'command-r-plus-08-2024': 'command-r-plus-08-2024', 'command-a-reasoning-08-2025': 'command-a-reasoning-08-2025', 'command-a-03-2025': 'command-a-03-2025', 'tng-r1t-chimera': 'tng-r1t-chimera:free', 'nemotron-30b': 'nemotron-3-nano-30b-a3b:free', 'devstral': 'devstral-2512:free', 'kimi-k2-0905': 'kimi-k2-0905:free', 'minimax-m2': 'minimax-m2:free', 'nemotron-9b': 'nemotron-nano-9b-v2:free', 'deepseek-r1t2-chimera': 'deepseek-r1t2-chimera:free', 'deepseek-r1t-chimera': 'deepseek-r1t-chimera:free', 'gpt-oss-120b': 'gpt-oss-120b:free', 'glm-4.5-air': 'glm-4.5-air:free', 'deepseek-r1-0528': 'deepseek-r1-0528:free', 'mistral-nemo': 'mistral-nemo-instruct:free', 'deepseek-r1': 'deepseek-r1:free', 'deepseek-r1-distill-32b': 'deepseek-r1-distill-qwen-32b:free', 'llama-3.2-3b': 'llama-3.2-3b-instruct:free', 'llama-3.3-70b': 'llama-3.3-70b-instruct:free', 'llama-3.1-8b': 'llama-3.1-8b-instruct:free', 'llama-3.2-1b': 'llama-3.2-1b-instruct:free', 'claude-opus-4-6': 'claude-opus-4-6', 'claude-opus-4-6-free': 'claude-opus-4-6:free' } },
            mistral: { name: 'Mistral', endpoint: 'https://api.mistral.ai/v1/agents/completions', keyName: 'sahu_mistral_key', color: 'mistral', icon: '', models: { 'magistral-medium': 'ag_019bd61a73807623a04e608019bbd02f', 'ministral-14b': 'ag_019bd61e5c1c751993fd59206f87615c', 'mistral-large': 'ag_019bd5e9195c72c591ae1de889616331', 'codestral': 'ag_019bd615fbb872f5a2f5dcaaa3de7c80', 'devstral': 'ag_019bd5f9714b7062b5ee3544b9fd095e' } },
            gemini: { name: 'Gemini', endpoint: 'https://generativelanguage.googleapis.com/v1beta/openai/chat/completions', keyName: 'sahu_gemini_key', color: 'gemini', icon: '', models: { 'gemini-3-flash': 'gemini-3-flash-preview', 'gemini-2.5-pro': 'gemini-2.5-pro', 'gemini-2.5-flash': 'gemini-flash-latest', 'gemini-2.5-flash-lite': 'gemini-flash-lite-latest' } },
            longcat: { name: 'LongCat', endpoint: 'https://api.longcat.chat/openai/v1/chat/completions', keyName: 'sahu_longcat_key', color: 'longcat', icon: '', models: { 'LongCat-Flash-Chat': 'LongCat-Flash-Chat', 'LongCat-Flash-Thinking': 'LongCat-Flash-Thinking', 'LongCat-Flash-Thinking-2601': 'LongCat-Flash-Thinking-2601', 'LongCat-Flash-Lite': 'LongCat-Flash-Lite' } },
            ollama: { name: 'Ollama Cloud', endpoint: 'https://api.ollama.cloud/v1/chat/completions', keyName: 'sahu_ollama_key', color: 'ollama', icon: '', models: { 'qwen3-coder-next:cloud': 'qwen3-coder-next:cloud', 'qwen3-vl:cloud': 'qwen3-vl:cloud', 'qwen3-next:80b-cloud': 'qwen3-next:80b-cloud', 'kimi-k2.5:cloud': 'kimi-k2.5:cloud', 'kimi-k2-thinking:cloud': 'kimi-k2-thinking:cloud', 'kimi-k2:1t-cloud': 'kimi-k2:1t-cloud', 'minimax-m2.1:cloud': 'minimax-m2.1:cloud', 'minimax-m2:cloud': 'minimax-m2:cloud', 'deepseek-v3.2:cloud': 'deepseek-v3.2:cloud', 'deepseek-v3.1:671b-cloud': 'deepseek-v3.1:671b-cloud', 'glm-4.6:cloud': 'glm-4.6:cloud', 'glm-4.7:cloud': 'glm-4.7:cloud', 'ministral-3:14b-cloud': 'ministral-3:14b-cloud', 'ministral-3:8b-cloud': 'ministral-3:8b-cloud', 'devstral-small-2::24b-cloud': 'devstral-small-2::24b-cloud', 'devstral-2:123b-cloud': 'devstral-2:123b-cloud', 'nemotron-3-nano:30b-cloud': 'nemotron-3-nano:30b-cloud', 'cogito-2.1:671b-cloud': 'cogito-2.1:671b-cloud', 'rnj-1:8b-cloud': 'rnj-1:8b-cloud', 'gemini-3-pro-preview': 'gemini-3-pro-preview', 'gemini-3-flash-preview': 'gemini-3-flash-preview', 'gpt-oss:120b-cloud': 'gpt-oss:120b-cloud', 'gemma3:27b-cloud': 'gemma3:27b-cloud' } },
            zenmusk: { name: 'ZenMusk', endpoint: 'https://zenmux.ai/api/v1/chat/completions', keyName: 'sahu_zenmusk_key', color: 'zenmusk', icon: '', models: { 'anthropic/claude-opus-4.6': 'anthropic/claude-opus-4.6', 'stepfun/step-3.5-flash-free': 'stepfun/step-3.5-flash-free', 'minimax/minimax-m2-her': 'minimax/minimax-m2-her', 'qwen/qwen3-max': 'qwen/qwen3-max', 'baidu/ernie-5.0-thinking-preview': 'baidu/ernie-5.0-thinking-preview', 'z-ai/glm-4.7-flash-free': 'z-ai/glm-4.7-flash-free', 'xiaomi/mimo-v2-flash-free': 'xiaomi/mimo-v2-flash-free', 'openai/gpt-5.2-pro': 'openai/gpt-5.2-pro', 'openai/gpt-5.2': 'openai/gpt-5.2', 'z-ai/glm-4.6v-flash-free': 'z-ai/glm-4.6v-flash-free', 'anthropic/claude-opus-4.5': 'anthropic/claude-opus-4.5', 'google/gemini-3-pro-preview': 'google/gemini-3-pro-preview', 'kuaishou/kat-coder-pro-v1-free': 'kuaishou/kat-coder-pro-v1-free', 'x-ai/grok-code-fast-1': 'x-ai/grok-code-fast-1' } },
            ionet: { name: 'io.net', endpoint: 'https://api.io.net/v1/chat/completions', keyName: 'sahu_ionet_key', color: 'ionet', icon: '', models: { 'Kimi-K2-Thinking': 'Kimi-K2-Thinking', 'Kimi-K2-Instruct-0905': 'Kimi-K2-Instruct-0905', 'GLM-4.7-Flash': 'GLM-4.7-Flash', 'GLM-4.7': 'GLM-4.7', 'DeepSeek-V3.2': 'DeepSeek-V3.2', 'gpt-oss-120b': 'gpt-oss-120b', 'gpt-oss-20b': 'gpt-oss-20b', 'GLM-4.6': 'GLM-4.6', 'Qwen3-Next-80B-A3B-Instruct': 'Qwen3-Next-80B-A3B-Instruct', 'Qwen3-Coder-480B-A35B-Instruct-int4-mixed-ar': 'Qwen3-Coder-480B-A35B-Instruct-int4-mixed-ar', 'Llama-4-Maverick-17B-128E-Instruct-FP8': 'Llama-4-Maverick-17B-128E-Instruct-FP8', 'Llama-3.3-70B-Instruct': 'Llama-3.3-70B-Instruct', 'Mistral-Nemo-Instruct-2407': 'Mistral-Nemo-Instruct-2407', 'Mistral-Large-Instruct-2411': 'Mistral-Large-Instruct-2411' } },
            nvidia: { name: 'Nvidia', endpoint: 'https://integrate.api.nvidia.com/v1/chat/completions', keyName: 'sahu_nvidia_key', color: 'nvidia', icon: '', models: { 'google/shieldgemma-9b': 'google/shieldgemma-9b', 'minimaxai/minimax-m2.1': 'minimaxai/minimax-m2.1', 'minimaxai/minimax-m2': 'minimaxai/minimax-m2', 'Glm 4.7': 'z-ai/glm4.7', 'ai21labs/jamba-1.5-mini-instruct': 'ai21labs/jamba-1.5-mini-instruct', 'bytedance/seed-oss-36b-instruct': 'bytedance/seed-oss-36b-instruct', 'deepseek-ai/deepseek-v3.2': 'deepseek-ai/deepseek-v3.2', 'deepseek-ai/deepseek-v3.1': 'deepseek-ai/deepseek-v3.1', 'deepseek-ai/deepseek-v3.1-terminus': 'deepseek-ai/deepseek-v3.1-terminus', 'deepseek-ai/deepseek-r1-distill-qwen-32b': 'deepseek-ai/deepseek-r1-distill-qwen-32b', 'deepseek-ai/deepseek-r1-distill-llama-8b': 'deepseek-ai/deepseek-r1-distill-llama-8b', 'google/gemma-3n-e4b-it': 'google/gemma-3n-e4b-it', 'google/gemma-3-27b-it': 'google/gemma-3-27b-it', 'Gemman 3-1b': 'google/gemma-3-1b-it', 'google/gemma-2-27b-it': 'google/gemma-2-27b-it', 'google/gemma-7b': 'google/gemma-7b', 'ibm/granite-3.3-8b-instruct': 'ibm/granite-3.3-8b-instruct', 'phi-4-multimodal': 'microsoft/phi-4-multimodal-instruct', 'microsoft/phi-4-mini-flash-reasoning': 'microsoft/phi-4-mini-flash-reasoning', 'microsoft/phi-3-medium-4k-instruct': 'microsoft/phi-3-medium-4k-instruct', 'meta/llama-4-maverick-17b-128e-instruct': 'meta/llama-4-maverick-17b-128e-instruct', 'meta/llama-4-scout-17b-16e-instruct': 'meta/llama-4-scout-17b-16e-instruct', 'meta/llama-3.3-70b-instruct': 'meta/llama-3.3-70b-instruct', 'meta/llama-3.2-3b-instruct': 'meta/llama-3.2-3b-instruct', 'moonshotai/kimi-k2.5': 'moonshotai/kimi-k2.5', 'moonshotai/kimi-k2-thinking': 'moonshotai/kimi-k2-thinking', 'moonshotai/kimi-k2-instruct': 'moonshotai/kimi-k2-instruct', 'mistralai/devstral-2-123b-instruct-2512': 'mistralai/devstral-2-123b-instruct-2512', 'mistralai/mistral-large-3-675b-instruct-2512': 'mistralai/mistral-large-3-675b-instruct-2512', 'mistralai/ministral-14b-instruct-2512': 'mistralai/ministral-14b-instruct-2512', 'mistralai/magistral-small-2506': 'mistralai/magistral-small-2506', 'Mixtral 8x22b': 'mistralai/mixtral-8x22b-instruct-v0.1', 'mistralai/mamba-codestral-7b-v0.1': 'mistralai/mamba-codestral-7b-v0.1', 'stepfun-ai/step-3.5-flash': 'stepfun-ai/step-3.5-flash', 'openai/gpt-oss-120b': 'openai/gpt-oss-120b', 'openai/gpt-oss-20b': 'openai/gpt-oss-20b', 'sarvamai/sarvam-m': 'sarvamai/sarvam-m', 'qwen/qwen3-next-80b-a3b-instruct': 'qwen/qwen3-next-80b-a3b-instruct', 'qwen/qwen3-next-80b-a3b-thinking': 'qwen/qwen3-next-80b-a3b-thinking', 'qwen/qwen3-coder-480b-a35b-instruct': 'qwen/qwen3-coder-480b-a35b-instruct', 'qwen/qwen3-235b-a22b': 'qwen/qwen3-235b-a22b', 'qwen/qwq-32b': 'qwen/qwq-32b', 'qwen/qwen2.5-7b-instruct': 'qwen/qwen2.5-7b-instruct', 'nvidia/nemotron-4-mini-hindi-4b-instruct': 'nvidia/nemotron-4-mini-hindi-4b-instruct', 'nvidia/nemotron-3-nano-30b-a3b': 'nvidia/nemotron-3-nano-30b-a3b', 'Nemotron 12b VL': 'nvidia/nemotron-nano-12b-v2-vl', 'Nemotron nano 9 b': 'nvidia/nvidia-nemotron-nano-9b-v2', 'nvidia/llama-3.3-nemotron-super-49b-v1.5': 'nvidia/llama-3.3-nemotron-super-49b-v1.5', 'thudm/chatglm3-6b': 'thudm/chatglm3-6b', 'nvidia/usdcode-llama-3.1-70b-instruct': 'nvidia/usdcode-llama-3.1-70b-instruct' } }
        };

        const AGGREGATOR_PROMPTS = {
            stage1: `You are Stage 1 Aggregator hosted by Saksham Intelligence. Analyze all expert answers, identify consensus, disagreements, and errors. Create an initial synthesis. Think step by step in <think> tags.`,
            stage2: `You are Stage 2 Aggregator hosted by Saksham Intelligence. Verify the Stage 1 synthesis, resolve contradictions, fill gaps. Think deeply in <think> tags.`,
            stage3: `You are Stage 3 Final Aggregator hosted by Saksham Intelligence. Produce a clean, polished final answer. No meta-commentary. Complete and authoritative. Think briefly in <think> tags.`
        };

        let state = { messages: [], chatHistory: [], currentChatId: null, isProcessing: false, theme: 'light', uploadedFile: null, uploadedFileContent: null, activeProviders: ['huggingface'], selectedModels: [], autoFallback: true, shieldGemmaEnabled: false, deepThinkEnabled: false };

        // GLOBAL HELPER FUNCTIONS ATTACHED TO WINDOW TO PREVENT REFERENCE ERRORS
        window.toggleSidebar = function() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('show');
        };

        window.toggleDeepThink = function() {
            state.deepThinkEnabled = !state.deepThinkEnabled;
            const btn = document.getElementById('deepThinkBtn');
            if (state.deepThinkEnabled) {
                document.body.classList.add('deepthink-active');
                btn.classList.add('text-[var(--accent)]');
                btn.classList.remove('text-[var(--text-secondary)]');
                showToast('Deepthink Enabled');
            } else {
                document.body.classList.remove('deepthink-active');
                btn.classList.remove('text-[var(--accent)]');
                btn.classList.add('text-[var(--text-secondary)]');
                showToast('Deepthink Disabled');
            }
        };

        window.openSettings = function() {
            document.getElementById('settingsModal').classList.remove('hidden');
            renderApiKeyInputs();
        };

        window.closeSettings = function() { document.getElementById('settingsModal').classList.add('hidden'); };

        window.openSourceCode = function() {
            document.getElementById('sourceCodeModal').classList.remove('hidden');
            // Use document.documentElement.outerHTML to get full source
            document.getElementById('sourceCodeViewer').value = document.documentElement.outerHTML;
        };

        window.closeSourceCode = function() { document.getElementById('sourceCodeModal').classList.add('hidden'); };

        window.copySourceCode = function() {
            const viewer = document.getElementById('sourceCodeViewer');
            viewer.select();
            navigator.clipboard.writeText(viewer.value).then(() => showToast('Source Code Copied!'));
        };

        window.toggleTheme = function() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('sahu_theme', state.theme);
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            if (state.theme === 'dark') {
                icon.className = 'fas fa-sun text-[var(--text-secondary)]';
                text.textContent = 'Light Mode';
            } else {
                icon.className = 'fas fa-moon text-[var(--text-secondary)]';
                text.textContent = 'Dark Mode';
            }
        };

        window.toggleProvider = function(providerKey, enabled) {
            if (enabled) {
                if (!state.activeProviders.includes(providerKey)) state.activeProviders.push(providerKey);
            } else {
                state.activeProviders = state.activeProviders.filter(p => p !== providerKey);
            }
            localStorage.setItem('sahu_active_providers', JSON.stringify(state.activeProviders));
            renderProviderCheckboxes();
            updateUI();
        };

        window.saveAutoFallback = function() {
            state.autoFallback = document.getElementById('autoFallback').checked;
            localStorage.setItem('sahu_auto_fallback', state.autoFallback);
        };

        window.saveShieldGemma = function() {
            state.shieldGemmaEnabled = document.getElementById('shieldGemmaCheck').checked;
            localStorage.setItem('sahu_shield_gemma', state.shieldGemmaEnabled);
        };

        window.openModelSelector = function() {
            document.getElementById('modelSelectorModal').classList.remove('hidden');
            renderModelSelector();
        };

        window.closeModelSelector = function() { document.getElementById('modelSelectorModal').classList.add('hidden'); };

        window.toggleAllModels = function(providerKey) {
            const provider = PROVIDERS[providerKey];
            if (!provider) return;
            const allModels = Object.entries(provider.models);
            const selectedCount = allModels.filter(([key]) => state.selectedModels.find(m => m.provider === providerKey && m.modelKey === key)).length;
            const isAllSelected = selectedCount === allModels.length;
            if (isAllSelected) {
                state.selectedModels = state.selectedModels.filter(m => m.provider !== providerKey);
            } else {
                allModels.forEach(([modelKey, modelId]) => {
                    if (!state.selectedModels.find(m => m.provider === providerKey && m.modelKey === modelKey)) {
                        state.selectedModels.push({ provider: providerKey, modelKey, modelId, stage: 'none' });
                    }
                });
            }
            renderModelSelector();
        };

        window.toggleModelSelection = function(provider, modelKey, modelId, selected) {
            if (selected) {
                if (!state.selectedModels.find(m => m.provider === provider && m.modelKey === modelKey)) {
                    state.selectedModels.push({ provider, modelKey, modelId, stage: 'none' });
                }
            } else {
                state.selectedModels = state.selectedModels.filter(m => !(m.provider === provider && m.modelKey === modelKey));
            }
            renderModelSelector();
        };

        window.setModelStage = function(provider, modelKey, modelId, stage, event) {
            event.stopPropagation();
            let model = state.selectedModels.find(m => m.provider === provider && m.modelKey === modelKey);
            if (!model) {
                model = { provider, modelKey, modelId, stage: 'none' };
                state.selectedModels.push(model);
            }
            if (model.stage === stage) {
                model.stage = 'none';
            } else {
                state.selectedModels.forEach(m => { if (m.stage === stage) m.stage = 'none'; });
                model.stage = stage;
            }
            renderModelSelector();
        };

        window.saveModelSelection = function() {
            localStorage.setItem('sahu_selected_models', JSON.stringify(state.selectedModels));
            closeModelSelector();
            updateUI();
            showToast(`${state.selectedModels.length} models configured`);
        };

        window.saveSettings = function() {
            Object.keys(PROVIDERS).forEach(key => {
                const input = document.getElementById(`key_${key}`);
                if (input) localStorage.setItem(PROVIDERS[key].keyName, input.value);
            });
            closeSettings();
            showToast('API keys saved locally!');
        };

        window.newChat = function() {
            state.currentChatId = null;
            state.messages = [];
            document.getElementById('messagesContainer').innerHTML = '';
            document.getElementById('messagesContainer').classList.add('hidden');
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('userInput').value = '';
            removeFile();
            toggleSidebar();
        };

        window.triggerFileUpload = function() { document.getElementById('fileInput').click(); };

        window.handleFileUpload = async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            const content = await file.text();
            state.uploadedFile = file;
            state.uploadedFileContent = content.substring(0, 50000);
            document.getElementById('fileUploadPreview').innerHTML = `
                <div class="flex items-center gap-3 p-3 bg-[var(--bg-tertiary)] rounded-xl">
                    <div class="w-10 h-10 bg-[var(--accent)] rounded-lg flex items-center justify-center text-white"><i class="fas fa-file"></i></div>
                    <div class="flex-1 min-w-0"><div class="font-medium text-sm truncate">${escapeHtml(file.name)}</div><div class="text-xs text-[var(--text-secondary)]">${(file.size / 1024).toFixed(1)} KB</div></div>
                    <button class="p-2 rounded-lg hover:bg-[var(--bg-secondary)]" onclick="removeFile()"><i class="fas fa-times text-[var(--text-secondary)]"></i></button>
                </div>`;
            document.getElementById('fileUploadPreview').classList.remove('hidden');
        };

        window.removeFile = function() {
            state.uploadedFile = null;
            state.uploadedFileContent = null;
            document.getElementById('fileUploadPreview').classList.add('hidden');
            document.getElementById('fileInput').value = '';
        };

        window.handleKeyDown = function(event) { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); } };
        window.autoResize = function(textarea) { textarea.style.height = 'auto'; textarea.style.height = Math.min(textarea.scrollHeight, 128) + 'px'; };
        window.quickPrompt = function(text) { document.getElementById('userInput').value = text; sendMessage(); };
        window.loadChat = function(id) { const chat = state.chatHistory.find(c => c.id === id); if (chat) { state.currentChatId = id; state.messages = chat.messages || []; } toggleSidebar(); };

        // Core Functions
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadChatHistory();
            initTheme();
            renderProviderCheckboxes();
            renderApiKeyInputs();
            updateUI();
        });

        function loadSettings() {
            const savedProviders = localStorage.getItem('sahu_active_providers');
            if (savedProviders) { try { state.activeProviders = JSON.parse(savedProviders).filter(p => PROVIDERS[p]); } catch(e) {} }
            const savedModels = localStorage.getItem('sahu_selected_models');
            if (savedModels) { try { state.selectedModels = JSON.parse(savedModels); } catch(e) {} }
            const savedFallback = localStorage.getItem('sahu_auto_fallback');
            if (savedFallback !== null) state.autoFallback = savedFallback === 'true';
            document.getElementById('autoFallback').checked = state.autoFallback;
            const savedShield = localStorage.getItem('sahu_shield_gemma');
            if (savedShield !== null) state.shieldGemmaEnabled = savedShield === 'true';
            document.getElementById('shieldGemmaCheck').checked = state.shieldGemmaEnabled;
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('sahu_theme') || 'light';
            state.theme = savedTheme;
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('themeIcon').className = 'fas fa-sun text-[var(--text-secondary)]';
                document.getElementById('themeText').textContent = 'Light Mode';
            }
        }

        function renderProviderCheckboxes() {
            const container = document.getElementById('providerCheckboxes');
            if (!container) return;
            container.innerHTML = Object.entries(PROVIDERS).map(([key, provider]) => `
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors ${state.activeProviders.includes(key) ? 'ring-2 ring-[var(--accent)]' : ''}">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" ${state.activeProviders.includes(key) ? 'checked' : ''} onchange="toggleProvider('${key}', this.checked)">
                    <span class="text-xs truncate">${provider.name}</span>
                </label>`).join('');
        }

        function renderApiKeyInputs() {
            const container = document.getElementById('apiKeyInputs');
            if (!container) return;
            container.innerHTML = Object.entries(PROVIDERS).map(([key, provider]) => `
                <div class="p-3 bg-[var(--bg-tertiary)] rounded-xl">
                    <div class="flex items-center gap-2 mb-2"><span>${provider.icon}</span><span class="font-medium text-sm">${provider.name}</span></div>
                    <input type="password" id="key_${key}" placeholder="Paste API Key here (auto-saved)" class="w-full p-3 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none">
                </div>`).join('');
            Object.keys(PROVIDERS).forEach(key => {
                const savedKey = localStorage.getItem(PROVIDERS[key].keyName);
                const input = document.getElementById(`key_${key}`);
                if (input && savedKey) input.value = savedKey;
            });
        }

        function renderModelSelector() {
            const container = document.getElementById('modelSelectorContent');
            if (!container) return;
            let html = '';
            state.activeProviders.forEach(providerKey => {
                const provider = PROVIDERS[providerKey];
                if (!provider) return;
                html += `<div class="border border-[var(--border)] rounded-xl overflow-hidden"><div class="bg-[var(--bg-tertiary)] p-3 flex items-center justify-between"><div class="flex items-center gap-2"><span>${provider.icon}</span><span class="font-semibold text-sm">${provider.name}</span><span class="text-xs text-[var(--text-secondary)]">(${Object.keys(provider.models).length})</span></div><button onclick="toggleAllModels('${providerKey}')" class="text-xs px-2 py-1 bg-[var(--bg-secondary)] border border-[var(--border)] rounded hover:bg-[var(--accent)] hover:text-white transition-colors">Select All / None</button></div><div class="p-3 grid grid-cols-1 gap-2">${Object.entries(provider.models).map(([modelKey, modelId]) => {
                    const existing = state.selectedModels.find(m => m.provider === providerKey && m.modelKey === modelKey);
                    const isSelected = !!existing;
                    const stage = existing?.stage || 'none';
                    return `<div class="model-card ${isSelected ? 'selected' : ''}"><input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" ${isSelected ? 'checked' : ''} onchange="toggleModelSelection('${providerKey}', '${modelKey}', '${modelId}', this.checked)"><div class="flex-1 min-w-0"><div class="text-sm font-medium truncate">${modelKey}</div><div class="text-[10px] text-[var(--text-secondary)] truncate">${modelId}</div></div><div class="flex gap-1"><button class="stage-btn ${stage === '1' ? 'active-1' : ''}" onclick="setModelStage('${providerKey}', '${modelKey}', '${modelId}', '1', event)">1</button><button class="stage-btn ${stage === '2' ? 'active-2' : ''}" onclick="setModelStage('${providerKey}', '${modelKey}', '${modelId}', '2', event)">2</button><button class="stage-btn ${stage === '3' ? 'active-3' : ''}" onclick="setModelStage('${providerKey}', '${modelKey}', '${modelId}', '3', event)">3</button></div></div>`;
                }).join('')}</div></div>`;
            });
            container.innerHTML = html || '<div class="text-center py-8 text-[var(--text-secondary)]">Select at least one provider from sidebar.</div>';
            document.getElementById('modalSelectedCount').textContent = state.selectedModels.length;
        }

        function updateUI() { document.getElementById('selectedModelCount').textContent = state.selectedModels.length; }
        function loadChatHistory() { const saved = localStorage.getItem('sahu_chat_history'); if (saved) { state.chatHistory = JSON.parse(saved); renderChatHistory(); } }
        function renderChatHistory() { document.getElementById('chatHistory').innerHTML = state.chatHistory.slice(0, 10).map(chat => `<div onclick="loadChat('${chat.id}')" class="p-3 rounded-xl hover:bg-[var(--bg-tertiary)] cursor-pointer flex items-center gap-3 active:scale-98"><i class="fas fa-message text-[var(--text-secondary)]"></i><span class="text-sm truncate flex-1">${escapeHtml(chat.title)}</span></div>`).join(''); }
        function showToast(message, type = 'success') { const toast = document.createElement('div'); toast.className = `toast ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`; toast.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i><span>${message}</span>`; document.body.appendChild(toast); setTimeout(() => toast.remove(), 3000); }
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

        async function callModelWithFallback(providerKey, modelId, messages, retryCount = 0) {
            const provider = PROVIDERS[providerKey];
            const apiKey = localStorage.getItem(provider.keyName);
            if (!apiKey) throw new Error(`No API key for ${provider.name}`);
            const headers = { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' };
            if (providerKey === 'openrouter') { headers['HTTP-Referer'] = window.location.href; headers['X-Title'] = 'SAHU 1 Agents'; }
            if (providerKey === 'gemini') { headers['x-goog-api-key'] = apiKey; delete headers['Authorization']; }
            let requestBody = { model: modelId, messages, max_tokens: MODEL_CONFIGS[modelId]?.max_tokens || 65536, temperature: 0.7, stream: false };
            if (providerKey === 'mistral') requestBody = { agent_id: modelId, messages };
            if (providerKey === 'nvidia') { requestBody.temperature = 0.7; requestBody.top_p = 0.95; }
            try {
                let url = provider.endpoint;
                // CORS Proxy for Nvidia and Ollama Cloud to fix loading issues
                if (providerKey === 'nvidia' || providerKey === 'ollama') { url = 'https://corsproxy.io/?' + encodeURIComponent(provider.endpoint); }
                const response = await fetch(url, { method: 'POST', headers, body: JSON.stringify(requestBody) });
                if (!response.ok) throw new Error(`${response.status}: ${await response.text()}`);
                const data = await response.json();
                const content = data.choices?.[0]?.message?.content || '';
                const thinkMatch = content.match(/<think>([\s\S]*?)<\/think>/);
                return { content: thinkMatch ? content.replace(/<think>[\s\S]*?<\/think>/, '').trim() : content, thinking: thinkMatch ? thinkMatch[1] : (data.choices?.[0]?.message?.reasoning_content || ''), provider: providerKey };
            } catch (error) {
                 if (state.autoFallback && retryCount < 1) {
                    // Simple Fallback Attempt
                    const fallback = state.activeProviders.find(p => p !== providerKey && localStorage.getItem(PROVIDERS[p].keyName));
                    if (fallback) return { ...await callModelWithFallback(fallback, Object.values(PROVIDERS[fallback].models)[0], messages, retryCount + 1), fallback: true };
                 }
                 throw error;
            }
        }

        window.sendMessage = async function() {
            const input = document.getElementById('userInput');
            let content = input.value.trim();
            if (!content && !state.uploadedFile) return;
            if (state.isProcessing) return;
            const activeModels = state.selectedModels.filter(m => state.activeProviders.includes(m.provider));
            if (activeModels.length === 0) { showToast('No models selected', 'error'); openModelSelector(); return; }
            state.isProcessing = true; document.getElementById('sendBtn').disabled = true;
            if (state.uploadedFile) content += `\n\n[File: ${state.uploadedFile.name}]\n\`\`\`\n${state.uploadedFileContent}\n\`\`\``;
            document.getElementById('welcomeScreen').classList.add('hidden');
            const container = document.getElementById('messagesContainer');
            container.classList.remove('hidden');
            container.innerHTML += `<div class="flex justify-end"><div class="message-user px-4 py-3 rounded-2xl max-w-[85%] shadow-lg"><p class="text-white text-sm whitespace-pre-wrap">${escapeHtml(content.substring(0, 300))}${content.length > 300 ? '...' : ''}</p></div></div>`;
            input.value = ''; input.style.height = 'auto'; removeFile();
            const expertGridId = 'expert-grid-' + Date.now();
            container.innerHTML += `<div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="${expertGridId}"></div>`;
            const expertGrid = document.getElementById(expertGridId);
            const expertModels = activeModels.filter(m => m.stage === 'none' || !m.stage);
            const expertResults = [];
            
            // Render Expert Cards
            const modelsToQuery = expertModels.length > 0 ? expertModels : activeModels;
            modelsToQuery.forEach((m, i) => expertGrid.innerHTML += `<div class="expert-card thinking rounded-xl p-3" id="expert-${i}"><div class="flex items-center gap-2 mb-2"><span>${PROVIDERS[m.provider].icon}</span><div class="flex-1 min-w-0"><div class="font-medium text-sm truncate">${m.modelKey}</div></div><div class="typing-indicator flex gap-1"><span class="w-1.5 h-1.5 bg-yellow-400 rounded-full"></span><span class="w-1.5 h-1.5 bg-yellow-400 rounded-full"></span><span class="w-1.5 h-1.5 bg-yellow-400 rounded-full"></span></div></div><div class="text-xs text-[var(--text-secondary)]">Thinking...</div></div>`);

            await Promise.allSettled(modelsToQuery.map(async (model, idx) => {
                try {
                    const res = await callModelWithFallback(model.provider, model.modelId, [{ role: 'user', content }]);
                    expertResults[idx] = { ...model, ...res, success: true };
                    const card = document.getElementById(`expert-${idx}`);
                    card.className = 'expert-card complete rounded-xl p-3';
                    card.innerHTML = `<div class="flex items-center gap-2 mb-2"><span>${PROVIDERS[model.provider].icon}</span><div class="flex-1 min-w-0"><div class="font-medium text-sm truncate">${model.modelKey}</div><div class="text-[10px] text-[var(--text-secondary)]">${PROVIDERS[model.provider].name}</div></div><i class="fas fa-check-circle text-green-500"></i></div>${res.thinking ? `<div class="thinking-block"><div class="thinking-header"><i class="fas fa-brain"></i> Thinking</div><div class="text-[var(--text-secondary)] text-xs whitespace-pre-wrap max-h-32 overflow-y-auto">${escapeHtml(res.thinking)}</div></div>` : ''}<div class="text-sm max-h-48 overflow-y-auto">${formatMarkdown(res.content)}</div>`;
                } catch (e) {
                    const card = document.getElementById(`expert-${idx}`);
                    card.className = 'expert-card error rounded-xl p-3';
                    card.innerHTML = `<div class="text-red-500 text-xs"><i class="fas fa-exclamation-circle"></i> ${model.modelKey}: ${e.message}</div>`;
                }
            }));

            // Aggregation Stages
            const stages = [1, 2, 3];
            let currentContext = expertResults.filter(r => r.success).map(r => `### ${r.modelKey}\n${r.content}`).join('\n\n');
            window.lastAnswer = currentContext; // Fallback
            
            for (const stage of stages) {
                 const aggModel = activeModels.find(m => m.stage === String(stage));
                 if (!aggModel) continue;
                 const stageId = `stage-${stage}-${Date.now()}`;
                 container.innerHTML += `<div class="aggregator-response stage-${stage} rounded-2xl p-4" id="${stageId}"><div class="flex items-center gap-3 mb-3"><div class="w-8 h-8 rounded-lg flex items-center justify-center text-white font-bold text-sm bg-gray-400">${stage}</div><div><span class="font-semibold text-sm">Stage ${stage}</span><p class="text-xs text-[var(--text-secondary)]">${aggModel.modelKey}</p></div></div><div class="typing-indicator flex gap-1"><span class="w-1.5 h-1.5 bg-gray-400 rounded-full"></span><span class="w-1.5 h-1.5 bg-gray-400 rounded-full"></span><span class="w-1.5 h-1.5 bg-gray-400 rounded-full"></span></div></div>`;
                 container.scrollTop = container.scrollHeight;
                 try {
                     const prompt = AGGREGATOR_PROMPTS[`stage${stage}`];
                     const res = await callModelWithFallback(aggModel.provider, aggModel.modelId, [{ role: 'system', content: prompt }, { role: 'user', content: currentContext }]);
                     currentContext = res.content;
                     window.lastAnswer = res.content;
                     document.getElementById(stageId).innerHTML = `<div class="flex items-center gap-3 mb-3"><div class="w-8 h-8 rounded-lg flex items-center justify-center text-white font-bold text-sm bg-green-500">${stage}</div><div class="flex-1"><span class="font-semibold text-sm">Stage ${stage}</span><p class="text-xs text-[var(--text-secondary)]">${aggModel.modelKey}</p></div><i class="fas fa-check-circle text-green-500"></i></div>${res.thinking ? `<div class="thinking-block"><div class="thinking-header"><i class="fas fa-brain"></i> Thinking</div><div class="text-[var(--text-secondary)] text-xs whitespace-pre-wrap">${escapeHtml(res.thinking)}</div></div>` : ''}<div class="prose max-w-none text-sm">${formatMarkdown(res.content)}</div>`;
                 } catch (e) {
                     document.getElementById(stageId).innerHTML += `<div class="text-red-500 text-sm mt-2">Aggregation Failed: ${e.message}</div>`;
                 }
            }
            
            container.innerHTML += `<div class="export-buttons"><button class="export-btn" onclick="copyToClipboard()"><i class="fas fa-copy"></i><span>Copy</span></button></div>`;
            container.scrollTop = container.scrollHeight;
            state.isProcessing = false;
            document.getElementById('sendBtn').disabled = false;
        };

        function formatMarkdown(text) { return text ? text.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>').replace(/`([^`]+)`/g, '<code class="bg-[var(--bg-tertiary)] px-1 py-0.5 rounded text-xs">$1</code>').replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>') : ''; }
        window.copyToClipboard = function() { navigator.clipboard.writeText(window.lastAnswer || '').then(() => showToast('Copied!')); };
    </script>
    <script type="module" onerror="console.warn('Failed to load the app. Try reloading it.')">import '@/index';</script>


        <script type="module" onerror="console.warn('Failed to load the app. Try reloading it.')">import '@/index';</script>
        </body></html>
