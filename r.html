<html lang="en" __gchrome_remoteframetoken="7991128ad4e993b3ff2bc95826b55401"><head><style>
        @import url(https://fonts.googleapis.com/css?family=Google+Sans+Text);
        html {
          font-family: 'Google Sans Text', 'Google Sans';
          font-size: 14px;
          color-scheme: light dark;
          background: light-dark(white, black);
          color: light-dark(black, white);
        }
        </style>
        
        <script type="importmap">{"imports":{"@modelcontextprotocol/sdk/":"https://esm.sh/@modelcontextprotocol/sdk/dist/esm/","https://esm.sh/@modelcontextprotocol/sdk@^1.11.0/es2022/":"https://esm.sh/@modelcontextprotocol/sdk@^1.11.0/es2022/dist/esm/","https://esm.sh/@modelcontextprotocol/sdk@^1.11.0/client/index?target=es2022":"https://esm.sh/@modelcontextprotocol/sdk@^1.11.0/dist/esm/client/index?target=es2022","https://esm.sh/@modelcontextprotocol/sdk@^1.11.0/types?target=es2022":"https://esm.sh/@modelcontextprotocol/sdk@^1.11.0/dist/esm/types?target=es2022","@/index":"data:application/javascript;base64,","@":"data:application/javascript;base64,"}}</script>
        <script>
          window.APPLET_FILES = ["index.tsx","metadata.json","index.html"];
          </script>
        <script type="module">
        (() => {
  if (window.self === window.top) {
    // Do not run the shim in the main window, only in iframes.
    return;
  }

  window.API_KEY = 'GEMINI_API_KEY';
  window.GEMINI_API_KEY = 'GEMINI_API_KEY';
  window.process = window.process || {};
  window.process.env = window.process.env || {};
  window.process.env.API_KEY = window.API_KEY;
  window.process.env.GEMINI_API_KEY = window.GEMINI_API_KEY;

  const bootstrapChannel = new Promise((resolve) => {
    window.addEventListener('message', (event) => {
      if (event.origin !== 'https://aistudio.google.com') {
        return;
      }

      if (event.data.type === 'bootstrap') {
        resolve({
          port: event.ports[0],
          urlPatterns:
              event.data.urlPatterns.map((pattern) => new RegExp(pattern)),
        });
      }
    });
  });

  window.aistudio = window.aistudio || {
    handleFullscreenEsc: true,
    getHostUrl: async function() {
      const hostPort = (await bootstrapChannel).port;
      return new Promise((resolve) => {
        const channel = new MessageChannel();
        hostPort.postMessage(
            {type: 'get_host_url'},
            [channel.port2]);
        const port = channel.port1;
        port.onmessage = (message) => {
          resolve(message.data.url);
        };
      });
    },
    hasSelectedApiKey: async function() {
      const hostPort = (await bootstrapChannel).port;
      return new Promise((resolve) => {
        const channel = new MessageChannel();
        hostPort.postMessage(
            {type: 'has_selected_api_key'},
            [channel.port2]);
        const port = channel.port1;
        port.onmessage = (message) => {
          resolve(message.data);
        };
      });
    },
    openSelectKey: async function() {
      const hostPort = (await bootstrapChannel).port;
      const channel = new MessageChannel();
      hostPort.postMessage(
          {type: 'open_select_key'},
          [channel.port2]);
    },
    getModelQuota: async function(model) {
      const hostPort = (await bootstrapChannel).port;
      return new Promise((resolve) => {
        const channel = new MessageChannel();
        hostPort.postMessage(
            {type: 'get_model_quota', model},
            [channel.port2]);
        const port = channel.port1;
        port.onmessage = (message) => {
          resolve(message.data.modelQuota);
        };
      });
    },
  };

  const nativeFetch = window.fetch;

  /**
   * @param {string | URL | Request} resource The resource of the fetch request.
   * @param {RequestInit} options The options of the fetch request.
   * @return {Promise!} The promise of the fetch request.
   */
  async function fetch(resource, options) {
    const config = await bootstrapChannel;

    const request = resource instanceof Request ?
      resource.clone() :
      new Request(resource, options);

    if (!config.urlPatterns.some((pattern) => request.url.match(pattern))) {
      return nativeFetch(resource, options);
    }
    const hostPort = config.port;

    const channel = new MessageChannel();
    const port = channel.port1;
    let bodyBytes;
    const transfer = [channel.port2];
    const parts = [];
    const buffer = await request.arrayBuffer();
    if (buffer.byteLength) {
      bodyBytes = buffer;
      transfer.push(bodyBytes);
    }
    hostPort.postMessage(
        {
          type: 'fetch',
          url: request.url,
          method: request.method,
          headers: [...request.headers.entries()],
          body: bodyBytes,
        },
        transfer);

    let streamController;
    const body = new ReadableStream({
      start(controller) {
        streamController = controller;
      },
    });
    let resolveReceive;
    const receivePromise = new Promise((resolve) => {
      resolveReceive = resolve;
    });
    port.onmessage = (message) => {
      switch (message.data.type) {
        case 'response':
          resolveReceive(new Response(body, {
            status: message.data.status,
            statusText: message.data.statusText,
            headers: new Headers(message.data.headers),
          }));
          break;
        case 'body':
          streamController.enqueue(message.data.data);
          break;
        case 'body_done':
          streamController.close();
          break;
      }
    };
    return receivePromise;
  }

  Object.defineProperty(window, 'fetch', {
    get: function() {
      return fetch;
    },
  });

  // See details in: https://github.com/angular/angular/issues/63064.
  function patchHistoryStateFunctionForAngular(originalFn, baseHref) {
    return (state, unused, url) => {
      if (typeof url === 'string' && !url.startsWith('blob:')) {
        url = baseHref + url;
      }
      return originalFn.apply(window.history, [state, unused, url]);
    };
  }

  if (false) {
    const baseHref = window.location.href;
    window.history.replaceState = patchHistoryStateFunctionForAngular(window.history.replaceState, baseHref);
    window.history.pushState = patchHistoryStateFunctionForAngular(window.history.pushState, baseHref);
  }

  const originalWebSocket = window.WebSocket;
  class ProxiedWebSocket extends EventTarget {
    /**
     * @param {string} url The url of the websocket.
     * @param {Object!} protocols The protocols of the websocket.
     */
    constructor(url, protocols) {
      super();
      this.url = url;
      this.protocols = protocols;

      this.open();
    }

    /** Opens the websocket. */
    async open() {
      const hostPort = (await bootstrapChannel).port;
      const channel = new MessageChannel();
      hostPort.postMessage(
          {type: 'websocket_open', url: this.url, protocols: this.protocols},
          [channel.port2]);
      this.port = channel.port1;
      this.port.onmessage = (message) => {
        if (message.data.type === 'close') {
          const event = new CloseEvent('close', {
            code: message.data.code,
            reason: message.data.reason,
            wasClean: message.data.wasClean,
          });
          if (this.onclose) {
            this.onclose(event);
          }
          this.dispatchEvent(event);
          return;
        } else if (message.data.type === 'open') {
          const event = new Event('open');
          if (this.onopen) {
            this.onopen(event);
          }
          this.dispatchEvent(event);
          return;
        } else if (message.data.type === 'message') {
          let data = message.data.data;
          if (message.data.messageType === 'text' || message.data.messageType === 'message') {
            data = new TextDecoder().decode(data);
          }
          const event = new MessageEvent('message', {
            data,
            type: message.data.messageType,
          });
          if (this.onmessage) {
            this.onmessage(event);
          }
          this.dispatchEvent(event);
          return;
        } else if (message.data.type === 'error') {
          const event = new ErrorEvent('error', {
            message: message.data.message,
          });
          if (this.onerror) {
            this.onerror(event);
          }
          this.dispatchEvent(event);
          return;
        }
        console.error('received unknown message in frame', event.data);
      };
    }
    /**
     * @param {string|ArrayBuffer!} data The data to send.
     */
    send(data) {
      if (typeof data === 'string') {
        this.port.postMessage({type: 'send', data});
      } else {
        this.port.postMessage({type: 'send', data}, [data.buffer]);
      }
    }

    /**
     * @param {number} code The code of the close event.
     * @param {string} reason The reason of the close event.
     */
    close(code, reason) {
      this.port.postMessage({type: 'close', code, reason});
    }
  }

  /**
   * @param {string} url The url of the websocket.
   * @param {Object!} protocols The protocols of the websocket.
   * @return {WebSocket!} The websocket.
   */
  function createWebSocket(url, protocols) {
    // This should come from the bootstrap channel, but we want this to
    // work for the synchronous constructor here.
    if (url.startsWith('wss://generativelanguage.googleapis.com/')) {
      return Reflect.construct(ProxiedWebSocket, [url, protocols]);
    }
    return Reflect.construct(originalWebSocket, [url, protocols]);
  }

  Object.defineProperty(window, 'WebSocket', {
    get: function() {
      const fn = createWebSocket;
      Object.keys(originalWebSocket).forEach((key) => {
        Object.defineProperty(fn, key, {
          value: originalWebSocket[key],
        });
      });
      return fn;
    },
  });

  async function instrumentErrorReporting() {
    const errors = [];
    let hostPort;

    function reportError(message) {
      if (!hostPort) {
        errors.push(message);
      } else {
        hostPort.postMessage({type: 'error', message: message}, message);
      }
    }

    function serialize(args) {
      return args.map((a) => {
        if (a instanceof Error || a instanceof ErrorEvent) {
          return a.message;
        }
        if(a instanceof CloseEvent) {
          return {code: a.code, reason: a.reason, wasClean: a.wasClean};
        }
        if( a instanceof Map) {
          return JSON.parse(JSON.stringify([...a.entries()]));
        }
        if( a instanceof Set) {
          return JSON.parse(JSON.stringify([...a.values()]));
        }
        if (a instanceof Object) {
          return JSON.parse(JSON.stringify(a));
        }
        return a;
      });
    }

    const originalConsole = window.console;
    const originalConsoleLog = window.console.log;
    const originalConsoleError = window.console.error;
    const originalConsoleWarn = window.console.warn;
    const originalConsoleDebug = window.console.debug;
    window.console = {
      ...originalConsole,
      log: (message, ...args) => {
        originalConsoleLog.apply(window.console, [message, ...args]);
        const combined = serialize([message, ...args]);
        reportError({type: 'console_log', message: combined });
      },
      debug: (message, ...args) => {
        originalConsoleDebug.apply(window.console, [message, ...args]);
        const combined = serialize([message, ...args]);
        reportError({type: 'console_debug', message: combined });
      },
      error: (message, ...args) => {
        originalConsoleError.apply(window.console, [message, ...args]);
        const combined = serialize([message, ...args]);
        reportError({type: 'console_error', message: combined });
      },
      warn: (message, ...args) => {
        originalConsoleWarn.apply(window.console, [message, ...args]);
        const combined = serialize([message, ...args]);
        reportError({type: 'console_warn', message: combined });
      },
    };

    window.onerror = (message, source, lineno, colno, error) => {
      reportError({type: 'error', message: serialize([message]), source, lineno, colno, error});
    };

    window.onunhandledrejection = (event) => {
      reportError({type: 'unhandledrejection', message: serialize([event.reason])});
    };

    window.alert = (message) => {
      reportError({type: 'alert', message: serialize([message]) });
    };

    hostPort = (await bootstrapChannel).port;
    for(const error of errors) {
      hostPort.postMessage({type: 'error', message: error});
    }
  }

  const availableFiles = new Set(window.APPLET_FILES || []);

  instrumentErrorReporting();

  if (false) {
    const notifyLocationChange = async () => {
      const hostPort = (await bootstrapChannel).port;
      hostPort.postMessage({type: 'locationchange', href: location.href});
    };

    // Send initial state on load.
    notifyLocationChange();

    const originalPushState = history.pushState;
    history.pushState = (...args) => {
      originalPushState.apply(history, args);
      notifyLocationChange();
    };

    const originalReplaceState = history.replaceState;
    history.replaceState = (...args) => {
      originalReplaceState.apply(history, args);
      notifyLocationChange();
    };
    window.addEventListener('popstate', (e) => {
      notifyLocationChange();
    });
  }

  window.addEventListener('hashchange', async (e) =>{
    const config = await bootstrapChannel;
    const hostPort = config.port;
    hostPort.postMessage({type: 'hashchange', hash: window.location.hash});
    if (false) {
      hostPort.postMessage({
        type: 'locationchange',
        href: location.href,
      });
    }
  });

  if (true) {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/html2canvas-pro';
    script.onload = () => {
      window.addEventListener('message', async (event) => {
        if (event.data?.type === 'capture-screenshot') {
          try {
            const canvas = await html2canvas(document.documentElement, {
              logging: false,
              useCORS: true,
              backgroundColor: null,
              scale: 1,
            });
            const hostPort = (await bootstrapChannel).port;
            hostPort.postMessage(
              {
                type: 'screenshot-result',
                dataUrl: canvas.toDataURL('image/png'),
                requestId: event.data.requestId,
                scrollX: document.body.scrollLeft,
                scrollY: document.body.scrollTop,
              },
            );
          } catch (e) {
            const hostPort = (await bootstrapChannel).port;
            hostPort.postMessage(
              {
                type: 'screenshot-error',
                error: e.message,
                requestId: event.data.requestId,
              });
          }
        }
      });
    };
    document.head.appendChild(script);
  }

  if (false) {
    const MAX_ANCESTOR_LEVEL = 3;
    const MAX_DESCENDANT_LEVEL = 3;

    function getElementSelector(el) {
      if (!el || el.nodeType !== 1) {
        return '';
      }
      const parts = [];
      while(el && el.nodeType === 1 && el.tagName.toLowerCase() !== 'body') {
        let part = el.tagName.toLowerCase();
        if (el.id) {
          part += '#' + CSS.escape(el.id);
        }

        const parent = el.parentElement;
        if (parent) {
          let nth = 1;
          let prev = el.previousElementSibling;
          while(prev) {
            if (prev.tagName === el.tagName) {
              nth++;
            }
            prev = prev.previousElementSibling;
          }
          part += ':nth-of-type(' + nth + ')';
        }

        parts.unshift(part);
        el = el.parentElement;
      }
      return parts.join(' > ');
    }

    function getDomTreeAsString(element, depth, maxDepth) {
      if (!element || element.nodeType !== 1 || depth > maxDepth) {
        return '';
      }
      const tagName = element.tagName.toLowerCase();
      let attrs = [];
      if (element.id) {
        attrs.push('id="' + element.id + '"');
      }
      if (element.classList.length > 0) {
        attrs.push('class="' + element.classList.value + '"');
      }
      const attrString = attrs.length > 0 ? ' ' + attrs.join(' ') : '';

      let content = '';
      for (const node of element.childNodes) {
        if (node.nodeType === 1) { // Element node
          content += getDomTreeAsString(node, depth + 1, maxDepth);
        } else if (node.nodeType === 3) { // Text node
          content += node.textContent;
        }
      }

      return '<' + tagName + attrString + '>' + content + '</' + tagName + '>';
    }

    function getElementInfo(element) {
      const selector = getElementSelector(element);
      let levelsUp = 0;
      let root = element;
      while(levelsUp < MAX_ANCESTOR_LEVEL && root.parentElement && root.parentElement.tagName.toLowerCase() !== 'html') {
        root = root.parentElement;
        levelsUp++;
      }
      const domString = getDomTreeAsString(root, 0, levelsUp + MAX_DESCENDANT_LEVEL);
      const styles = window.getComputedStyle(element);
      const css = {};
      for (let i = 0; i < styles.length; i++) {
        const key = styles[i];
        css[key] = styles.getPropertyValue(key);
      }
      return { selector, domString, css };
    }

    const style = document.createElement('style');
    style.textContent =
    '.aistudio-hover-highlight { box-shadow: inset 0 0 0 0.5px white, inset 0 0 0 1.5px rgba(128,128,128,0.6) !important; }' +
    '.aistudio-active-highlight { box-shadow: inset 0 0 0 0.5px white, inset 0 0 0 1.5px #87a9ff !important; }' +
    '#aistudio-focus-mode-tag { position: absolute; display: none; background: #87a9ff; border-radius: 4px; border: 0.5px solid white; z-index: 10000; text-transform: lowercase; padding: 2px 4px; color: #32302c; font-family: Inter, sans-serif; font-size: 12px; font-style: normal; font-weight: 400; line-height: 16px; pointer-events: none; }' +
    '#aistudio-hover-mode-tag { position: absolute; display: none; background: rgba(128,128,128,0.6); border-radius: 4px; border: 0.5px solid white; z-index: 10000; text-transform: lowercase; padding: 2px 4px; color: white; font-family: Inter, sans-serif; font-size: 12px; font-style: normal; font-weight: 400; line-height: 16px; pointer-events: none; }';
    document.head.appendChild(style);

    let hoveredElement = null;
    let activeElement = null;
    let focusTag = null;
    let hoverTag = null;
    let resizeObserver = null;
    let iframeLoaded = false;
    let designModeEnabled = false;
    let designModeStyle = null;
    let designModeOverlay = null;

    function ensureFocusTag() {
      if (!focusTag) {
        focusTag = document.createElement('div');
        focusTag.id = 'aistudio-focus-mode-tag';
        document.body.appendChild(focusTag);
      }
    }

    function cleanupActiveElement() {
      if (!activeElement) return;
      activeElement.classList.remove('aistudio-active-highlight');
      activeElement.removeAttribute('data-aistudio-tag-name');
      if (resizeObserver) {
        resizeObserver.unobserve(activeElement);
      }
      window.removeEventListener('resize', positionFocusTag);
      window.removeEventListener('scroll', positionFocusTag, true);
    }

    function positionFocusTag() {
      requestAnimationFrame(() => {
        if (!activeElement || !focusTag) return;
        focusTag.style.display = 'inline-flex';
        const rect = activeElement.getBoundingClientRect();
        focusTag.style.top = (rect.top + window.scrollY - focusTag.offsetHeight - 5) + 'px';
        focusTag.style.left = (rect.left + window.scrollX) + 'px';
      });
    }

    function positionHoverTag() {
      if (!hoveredElement || !hoverTag || hoveredElement === activeElement) {
        if (hoverTag) hoverTag.style.display = 'none';
        return;
      }
      requestAnimationFrame(() => {
        hoverTag.style.display = 'inline-flex';
        const rect = hoveredElement.getBoundingClientRect();
        hoverTag.style.top = (rect.top + window.scrollY - hoverTag.offsetHeight - 5) + 'px';
        hoverTag.style.left = (rect.left + window.scrollX) + 'px';
      });
    }

    if (window.ResizeObserver) {
      resizeObserver = new ResizeObserver(() => {
        positionFocusTag();
      });
    }

    function setHoveredElement(element) {
      if (!designModeEnabled || !iframeLoaded) return;

      if (!hoverTag) {
        hoverTag = document.createElement('div');
        hoverTag.id = 'aistudio-hover-mode-tag';
        document.body.appendChild(hoverTag);
      }

      if (hoveredElement && hoveredElement !== activeElement) {
        hoveredElement.classList.remove('aistudio-hover-highlight');
      }
      hoverTag.style.display = 'none';

      hoveredElement = element;

      if (hoveredElement && hoveredElement !== activeElement) {
        hoveredElement.classList.add('aistudio-hover-highlight');
        hoverTag.textContent = hoveredElement.tagName.toLowerCase();
        positionHoverTag();
      }
    }

    async function setActiveElement(element) {
      if (!designModeEnabled || !iframeLoaded) return;

      ensureFocusTag();
      cleanupActiveElement();
      focusTag.style.display = 'none';

      // Clear hover from new active element if it was hovered
      if (element) {
        element.classList.remove('aistudio-hover-highlight');
      }

      activeElement = element;

      if (activeElement) {
        activeElement.setAttribute('data-aistudio-tag-name', activeElement.tagName);
        activeElement.classList.add('aistudio-active-highlight');
        focusTag.textContent = activeElement.tagName.toLowerCase();
        positionFocusTag();
        if (resizeObserver) {
          resizeObserver.observe(activeElement);
        }
        window.addEventListener('resize', positionFocusTag);
        window.addEventListener('scroll', positionFocusTag, true);

        // Notify host about selected element
        const info = getElementInfo(activeElement);
        window.parent.postMessage({
          type: 'element-selected',
          element: info,
        }, '*');
      }
    }

    function getElementAtPoint(x, y) {
      const elements = document.elementsFromPoint(x, y);
      for (const el of elements) {
        if (el.id === 'aistudio-focus-mode-tag' ||
            el.id === 'aistudio-hover-mode-tag' ||
            el.id === 'aistudio-design-mode-overlay') {
          continue;
        }
        return el;
      }
      return null;
    }

    function onMouseMove(e) {
      if (!designModeEnabled) return;
      const element = getElementAtPoint(e.clientX, e.clientY);
      setHoveredElement(element);
    }

    function onClick(e) {
      if (!designModeEnabled) return;
      e.preventDefault();
      e.stopPropagation();
      const element = getElementAtPoint(e.clientX, e.clientY);
      if (element && element !== document.body) {
        setActiveElement(element);
      }
    }

    function onKeyDown(e) {
      if (!designModeEnabled) return;
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        e.stopPropagation();
        const element = document.activeElement;
        if (element && element !== document.body) {
          setActiveElement(element);
        }
      }
    }

    function enableDesignMode() {
      if (designModeEnabled) return;
      designModeEnabled = true;
      designModeStyle = document.createElement('style');
      designModeStyle.textContent =
        'button:disabled, input:disabled, select:disabled, textarea:disabled, ' +
        '[disabled], [aria-disabled="true"] { pointer-events: auto !important; }';
      document.head.appendChild(designModeStyle);
      designModeOverlay = document.createElement('div');
      designModeOverlay.id = 'aistudio-design-mode-overlay';
      designModeOverlay.style.cssText =
        'position: fixed; top: 0; left: 0; width: 100%; height: 100%; ' +
        'z-index: 9999; cursor: default; background: transparent;';
      designModeOverlay.addEventListener('mousemove', onMouseMove);
      designModeOverlay.addEventListener('mousedown', onClick);
      designModeOverlay.addEventListener('keydown', onKeyDown);
      document.body.appendChild(designModeOverlay);
    }

    function disableDesignMode() {
      if (!designModeEnabled) return;
      if (designModeOverlay) {
        designModeOverlay.removeEventListener('mousemove', onMouseMove);
        designModeOverlay.removeEventListener('mousedown', onClick);
        designModeOverlay.removeEventListener('keydown', onKeyDown);
        designModeOverlay.remove();
        designModeOverlay = null;
      }
      setHoveredElement(null);
      clearActiveElement();
      if (designModeStyle) {
        designModeStyle.remove();
        designModeStyle = null;
      }
      designModeEnabled = false;
    }

    function clearActiveElement() {
      ensureFocusTag();
      cleanupActiveElement();
      focusTag.style.display = 'none';
      activeElement = null;
    }

    window.addEventListener('load', () => {
      iframeLoaded = true;
    });

    window.addEventListener('message', async (event) => {
      if (event.data?.type === 'set-design-mode') {
        if (event.data.enabled) {
          enableDesignMode();
        } else {
          disableDesignMode();
        }
      } else if (event.data?.type === 'highlight-element-by-selector') {
        try {
          const selector = event.data.selector;
          if (selector) {
            const element = document.querySelector(selector);
            setActiveElement(element);
          } else {
            setActiveElement(null);
          }
        } catch (e) {
          setActiveElement(null);
        }
      } else if (event.data?.type === 'change-element-style') {
        try {
          const selector = event.data.selector;
          if (selector) {
            const element = document.querySelector(selector);
            if (element) {
              element.style.setProperty(
                event.data.property,
                event.data.value,
                'important',
              );
              positionFocusTag();
            }
          }
        } catch (e) {}
      }
    });
  }

  window.addEventListener('keydown', async (event) => {
    if (event.key === 'Escape' && window.aistudio?.handleFullscreenEsc) {
      const hostPort = (await bootstrapChannel).port;
      hostPort.postMessage({type: 'exit-fullscreen'});
    }
  });
})();
// # sourceURL=iframe_shim.js
        </script>
        <base href="https://ai.studio">



    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <title>SahuAI Agent - Official Saksham Intelligence AI Models Chat</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="./icon-512.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@8.2.0/build/index.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- File Processing & Creation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <!-- SAHU 2.0 Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/string-similarity@4.0.4/umd/string-similarity.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas-pro"></script>

    <style>
        :root { --bg-primary: #ffffff; --bg-secondary: #f8f8f8; --bg-tertiary: #efefef; --text-primary: #1a1a1a; --text-secondary: #525252; --accent: #667eea; --accent-hover: #5a6fd6; --border: #e0e0e0; }
        .dark-mode { --bg-primary: #0a0a0a; --bg-secondary: #141414; --bg-tertiary: #1e1e1e; --text-primary: #e5e5e5; --text-secondary: #a3a3a3; --accent: #667eea; --accent-hover: #7c8ff0; --border: #2a2a2a; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { background-color: var(--bg-primary); color: var(--text-primary); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; }
        .sidebar { background-color: var(--bg-secondary); border-color: var(--border); }
        .message-user { background: linear-gradient(135deg, var(--accent) 0%, #764ba2 100%); }
        .message-assistant { background-color: var(--bg-tertiary); }
        .input-area { background-color: var(--bg-secondary); border-color: var(--border); }
        .expert-card { background-color: var(--bg-tertiary); border: 1px solid var(--border); transition: all 0.3s ease; }
        .expert-card.thinking { border-color: #f59e0b; box-shadow: 0 0 15px rgba(245, 158, 11, 0.15); }
        .expert-card.complete { border-color: #22c55e; }
        .expert-card.error { border-color: #ef4444; }
        .typing-indicator span { animation: typing 1.4s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); opacity: 0.5; } 30% { transform: translateY(-6px); opacity: 1; } }
        .scrollbar-thin::-webkit-scrollbar { width: 5px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: var(--bg-secondary); }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        pre code { display: block; padding: 12px; background: #1a1a1a; border-radius: 8px; overflow-x: auto; font-family: 'SF Mono', Monaco, monospace; font-size: 12px; line-height: 1.5; color: #e5e5e5; }
        .thinking-block { background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 12px; font-size: 13px; display: block; }
        .thinking-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: #d97706; font-weight: 600; font-size: 12px; }
        .aggregator-response { background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(102, 126, 234, 0.1) 100%); border: 2px solid var(--accent); }
        .export-buttons { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 10px; }
        .export-btn { padding: 8px 14px; border-radius: 8px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); min-height: 40px; }
        .export-btn:hover { background: var(--accent); color: white; border-color: var(--accent); }
        .toast { animation: slideIn 0.3s ease-out; position: fixed; bottom: 80px; right: 16px; z-index: 1000; padding: 12px 20px; border-radius: 10px; color: white; display: flex; align-items: center; gap: 10px; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .provider-badge { font-size: 10px; padding: 3px 8px; border-radius: 6px; font-weight: 600; margin-bottom: 4px; display: inline-block; }
        .provider-huggingface { background: rgba(255, 213, 0, 0.2); color: #ca8a04; }
        .provider-openrouter { background: rgba(168, 85, 247, 0.2); color: #9333ea; }
        .provider-groq { background: rgba(249, 115, 22, 0.2); color: #ea580c; }
        .provider-together { background: rgba(34, 197, 94, 0.2); color: #16a34a; }
        .provider-cerebras { background: rgba(99, 102, 241, 0.2); color: #6366f1; }
        .provider-sambanova { background: rgba(14, 165, 233, 0.2); color: #0284c7; }
        .provider-fireworks { background: rgba(239, 68, 68, 0.2); color: #dc2626; }
        .provider-routeway { background: rgba(16, 185, 129, 0.2); color: #059669; }
        .provider-mistral { background: rgba(251, 146, 60, 0.2); color: #ea580c; }
        .provider-gemini { background: rgba(59, 130, 246, 0.2); color: #2563eb; }
        .provider-longcat { background: rgba(139, 92, 246, 0.2); color: #7c3aed; }
        .provider-ollama { background: rgba(75, 85, 99, 0.2); color: #374151; }
        .provider-zenmusk { background: rgba(236, 72, 153, 0.2); color: #be185d; }
        .provider-ionet { background: rgba(6, 182, 212, 0.2); color: #0891b2; }
        .provider-nvidia { background: rgba(118, 185, 0, 0.2); color: #76b900; }
        .stage-btn { padding: 4px 10px; font-size: 11px; border-radius: 6px; cursor: pointer; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-secondary); transition: all 0.2s; min-width: 32px; text-align: center; }
        .stage-btn:hover { border-color: var(--accent); }
        .stage-btn.active-1 { background: #f59e0b; color: white; border-color: #f59e0b; }
        .stage-btn.active-2 { background: #06b6d4; color: white; border-color: #06b6d4; }
        .stage-btn.active-3 { background: #22c55e; color: white; border-color: #22c55e; }
        .model-card { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.2s; background: var(--bg-secondary); }
        .model-card:hover { border-color: var(--accent); }
        .model-card.selected { border-color: var(--accent); background: rgba(102, 126, 234, 0.1); }
        .sidebar { position: fixed; left: -100%; top: 0; bottom: 0; z-index: 100; width: 85%; max-width: 300px; transition: left 0.3s ease; overflow-y: auto; }
        .sidebar.open { left: 0; }
        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; }
        .sidebar-overlay.show { display: block; }
        .blur-content { filter: blur(5px); user-select: none; pointer-events: none; }
        @media (min-width: 768px) { .sidebar { position: relative; left: 0; width: 280px; } .sidebar-overlay { display: none !important; } }
        @media (max-width: 480px) { .export-btn span { display: none; } .export-btn { padding: 10px 12px; } }

        /* SAHU 2.0 Feature Styles */
        .citation { vertical-align: super; font-size: 0.7em; color: var(--accent); cursor: pointer; margin: 0 1px; font-weight: bold; text-decoration: none; position: relative; }
        .citation:hover { text-decoration: underline; }
        
        /* Inline Citation Tooltip */
        .citation-tooltip {
            visibility: hidden;
            width: 250px;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            text-align: left;
            border-radius: 8px;
            padding: 10px;
            position: absolute;
            z-index: 10;
            bottom: 150%;
            left: 50%;
            margin-left: -125px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 1px solid var(--border);
            font-size: 11px;
            font-weight: normal;
            line-height: 1.4;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .citation-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--border) transparent transparent transparent;
        }
        .citation:hover .citation-tooltip { visibility: visible; opacity: 1; }

        .sources-panel { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; padding: 12px; margin-top: 10px; display: block; }
        .source-card { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 8px; background: var(--bg-tertiary); font-size: 12px; text-decoration: none; color: var(--text-primary); margin-bottom: 6px; border: 1px solid transparent; transition: all 0.2s; }
        .source-card:hover { border-color: var(--accent); transform: translateX(2px); }
        .source-favicon { width: 16px; height: 16px; border-radius: 4px; }
        
        .consensus-panel { margin-top: 12px; padding: 10px; background: rgba(102, 126, 234, 0.05); border: 1px solid var(--accent); border-radius: 10px; }
        .tool-card { border: 1px dashed var(--text-secondary); padding: 8px; margin: 4px 0; border-radius: 6px; font-size: 12px; background: var(--bg-secondary); }
        .token-counter { width: 32px; height: 32px; border-radius: 50%; border: 3px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: bold; color: var(--text-secondary); transition: all 0.3s; }
        .pinned-msg { border-left: 3px solid #f59e0b; background: rgba(245, 158, 11, 0.05); }

        /* Perplexity Mode Overrides */
        body.perplexity-mode .sidebar { display: none; } /* Hide Sidebar by default in Perplexity mode */
        body.perplexity-mode .sidebar.open { display: flex; position: fixed; left: 0; z-index: 1000; box-shadow: 5px 0 20px rgba(0,0,0,0.2); } /* Show as overlay when open */
        body.perplexity-mode .sidebar-overlay.show { display: block !important; }
        body.perplexity-mode .expert-card, body.perplexity-mode .consensus-panel { display: none !important; }
        body.perplexity-mode .aggregator-response { background: transparent; border: none; padding: 0; }
        body.perplexity-mode #messagesContainer { max-width: 768px; margin: 0 auto; padding-bottom: 100px; }
        body.perplexity-mode .message-assistant { background: transparent; border: none; padding: 0; }
        body.perplexity-mode .message-user { background: transparent; color: var(--text-primary); font-weight: 600; font-size: 1.25rem; padding: 0; box-shadow: none; margin-bottom: 20px; }
        body.perplexity-mode .message-user p { color: var(--text-primary); }
        body.perplexity-mode .input-area { max-width: 768px; margin: 0 auto; border-radius: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-color: transparent; }
        body.perplexity-mode .sources-panel { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; border: none; background: transparent; padding: 0; margin-bottom: 20px; }
        body.perplexity-mode .source-card { flex-direction: column; align-items: flex-start; height: 80px; justify-content: space-between; background: var(--bg-secondary); border: 1px solid var(--border); }
        body.perplexity-mode .source-card:hover { background: var(--bg-tertiary); }
        body.perplexity-mode .safe-area-bottom { background: transparent; border: none; position: fixed; bottom: 0; width: 100%; left:0; pointer-events: none; }
        body.perplexity-mode .safe-area-bottom > div { pointer-events: auto; }
        body.perplexity-mode header { justify-content: center; border: none; background: transparent; position: relative; }
        body.perplexity-mode header .flex:first-child { display: flex; position: absolute; left: 16px; } /* Ensure menu button visible */

        /* Artifact & Code Styles */
        .artifact-container { border: 1px solid var(--border); border-radius: 8px; margin-top: 10px; overflow: hidden; background: var(--bg-primary); }
        .artifact-header { background: var(--bg-tertiary); padding: 8px 12px; font-size: 11px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); font-family: monospace; color: var(--text-secondary); }
        .artifact-content { padding: 0; margin: 0; }
        .artifact-content pre { margin: 0; border-radius: 0; }
        .render-btn { font-size: 11px; padding: 4px 8px; border-radius: 4px; background: #ecfdf5; color: #047857; border: 1px solid #059669; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; margin-top: 8px; }
        .render-btn:hover { background: #d1fae5; }

        /* Agreement Table */
        .agreement-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 8px; }
        .agreement-table th, .agreement-table td { padding: 6px; border: 1px solid var(--border); text-align: left; }
        .agreement-table th { background: var(--bg-tertiary); font-weight: 600; white-space: nowrap; }
        
        .mode-badge { font-size: 10px; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; margin-left: 6px; font-weight: bold; }
        .mode-standard { background: #e0f2fe; color: #0369a1; }
        .mode-research { background: #fef9c3; color: #a16207; }
        .mode-task { background: #f3e8ff; color: #7e22ce; }
        .task-btn-vibe { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; }
        .task-btn-agentic { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; }
        .task-btn-creation { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; }

        /* Canvas / Artifact Modal */
        #artifactModal {
            transition: opacity 0.2s ease-in-out;
        }
        .canvas-container {
            display: flex;
            flex-direction: column;
            height: 85vh;
            background: var(--bg-secondary);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .canvas-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
        }
        .canvas-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-secondary);
            padding: 4px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .canvas-tab {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .canvas-tab.active {
            background: var(--accent);
            color: white;
        }
        .canvas-body {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        .canvas-editor, .canvas-preview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }
        .canvas-editor.active, .canvas-preview.active {
            display: block;
        }
        .canvas-editor textarea {
            width: 100%;
            height: 100%;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
            line-height: 1.6;
            border: none;
            resize: none;
            outline: none;
        }
        iframe.preview-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }
        
        /* Settings Sub-menus */
        .settings-view { display: none; }
        .settings-view.active { display: block; }
    </style>
<style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.fixed{position:fixed}.relative{position:relative}.inset-0{inset:0px}.z-50{z-index:50}.mx-auto{margin-left:auto;margin-right:auto}.mb-1{margin-bottom:0.25rem}.mb-2{margin-bottom:0.5rem}.mb-3{margin-bottom:0.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mt-2{margin-top:0.5rem}.mr-1{margin-right:0.25rem}.mr-2{margin-right:0.5rem}.mt-1{margin-top:0.25rem}.mt-4{margin-top:1rem}.block{display:block}.flex{display:flex}.grid{display:grid}.hidden{display:none}.h-10{height:2.5rem}.h-14{height:3.5rem}.h-16{height:4rem}.h-2{height:0.5rem}.h-8{height:2rem}.h-full{height:100%}.h-screen{height:100vh}.h-24{height:6rem}.h-5{height:1.25rem}.h-6{height:1.5rem}.h-4{height:1rem}.max-h-32{max-height:8rem}.max-h-60{max-height:15rem}.max-h-\[85vh\]{max-height:85vh}.min-h-0{min-height:0px}.w-10{width:2.5rem}.w-16{width:4rem}.w-2{width:0.5rem}.w-8{width:2rem}.w-full{width:100%}.w-5{width:1.25rem}.w-6{width:1.5rem}.w-4{width:1rem}.min-w-0{min-width:0px}.max-w-2xl{max-width:42rem}.max-w-3xl{max-width:48rem}.max-w-4xl{max-width:56rem}.max-w-6xl{max-width:72rem}.max-w-md{max-width:28rem}.max-w-lg{max-width:32rem}.flex-1{flex:1 1 0%}@keyframes pulse{50%{opacity:.5}}.animate-pulse{animation:pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite}.cursor-pointer{cursor:pointer}.resize-none{resize:none}.grid-cols-1{grid-template-columns:repeat(1, minmax(0, 1fr))}.grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-end{align-items:flex-end}.items-center{align-items:center}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{gap:0.25rem}.gap-2{gap:0.5rem}.gap-3{gap:0.75rem}.space-y-1 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.25rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.25rem * var(--tw-space-y-reverse))}.space-y-2 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.5rem * var(--tw-space-y-reverse))}.space-y-4 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.space-y-3 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.75rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.75rem * var(--tw-space-y-reverse))}.overflow-hidden{overflow:hidden}.overflow-y-auto{overflow-y:auto}.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.rounded-2xl{border-radius:1rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:0.5rem}.rounded-xl{border-radius:0.75rem}.rounded{border-radius:0.25rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-r{border-right-width:1px}.border-t{border-top-width:1px}.border-\[var\(--border\)\]{border-color:var(--border)}.border-\[var\(--accent\)\]{border-color:var(--accent)}.border-transparent{border-color:transparent}.bg-\[var\(--accent\)\]{background-color:var(--accent)}.bg-\[var\(--bg-secondary\)\]{background-color:var(--bg-secondary)}.bg-\[var\(--bg-tertiary\)\]{background-color:var(--bg-tertiary)}.bg-black\/80{background-color:rgb(0 0 0 / 0.8)}.bg-blue-100{--tw-bg-opacity:1;background-color:rgb(219 234 254 / var(--tw-bg-opacity, 1))}.bg-green-100{--tw-bg-opacity:1;background-color:rgb(220 252 231 / var(--tw-bg-opacity, 1))}.bg-green-500{--tw-bg-opacity:1;background-color:rgb(34 197 94 / var(--tw-bg-opacity, 1))}.bg-purple-100{--tw-bg-opacity:1;background-color:rgb(243 232 255 / var(--tw-bg-opacity, 1))}.bg-transparent{background-color:transparent}.bg-black\/60{background-color:rgb(0 0 0 / 0.6)}.bg-indigo-100{--tw-bg-opacity:1;background-color:rgb(224 231 255 / var(--tw-bg-opacity, 1))}.bg-red-100{--tw-bg-opacity:1;background-color:rgb(254 226 226 / var(--tw-bg-opacity, 1))}.bg-teal-500{--tw-bg-opacity:1;background-color:rgb(20 184 166 / var(--tw-bg-opacity, 1))}.bg-yellow-100{--tw-bg-opacity:1;background-color:rgb(254 249 195 / var(--tw-bg-opacity, 1))}.bg-yellow-50{--tw-bg-opacity:1;background-color:rgb(254 252 232 / var(--tw-bg-opacity, 1))}.bg-\[var\(--bg-primary\)\]{background-color:var(--bg-primary)}.bg-opacity-50{--tw-bg-opacity:0.5}.bg-gradient-to-br{background-image:linear-gradient(to bottom right, var(--tw-gradient-stops))}.bg-gradient-to-r{background-image:linear-gradient(to right, var(--tw-gradient-stops))}.from-\[\#667eea\]{--tw-gradient-from:#667eea var(--tw-gradient-from-position);--tw-gradient-to:rgb(102 126 234 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.to-\[\#764ba2\]{--tw-gradient-to:#764ba2 var(--tw-gradient-to-position)}.p-1\.5{padding:0.375rem}.p-2{padding:0.5rem}.p-3{padding:0.75rem}.p-4{padding:1rem}.p-2\.5{padding:0.625rem}.px-2{padding-left:0.5rem;padding-right:0.5rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.px-4{padding-left:1rem;padding-right:1rem}.py-0\.5{padding-top:0.125rem;padding-bottom:0.125rem}.py-1\.5{padding-top:0.375rem;padding-bottom:0.375rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.py-2\.5{padding-top:0.625rem;padding-bottom:0.625rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.px-5{padding-left:1.25rem;padding-right:1.25rem}.py-1{padding-top:0.25rem;padding-bottom:0.25rem}.py-4{padding-top:1rem;padding-bottom:1rem}.pb-2{padding-bottom:0.5rem}.text-left{text-align:left}.text-center{text-align:center}.font-mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}.text-2xl{font-size:1.5rem;line-height:2rem}.text-\[10px\]{font-size:10px}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:0.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-semibold{font-weight:600}.leading-relaxed{line-height:1.625}.text-\[\#667eea\]{--tw-text-opacity:1;color:rgb(102 126 234 / var(--tw-text-opacity, 1))}.text-\[var\(--accent\)\]{color:var(--accent)}.text-\[var\(--text-secondary\)\]{color:var(--text-secondary)}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235 / var(--tw-text-opacity, 1))}.text-green-600{--tw-text-opacity:1;color:rgb(22 163 74 / var(--tw-text-opacity, 1))}.text-purple-600{--tw-text-opacity:1;color:rgb(147 51 234 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.text-yellow-500{--tw-text-opacity:1;color:rgb(234 179 8 / var(--tw-text-opacity, 1))}.text-blue-500{--tw-text-opacity:1;color:rgb(59 130 246 / var(--tw-text-opacity, 1))}.text-green-500{--tw-text-opacity:1;color:rgb(34 197 94 / var(--tw-text-opacity, 1))}.text-indigo-600{--tw-text-opacity:1;color:rgb(79 70 229 / var(--tw-text-opacity, 1))}.text-purple-500{--tw-text-opacity:1;color:rgb(168 85 247 / var(--tw-text-opacity, 1))}.text-red-600{--tw-text-opacity:1;color:rgb(220 38 38 / var(--tw-text-opacity, 1))}.text-yellow-600{--tw-text-opacity:1;color:rgb(202 138 4 / var(--tw-text-opacity, 1))}.text-yellow-700{--tw-text-opacity:1;color:rgb(161 98 7 / var(--tw-text-opacity, 1))}.accent-\[var\(--accent\)\]{accent-color:var(--accent)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-xl{--tw-shadow:0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-2xl{--tw-shadow:0 25px 50px -12px rgb(0 0 0 / 0.25);--tw-shadow-colored:0 25px 50px -12px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.outline-none{outline:2px solid transparent;outline-offset:2px}.backdrop-blur-sm{--tw-backdrop-blur:blur(4px);-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-colors{transition-property:color, background-color, border-color, fill, stroke, -webkit-text-decoration-color;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, -webkit-text-decoration-color;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-transform{transition-property:transform;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.duration-300{transition-duration:300ms}.hover\:border-\[var\(--accent\)\]:hover{border-color:var(--accent)}.hover\:bg-\[var\(--bg-tertiary\)\]:hover{background-color:var(--bg-tertiary)}.hover\:bg-\[var\(--border\)\]:hover{background-color:var(--border)}.hover\:bg-\[var\(--accent-hover\)\]:hover{background-color:var(--accent-hover)}.focus\:border-\[var\(--accent\)\]:focus{border-color:var(--accent)}.focus\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}.active\:scale-95:active{--tw-scale-x:.95;--tw-scale-y:.95;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.disabled\:opacity-50:disabled{opacity:0.5}@media (min-width: 768px){.md\:grid-cols-3{grid-template-columns:repeat(3, minmax(0, 1fr))}}@media (prefers-color-scheme: dark){.dark\:bg-yellow-900\/30{background-color:rgb(113 63 18 / 0.3)}.dark\:text-yellow-300{--tw-text-opacity:1;color:rgb(253 224 71 / var(--tw-text-opacity, 1))}}</style><script src="https://cdn.jsdelivr.net/npm/html2canvas-pro"></script></head>
<body class="h-screen overflow-hidden" style="-webkit-text-size-adjust: 50%;">
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <div id="app" class="flex h-full">
        <aside id="sidebar" class="sidebar flex flex-col border-r border-[var(--border)]">
            <div class="p-4 border-b border-[var(--border)]">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-[#667eea] to-[#764ba2] flex items-center justify-center shadow-lg">
                        <i class="fas fa-robot text-white"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg gradient-text" id="header-title">SahuAI Agent</h1>
                        <p class="text-xs text-[var(--text-secondary)]">Version 3.2</p>
                    </div>
                </div>
            </div>

            <div class="p-3 space-y-2">
                <a href="./sahu-moe.apk" download="" id="btn-install" class="w-full py-2.5 px-4 rounded-xl bg-[var(--bg-tertiary)] border border-[var(--border)] text-[var(--text-secondary)] font-medium text-sm flex items-center justify-center gap-2 hover:bg-[var(--border)] transition-colors active:scale-95" style="text-decoration: none;">
                    <i class="fab fa-android text-green-600"></i>
                    <span>Install Android App</span>
                </a>
                <button onclick="newChat()" id="btn-new-chat" class="w-full py-3 px-4 rounded-xl bg-gradient-to-r from-[#667eea] to-[#764ba2] text-white font-semibold flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-transform"><i class="fas fa-plus"></i> New Chat</button>
            </div>

            <!-- PINNED MESSAGES -->
            <div id="pinnedSection" class="px-3 pb-2 hidden">
                <label class="text-xs text-[var(--text-secondary)] mb-2 block font-medium">Pinned</label>
                <div id="pinnedList" class="space-y-1"></div>
            </div>

            <!-- HISTORY LIST (Maximized) -->
            <div class="flex-1 overflow-y-auto scrollbar-thin px-3 min-h-0 flex flex-col">
                 <div class="mb-2 relative mt-2">
                     <input type="text" id="historySearch" placeholder="Search chats..." class="w-full p-2 rounded-lg bg-[var(--bg-tertiary)] text-xs border border-[var(--border)] outline-none" oninput="filterHistory(this.value)" __gchrome_uniqueid="1">
                </div>
                <div id="chatHistory" class="space-y-1 flex-1 overflow-y-auto"><div onclick="loadChat('1771184816971')" class="p-3 rounded-xl hover:bg-[var(--bg-tertiary)] cursor-pointer flex items-center gap-3 active:scale-98"><i class="fas fa-message text-[var(--text-secondary)]"></i><span class="text-sm truncate flex-1">Convert to pptx</span></div><div onclick="loadChat('1771184716065')" class="p-3 rounded-xl hover:bg-[var(--bg-tertiary)] cursor-pointer flex items-center gap-3 active:scale-98"><i class="fas fa-message text-[var(--text-secondary)]"></i><span class="text-sm truncate flex-1">Convert into pptx</span></div></div>
            </div>

            <!-- BOTTOM ACTIONS -->
            <div class="p-3 border-t border-[var(--border)] space-y-2">
                 <button onclick="openModelSelector()" id="btn-config-models" class="w-full py-2 px-4 rounded-xl bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm flex items-center justify-between active:scale-95 transition-transform">
                    <span class="flex items-center gap-2">
                        <i class="fas fa-cubes text-[var(--accent)]"></i>
                        Configure Models
                    </span>
                    <span id="selectedModelCount" class="text-xs bg-[var(--accent)] text-white px-2 py-0.5 rounded-full">16</span>
                </button>
                <button onclick="openSettings()" id="btn-settings" class="w-full py-3 px-4 rounded-xl hover:bg-[var(--bg-tertiary)] flex items-center gap-3 transition-colors active:scale-95 border border-[var(--border)]">
                    <i class="fas fa-cog text-[var(--text-secondary)]"></i>
                    <span class="text-sm">Settings</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full min-w-0 transition-all duration-300">
            <header class="h-14 border-b border-[var(--border)] flex items-center justify-between px-4 bg-[var(--bg-secondary)]">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="p-2 rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors active:scale-95" id="sidebarToggleBtn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-robot text-[var(--accent)]"></i>
                        <span class="font-semibold text-sm">SahuAI Agent v3.2</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                     <!-- Token Counter -->
                    <div id="tokenCounter" class="token-counter" title="Session Tokens">0</div>

                    <!-- Mode Selector -->
                    <select id="modeSelector" class="bg-[var(--bg-tertiary)] text-xs rounded-lg p-1.5 border border-[var(--border)] outline-none font-medium" onchange="updateMode(this.value)" __gchrome_uniqueid="2">
                        <option value="standard"> Standard</option>
                        <option value="task"> Task / Code</option>
                        <option value="research"> Deep Research</option>
                        <!-- Removed Search option -->
                    </select>
                    
                    <button onclick="shareConversation()" id="shareBtn" class="hidden p-2 rounded-lg bg-[var(--bg-tertiary)] hover:bg-[var(--border)] transition-colors text-xs font-medium">
                        <i class="fas fa-share-alt"></i> Share
                    </button>

                    <div id="connectionStatus" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-[var(--bg-tertiary)]">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        <span class="text-xs">Ready</span>
                    </div>
                </div>
            </header>

            <div id="chatArea" class="flex-1 overflow-y-auto scrollbar-thin p-4">
                <div id="welcomeScreen" class="h-full flex flex-col items-center justify-center px-4 overflow-y-auto">
                    <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-[#667eea] to-[#764ba2] flex items-center justify-center mb-6 shadow-xl">
                        <i class="fas fa-robot text-2xl text-white"></i>
                    </div>
                    <h2 class="text-xl font-bold mb-2 gradient-text text-center">SahuAI Agent v3.2</h2>
                    <p class="text-[var(--text-secondary)] mb-4 text-center text-sm max-w-md">
                        Official Saksham Intelligence AI Models Chat
                    </p>
                    <div class="flex flex-wrap justify-center gap-2 mb-6 max-w-2xl">
                        <!-- Provider Badges -->
                        <span class="provider-badge provider-nvidia">Saksham Intelligence</span>
                        <span class="provider-badge provider-sambanova">SambaNova</span>
                        <span class="provider-badge provider-huggingface">HuggingFace</span>
                        <span class="provider-badge provider-openrouter">OpenRouter</span>
                        <span class="provider-badge provider-groq">Groq</span>
                        <span class="provider-badge provider-together">Together</span>
                        <span class="provider-badge provider-cerebras">Cerebras</span>
                        <span class="provider-badge provider-fireworks">Fireworks</span>
                        <span class="provider-badge provider-routeway">Routeway</span>
                        <span class="provider-badge provider-mistral">Mistral</span>
                        <span class="provider-badge provider-gemini">Gemini</span>
                        <span class="provider-badge provider-longcat">LongCat</span>
                        <span class="provider-badge provider-ollama">Ollama Cloud</span>
                        <span class="provider-badge provider-zenmusk">ZenMusk</span>
                        <span class="provider-badge provider-ionet">io.net</span>
                    </div>
                    
                    <!-- WHY CHOOSE SECTION -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 w-full max-w-2xl mb-6">
                        <div class="p-3 rounded-xl bg-[var(--bg-tertiary)] border border-[var(--border)] text-center hover:border-[var(--accent)] transition-colors">
                            <div class="w-8 h-8 mx-auto bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-2"><i class="fas fa-globe"></i></div>
                            <h3 class="font-bold text-xs mb-1">Real-Time Search</h3>
                            <p class="text-[10px] text-[var(--text-secondary)]">20+ Engines including Google, Perplexity &amp; Reddit</p>
                        </div>
                        <div class="p-3 rounded-xl bg-[var(--bg-tertiary)] border border-[var(--border)] text-center hover:border-[var(--accent)] transition-colors">
                            <div class="w-8 h-8 mx-auto bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mb-2"><i class="fas fa-project-diagram"></i></div>
                            <h3 class="font-bold text-xs mb-1">MoE Architecture</h3>
                            <p class="text-[10px] text-[var(--text-secondary)]">Advanced consensus engine with multi-stage thinking</p>
                        </div>
                        <div class="p-3 rounded-xl bg-[var(--bg-tertiary)] border border-[var(--border)] text-center hover:border-[var(--accent)] transition-colors">
                            <div class="w-8 h-8 mx-auto bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-2"><i class="fas fa-network-wired"></i></div>
                            <h3 class="font-bold text-xs mb-1">Massive Parallelism</h3>
                            <p class="text-[10px] text-[var(--text-secondary)]">Run up to 50 models simultaneously</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-3 w-full max-w-md">
                        <button onclick="quickPrompt('Build a modern landing page with hero section')" class="p-4 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--border)] text-left transition-all active:scale-98">
                            <i class="fas fa-code text-[#667eea] mb-2"></i>
                            <p class="text-sm font-medium">Task: Landing Page</p>
                            <p class="text-xs text-[var(--text-secondary)]">Generates Vibe Code &amp; Agentic Code</p>
                        </button>
                        <button onclick="quickPrompt('Research the latest breakthroughs in Fusion Energy')" class="p-4 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--border)] text-left transition-all active:scale-98">
                            <i class="fas fa-brain text-yellow-500 mb-2"></i>
                            <p class="text-sm font-medium">Deep Research</p>
                            <p class="text-xs text-[var(--text-secondary)]">Multi-step autonomous investigation</p>
                        </button>
                    </div>
                </div>

                <div id="messagesContainer" class="hidden space-y-4 max-w-4xl mx-auto"></div>
            </div>

            <div class="p-3 border-t border-[var(--border)] bg-[var(--bg-secondary)] safe-area-bottom">
                <div class="max-w-3xl mx-auto">
                    <div id="fileUploadPreview" class="hidden mb-3"></div>
                    <div class="input-area rounded-2xl border p-3 shadow-sm relative">
                        <div class="flex items-end gap-3">
                            <button onclick="triggerFileUpload()" class="p-2 rounded-xl hover:bg-[var(--bg-tertiary)] text-[var(--text-secondary)] transition-colors active:scale-95" title="Upload file">
                                <i class="fas fa-paperclip text-lg"></i>
                            </button>
                            <button onclick="toggleDeepThink()" id="deepThinkBtn" class="p-2 rounded-xl hover:bg-[var(--bg-tertiary)] text-[var(--text-secondary)] transition-colors active:scale-95" title="Toggle Deepthink (Force Chain of Thought)">
                                <i class="fas fa-brain"></i>
                            </button>
                             <!-- TASK TYPE BUTTON -->
                             <button onclick="toggleTaskType()" id="taskTypeBtn" class="hidden p-2 rounded-xl task-btn-vibe transition-all active:scale-95 font-bold text-xs flex items-center gap-1" title="Toggle Code Mode">
                                <i class="fas fa-laptop-code"></i> <span id="taskTypeLabel">VIBE</span>
                            </button>
                            <input type="file" id="fileInput" class="hidden" accept=".txt,.pdf,.doc,.docx,.md,.json,.csv,.js,.py,.html,.css,.png,.jpg,.jpeg,.xlsx,.pptx" onchange="handleFileUpload(event)">
                            <textarea id="userInput" placeholder="Ask anything..." class="flex-1 bg-transparent resize-none outline-none max-h-32 text-base leading-relaxed" rows="1" onkeydown="handleKeyDown(event)" oninput="autoResize(this)" __gchrome_uniqueid="3"></textarea>
                            <button onclick="sendMessage()" id="sendBtn" class="p-3 rounded-xl bg-gradient-to-r from-[#667eea] to-[#764ba2] text-white transition-all disabled:opacity-50 active:scale-95 shadow-lg">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-center text-[var(--text-secondary)] mt-2">
                        Parallel Execution  Default Web Search  Deep Research
                    </p>
                </div>
            </div>
        </main>
    </div>

    <!-- Canvas / Artifact Modal -->
    <div id="artifactModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="canvas-container w-full max-w-6xl">
            <div class="canvas-header">
                <div class="flex items-center gap-3">
                    <i class="fas fa-code text-[var(--accent)]"></i>
                    <span class="font-bold text-sm">Artifact Preview</span>
                </div>
                <div class="flex items-center gap-3">
                    <div class="canvas-tabs">
                        <div class="canvas-tab" id="tab-code" onclick="switchCanvasTab('code')">Code</div>
                        <div class="canvas-tab active" id="tab-preview" onclick="switchCanvasTab('preview')">Preview</div>
                    </div>
                    <button onclick="closeArtifact()" class="p-2 hover:bg-[var(--border)] rounded-lg transition-colors"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="canvas-body">
                <div id="canvas-editor" class="canvas-editor">
                    <textarea id="canvas-code-area" spellcheck="false" __gchrome_uniqueid="4"></textarea>
                </div>
                <div id="canvas-preview" class="canvas-preview active">
                    <iframe id="canvas-frame" class="preview-frame" sandbox="allow-scripts allow-forms allow-same-origin allow-modals" __gchrome_childframeremotetoken="a315743eb3f9f548cf0868f55be19c81"></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl w-full max-w-lg max-h-[85vh] overflow-hidden shadow-2xl flex flex-col transition-all">
            
            <!-- Header -->
            <div class="flex items-center justify-between p-4 border-b border-[var(--border)]">
                <h2 class="text-lg font-bold flex items-center gap-2" id="settingsTitle">Appearance</h2>
                <div class="flex gap-2">
                    <button onclick="navigateSettings('main')" id="settingsBackBtn" class="p-2 rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors text-sm">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button onclick="closeSettings()" class="p-2 rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-4 space-y-4 overflow-y-auto flex-1 relative">
                
                <!-- MAIN MENU -->
                <div id="settings-main" class="settings-view space-y-3">
                     <button onclick="navigateSettings('appearance')" class="w-full py-4 px-4 rounded-xl bg-[var(--bg-tertiary)] border border-[var(--border)] flex items-center justify-between hover:bg-[var(--border)] transition-colors text-left">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fas fa-paint-brush"></i></div>
                            <div>
                                <div class="font-medium text-sm">Appearance &amp; Language</div>
                                <div class="text-xs text-[var(--text-secondary)]">Theme, Language, UI</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-[var(--text-secondary)]"></i>
                    </button>

                    <button onclick="navigateSettings('search')" class="w-full py-4 px-4 rounded-xl bg-[var(--bg-tertiary)] border border-[var(--border)] flex items-center justify-between hover:bg-[var(--border)] transition-colors text-left">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center"><i class="fas fa-search"></i></div>
                            <div>
                                <div class="font-medium text-sm">Search Engines</div>
                                <div class="text-xs text-[var(--text-secondary)]">Sources &amp; Fallback</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-[var(--text-secondary)]"></i>
                    </button>

                    <button onclick="navigateSettings('pipeline')" class="w-full py-4 px-4 rounded-xl bg-[var(--bg-tertiary)] border border-[var(--border)] flex items-center justify-between hover:bg-[var(--border)] transition-colors text-left">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center"><i class="fas fa-sliders-h"></i></div>
                            <div>
                                <div class="font-medium text-sm">Pipeline Strategy</div>
                                <div class="text-xs text-[var(--text-secondary)]">Consensus, Fallback, Safety</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-[var(--text-secondary)]"></i>
                    </button>
                    
                    <button onclick="navigateSettings('providers')" class="w-full py-4 px-4 rounded-xl bg-[var(--bg-tertiary)] border border-[var(--border)] flex items-center justify-between hover:bg-[var(--border)] transition-colors text-left">
                         <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center"><i class="fas fa-network-wired"></i></div>
                            <div>
                                <div class="font-medium text-sm">Active Providers</div>
                                <div class="text-xs text-[var(--text-secondary)]">Toggle AI Services</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-[var(--text-secondary)]"></i>
                    </button>

                    <button onclick="navigateSettings('keys')" class="w-full py-4 px-4 rounded-xl bg-[var(--bg-tertiary)] border border-[var(--border)] flex items-center justify-between hover:bg-[var(--border)] transition-colors text-left">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center"><i class="fas fa-key"></i></div>
                            <div>
                                <div class="font-medium text-sm">API Keys</div>
                                <div class="text-xs text-[var(--text-secondary)]">Manage your credentials</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-[var(--text-secondary)]"></i>
                    </button>

                     <button onclick="navigateSettings('instructions')" class="w-full py-4 px-4 rounded-xl bg-[var(--bg-tertiary)] border border-[var(--border)] flex items-center justify-between hover:bg-[var(--border)] transition-colors text-left">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center"><i class="fas fa-user-edit"></i></div>
                            <div>
                                <div class="font-medium text-sm">Custom Instructions</div>
                                <div class="text-xs text-[var(--text-secondary)]">System prompts &amp; Persona</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-[var(--text-secondary)]"></i>
                    </button>
                </div>

                <!-- SUB MENUS -->
                <div id="settings-appearance" class="settings-view space-y-3 active">
                    
                    <!-- PERPLEXITY MODE TOGGLE -->
                    <button onclick="togglePerplexityMode()" class="w-full p-4 rounded-xl bg-[var(--bg-tertiary)] border border-[var(--border)] flex items-center justify-between">
                         <span class="flex items-center gap-2">
                             <div class="w-6 h-6 rounded-full bg-teal-500 text-white flex items-center justify-center text-xs"><i class="fas fa-search"></i></div>
                             <span class="font-medium text-sm">Perplexity Mode</span>
                         </span>
                         <span id="perplexityModeText" class="text-xs bg-[var(--bg-secondary)] px-2 py-1 rounded border border-[var(--border)]">Disabled</span>
                    </button>

                    <div class="p-4 rounded-xl bg-[var(--bg-tertiary)] border border-[var(--border)]">
                        <label class="block text-sm font-medium mb-2">Interface &amp; Response Language</label>
                        <select id="languageSelector" class="w-full p-2.5 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border)] text-sm outline-none" onchange="updateLanguage(this.value)" __gchrome_uniqueid="5"><option value="en" selected="">English</option><option value="es">Spanish</option><option value="fr">French</option><option value="de">German</option><option value="it">Italian</option><option value="pt">Portuguese</option><option value="zh">Chinese</option><option value="ja">Japanese</option><option value="ko">Korean</option><option value="ru">Russian</option><option value="hi">Hindi</option><option value="ar">Arabic</option><option value="bn">Bengali</option><option value="pa">Punjabi</option><option value="jv">Javanese</option><option value="vi">Vietnamese</option><option value="te">Telugu</option><option value="mr">Marathi</option><option value="ta">Tamil</option><option value="ur">Urdu</option><option value="tr">Turkish</option><option value="fa">Persian</option><option value="gu">Gujarati</option><option value="pl">Polish</option><option value="uk">Ukrainian</option><option value="ro">Romanian</option><option value="nl">Dutch</option><option value="el">Greek</option><option value="hu">Hungarian</option><option value="sv">Swedish</option><option value="cs">Czech</option><option value="th">Thai</option><option value="id">Indonesian</option><option value="ms">Malay</option><option value="da">Danish</option><option value="fi">Finnish</option><option value="no">Norwegian</option><option value="he">Hebrew</option><option value="bg">Bulgarian</option><option value="hr">Croatian</option><option value="sr">Serbian</option><option value="sk">Slovak</option><option value="sl">Slovenian</option><option value="et">Estonian</option><option value="lv">Latvian</option><option value="lt">Lithuanian</option><option value="af">Afrikaans</option><option value="sw">Swahili</option><option value="ca">Catalan</option><option value="eu">Basque</option><option value="gl">Galician</option><option value="is">Icelandic</option><option value="ga">Irish</option><option value="sq">Albanian</option><option value="mk">Macedonian</option><option value="bs">Bosnian</option><option value="cy">Welsh</option><option value="hy">Armenian</option><option value="ka">Georgian</option><option value="be">Belarusian</option><option value="az">Azerbaijani</option><option value="kk">Kazakh</option><option value="ky">Kyrgyz</option><option value="uz">Uzbek</option><option value="tk">Turkmen</option><option value="tg">Tajik</option><option value="mn">Mongolian</option><option value="ne">Nepali</option><option value="si">Sinhala</option><option value="my">Burmese</option><option value="km">Khmer</option><option value="lo">Lao</option><option value="am">Amharic</option><option value="so">Somali</option><option value="yo">Yoruba</option><option value="ig">Igbo</option><option value="ha">Hausa</option><option value="zu">Zulu</option><option value="xh">Xhosa</option><option value="st">Sotho</option><option value="fil">Filipino</option><option value="mg">Malagasy</option><option value="ny">Chichewa</option><option value="sn">Shona</option><option value="co">Corsican</option><option value="fy">Frisian</option><option value="gd">Scots Gaelic</option><option value="ht">Haitian Creole</option><option value="haw">Hawaiian</option><option value="hmn">Hmong</option><option value="jw">Javanese</option><option value="kn">Kannada</option><option value="ku">Kurdish</option><option value="lb">Luxembourgish</option><option value="mi">Maori</option><option value="ml">Malayalam</option><option value="mt">Maltese</option><option value="ps">Pashto</option><option value="sd">Sindhi</option><option value="sm">Samoan</option><option value="su">Sundanese</option><option value="yi">Yiddish</option></select>
                        <p class="text-xs text-[var(--text-secondary)] mt-1">Changes UI text and instructs models to respond in this language.</p>
                    </div>

                    <button onclick="toggleTheme()" class="w-full p-4 rounded-xl bg-[var(--bg-tertiary)] border border-[var(--border)] flex items-center justify-between">
                         <span class="flex items-center gap-2"><i id="themeIcon" class="fas fa-moon"></i> Toggle Dark Mode</span>
                         <span id="themeText" class="text-xs bg-[var(--bg-secondary)] px-2 py-1 rounded">Light</span>
                    </button>
                    <button onclick="openSourceCode()" class="w-full p-4 rounded-xl bg-[var(--bg-tertiary)] border border-[var(--border)] flex items-center justify-between">
                         <span class="flex items-center gap-2"><i class="fas fa-code"></i> View Source Code</span>
                    </button>
                </div>

                <div id="settings-search" class="settings-view space-y-3">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-xs text-[var(--text-secondary)]">Enable independent search sources.</p>
                        <button onclick="toggleAllSearchEngines()" class="text-xs bg-[var(--accent)] text-white px-2 py-1 rounded">Select All</button>
                    </div>
                    <div id="searchEngineList" class="grid grid-cols-1 gap-2 max-h-60 overflow-y-auto">
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('wikipedia', this.checked)">
                    <div class="flex-1 text-sm font-medium">Wikipedia <span class="text-[10px] text-[var(--text-secondary)]">(API)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('reddit', this.checked)">
                    <div class="flex-1 text-sm font-medium">Reddit <span class="text-[10px] text-[var(--text-secondary)]">(API)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('google', this.checked)">
                    <div class="flex-1 text-sm font-medium">Google <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('bing', this.checked)">
                    <div class="flex-1 text-sm font-medium">Bing <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('duckduckgo', this.checked)">
                    <div class="flex-1 text-sm font-medium">DuckDuckGo <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('yahoo', this.checked)">
                    <div class="flex-1 text-sm font-medium">Yahoo <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('yandex', this.checked)">
                    <div class="flex-1 text-sm font-medium">Yandex <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('qwant', this.checked)">
                    <div class="flex-1 text-sm font-medium">Qwant <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('brave', this.checked)">
                    <div class="flex-1 text-sm font-medium">Brave <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('startpage', this.checked)">
                    <div class="flex-1 text-sm font-medium">Startpage <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('baidu', this.checked)">
                    <div class="flex-1 text-sm font-medium">Baidu (English) <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('youtube', this.checked)">
                    <div class="flex-1 text-sm font-medium">YouTube <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('twitter', this.checked)">
                    <div class="flex-1 text-sm font-medium">X (Twitter) <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('copilot', this.checked)">
                    <div class="flex-1 text-sm font-medium">Microsoft Copilot <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('chatgpt', this.checked)">
                    <div class="flex-1 text-sm font-medium">ChatGPT <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('chatglm', this.checked)">
                    <div class="flex-1 text-sm font-medium">ChatGLM <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('gemini', this.checked)">
                    <div class="flex-1 text-sm font-medium">Gemini <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('deepseek', this.checked)">
                    <div class="flex-1 text-sm font-medium">DeepSeek <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('qwen', this.checked)">
                    <div class="flex-1 text-sm font-medium">Qwen <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('kimi', this.checked)">
                    <div class="flex-1 text-sm font-medium">Kimi <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('mistral', this.checked)">
                    <div class="flex-1 text-sm font-medium">Mistral <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('grok', this.checked)">
                    <div class="flex-1 text-sm font-medium">Grok <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('minimax', this.checked)">
                    <div class="flex-1 text-sm font-medium">MiniMax <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('ernie', this.checked)">
                    <div class="flex-1 text-sm font-medium">ERNIE <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('perplexity', this.checked)">
                    <div class="flex-1 text-sm font-medium">Perplexity <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('discord', this.checked)">
                    <div class="flex-1 text-sm font-medium">Discord <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('claude', this.checked)">
                    <div class="flex-1 text-sm font-medium">Claude <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('facebook', this.checked)">
                    <div class="flex-1 text-sm font-medium">Facebook <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" checked="" onchange="toggleSearchEngine('instagram', this.checked)">
                    <div class="flex-1 text-sm font-medium">Instagram <span class="text-[10px] text-[var(--text-secondary)]">(SearXNG)</span></div>
                </label>
            </div>
                </div>

                <div id="settings-pipeline" class="settings-view space-y-4">
                     <div>
                        <label class="text-xs text-[var(--text-secondary)] block mb-1">Consensus Strategy</label>
                        <select id="stageSelector" class="w-full p-3 rounded-xl bg-[var(--bg-tertiary)] text-sm border border-[var(--border)] outline-none" __gchrome_uniqueid="6">
                            <option value="none">Experts Only (Parallel)</option>
                            <option value="1" selected="">Direct Synthesis (Fast)</option>
                            <option value="2">Deep Synthesis (2-Step)</option>
                            <option value="3">Full Chain (3-Step)</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                         <label class="flex items-center justify-between p-3 rounded-xl bg-[var(--bg-tertiary)] cursor-pointer">
                            <span class="text-sm flex items-center gap-2"><i class="fas fa-shield-alt text-green-500"></i> Auto Fallback</span>
                            <input type="checkbox" id="autoFallback" class="w-5 h-5 accent-[var(--accent)]" __gchrome_uniqueid="7">
                        </label>
                        <label class="flex items-center justify-between p-3 rounded-xl bg-[var(--bg-tertiary)] cursor-pointer">
                            <span class="text-sm flex items-center gap-2"><i class="fas fa-user-shield text-blue-500"></i> Shield Gemma</span>
                            <input type="checkbox" id="shieldGemmaCheck" class="w-5 h-5 accent-[var(--accent)]" __gchrome_uniqueid="8">
                        </label>
                        <label class="flex items-center justify-between p-3 rounded-xl bg-[var(--bg-tertiary)] cursor-pointer">
                            <span class="text-sm flex items-center gap-2"><i class="fas fa-vote-yea text-purple-500"></i> Self-Consistency</span>
                            <input type="checkbox" id="selfConsistencyCheck" class="w-5 h-5 accent-[var(--accent)]" __gchrome_uniqueid="9">
                        </label>
                    </div>
                </div>

                <div id="settings-providers" class="settings-view">
                    <div id="providerCheckboxes" class="grid grid-cols-1 gap-2">
                <label class="flex items-center gap-2 p-3 rounded-xl bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors border border-transparent border-[var(--accent)] bg-opacity-50">
                    <input type="checkbox" class="w-5 h-5 accent-[var(--accent)]" checked="" onchange="toggleProvider('nvidia', this.checked)">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 font-medium text-sm"><span></span> Saksham Intelligence</div>
                    </div>
                </label>
                <label class="flex items-center gap-2 p-3 rounded-xl bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors border border-transparent ">
                    <input type="checkbox" class="w-5 h-5 accent-[var(--accent)]" onchange="toggleProvider('sambanova', this.checked)">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 font-medium text-sm"><span></span> SambaNova</div>
                    </div>
                </label>
                <label class="flex items-center gap-2 p-3 rounded-xl bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors border border-transparent ">
                    <input type="checkbox" class="w-5 h-5 accent-[var(--accent)]" onchange="toggleProvider('huggingface', this.checked)">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 font-medium text-sm"><span></span> HuggingFace</div>
                    </div>
                </label>
                <label class="flex items-center gap-2 p-3 rounded-xl bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors border border-transparent ">
                    <input type="checkbox" class="w-5 h-5 accent-[var(--accent)]" onchange="toggleProvider('openrouter', this.checked)">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 font-medium text-sm"><span></span> OpenRouter</div>
                    </div>
                </label>
                <label class="flex items-center gap-2 p-3 rounded-xl bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors border border-transparent ">
                    <input type="checkbox" class="w-5 h-5 accent-[var(--accent)]" onchange="toggleProvider('groq', this.checked)">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 font-medium text-sm"><span></span> Groq</div>
                    </div>
                </label>
                <label class="flex items-center gap-2 p-3 rounded-xl bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors border border-transparent ">
                    <input type="checkbox" class="w-5 h-5 accent-[var(--accent)]" onchange="toggleProvider('together', this.checked)">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 font-medium text-sm"><span></span> Together AI</div>
                    </div>
                </label>
                <label class="flex items-center gap-2 p-3 rounded-xl bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors border border-transparent ">
                    <input type="checkbox" class="w-5 h-5 accent-[var(--accent)]" onchange="toggleProvider('cerebras', this.checked)">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 font-medium text-sm"><span></span> Cerebras</div>
                    </div>
                </label>
                <label class="flex items-center gap-2 p-3 rounded-xl bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors border border-transparent ">
                    <input type="checkbox" class="w-5 h-5 accent-[var(--accent)]" onchange="toggleProvider('fireworks', this.checked)">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 font-medium text-sm"><span></span> Fireworks AI</div>
                    </div>
                </label>
                <label class="flex items-center gap-2 p-3 rounded-xl bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors border border-transparent ">
                    <input type="checkbox" class="w-5 h-5 accent-[var(--accent)]" onchange="toggleProvider('routeway', this.checked)">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 font-medium text-sm"><span></span> Routeway</div>
                    </div>
                </label>
                <label class="flex items-center gap-2 p-3 rounded-xl bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors border border-transparent ">
                    <input type="checkbox" class="w-5 h-5 accent-[var(--accent)]" onchange="toggleProvider('mistral', this.checked)">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 font-medium text-sm"><span></span> Mistral</div>
                    </div>
                </label>
                <label class="flex items-center gap-2 p-3 rounded-xl bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors border border-transparent border-[var(--accent)] bg-opacity-50">
                    <input type="checkbox" class="w-5 h-5 accent-[var(--accent)]" checked="" onchange="toggleProvider('gemini', this.checked)">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 font-medium text-sm"><span></span> Gemini</div>
                    </div>
                </label>
                <label class="flex items-center gap-2 p-3 rounded-xl bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors border border-transparent ">
                    <input type="checkbox" class="w-5 h-5 accent-[var(--accent)]" onchange="toggleProvider('longcat', this.checked)">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 font-medium text-sm"><span></span> LongCat</div>
                    </div>
                </label>
                <label class="flex items-center gap-2 p-3 rounded-xl bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors border border-transparent ">
                    <input type="checkbox" class="w-5 h-5 accent-[var(--accent)]" onchange="toggleProvider('ollama', this.checked)">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 font-medium text-sm"><span></span> Ollama Cloud</div>
                    </div>
                </label>
                <label class="flex items-center gap-2 p-3 rounded-xl bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors border border-transparent ">
                    <input type="checkbox" class="w-5 h-5 accent-[var(--accent)]" onchange="toggleProvider('zenmusk', this.checked)">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 font-medium text-sm"><span></span> ZenMusk</div>
                    </div>
                </label>
                <label class="flex items-center gap-2 p-3 rounded-xl bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors border border-transparent ">
                    <input type="checkbox" class="w-5 h-5 accent-[var(--accent)]" onchange="toggleProvider('ionet', this.checked)">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 font-medium text-sm"><span></span> io.net</div>
                    </div>
                </label></div>
                </div>

                <div id="settings-keys" class="settings-view space-y-3">
                    <div class="p-3 bg-yellow-50 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 text-xs rounded-xl">
                        <i class="fas fa-lock mr-1"></i> Keys are stored locally in your browser.
                    </div>
                    <div id="apiKeyInputs" class="space-y-3">
                <div class="p-2 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border)]">
                    <div class="flex items-center gap-2 mb-1"><span class="text-sm"> Saksham Intelligence</span></div>
                    <input type="password" id="key_nvidia" placeholder="Enter API Key" class="w-full p-2 rounded bg-[var(--bg-primary)] border border-[var(--border)] text-xs focus:border-[var(--accent)] outline-none" __gchrome_uniqueid="45">
                </div>
                <div class="p-2 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border)]">
                    <div class="flex items-center gap-2 mb-1"><span class="text-sm"> SambaNova</span></div>
                    <input type="password" id="key_sambanova" placeholder="Enter API Key" class="w-full p-2 rounded bg-[var(--bg-primary)] border border-[var(--border)] text-xs focus:border-[var(--accent)] outline-none" __gchrome_uniqueid="46">
                </div>
                <div class="p-2 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border)]">
                    <div class="flex items-center gap-2 mb-1"><span class="text-sm"> HuggingFace</span></div>
                    <input type="password" id="key_huggingface" placeholder="Enter API Key" class="w-full p-2 rounded bg-[var(--bg-primary)] border border-[var(--border)] text-xs focus:border-[var(--accent)] outline-none" __gchrome_uniqueid="47">
                </div>
                <div class="p-2 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border)]">
                    <div class="flex items-center gap-2 mb-1"><span class="text-sm"> OpenRouter</span></div>
                    <input type="password" id="key_openrouter" placeholder="Enter API Key" class="w-full p-2 rounded bg-[var(--bg-primary)] border border-[var(--border)] text-xs focus:border-[var(--accent)] outline-none" __gchrome_uniqueid="48">
                </div>
                <div class="p-2 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border)]">
                    <div class="flex items-center gap-2 mb-1"><span class="text-sm"> Groq</span></div>
                    <input type="password" id="key_groq" placeholder="Enter API Key" class="w-full p-2 rounded bg-[var(--bg-primary)] border border-[var(--border)] text-xs focus:border-[var(--accent)] outline-none" __gchrome_uniqueid="49">
                </div>
                <div class="p-2 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border)]">
                    <div class="flex items-center gap-2 mb-1"><span class="text-sm"> Together AI</span></div>
                    <input type="password" id="key_together" placeholder="Enter API Key" class="w-full p-2 rounded bg-[var(--bg-primary)] border border-[var(--border)] text-xs focus:border-[var(--accent)] outline-none" __gchrome_uniqueid="50">
                </div>
                <div class="p-2 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border)]">
                    <div class="flex items-center gap-2 mb-1"><span class="text-sm"> Cerebras</span></div>
                    <input type="password" id="key_cerebras" placeholder="Enter API Key" class="w-full p-2 rounded bg-[var(--bg-primary)] border border-[var(--border)] text-xs focus:border-[var(--accent)] outline-none" __gchrome_uniqueid="51">
                </div>
                <div class="p-2 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border)]">
                    <div class="flex items-center gap-2 mb-1"><span class="text-sm"> Fireworks AI</span></div>
                    <input type="password" id="key_fireworks" placeholder="Enter API Key" class="w-full p-2 rounded bg-[var(--bg-primary)] border border-[var(--border)] text-xs focus:border-[var(--accent)] outline-none" __gchrome_uniqueid="52">
                </div>
                <div class="p-2 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border)]">
                    <div class="flex items-center gap-2 mb-1"><span class="text-sm"> Routeway</span></div>
                    <input type="password" id="key_routeway" placeholder="Enter API Key" class="w-full p-2 rounded bg-[var(--bg-primary)] border border-[var(--border)] text-xs focus:border-[var(--accent)] outline-none" __gchrome_uniqueid="53">
                </div>
                <div class="p-2 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border)]">
                    <div class="flex items-center gap-2 mb-1"><span class="text-sm"> Mistral</span></div>
                    <input type="password" id="key_mistral" placeholder="Enter API Key" class="w-full p-2 rounded bg-[var(--bg-primary)] border border-[var(--border)] text-xs focus:border-[var(--accent)] outline-none" __gchrome_uniqueid="54">
                </div>
                <div class="p-2 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border)]">
                    <div class="flex items-center gap-2 mb-1"><span class="text-sm"> Gemini</span></div>
                    <input type="password" id="key_gemini" placeholder="Enter API Key" class="w-full p-2 rounded bg-[var(--bg-primary)] border border-[var(--border)] text-xs focus:border-[var(--accent)] outline-none" __gchrome_uniqueid="55">
                </div>
                <div class="p-2 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border)]">
                    <div class="flex items-center gap-2 mb-1"><span class="text-sm"> LongCat</span></div>
                    <input type="password" id="key_longcat" placeholder="Enter API Key" class="w-full p-2 rounded bg-[var(--bg-primary)] border border-[var(--border)] text-xs focus:border-[var(--accent)] outline-none" __gchrome_uniqueid="56">
                </div>
                <div class="p-2 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border)]">
                    <div class="flex items-center gap-2 mb-1"><span class="text-sm"> Ollama Cloud</span></div>
                    <input type="password" id="key_ollama" placeholder="Enter API Key" class="w-full p-2 rounded bg-[var(--bg-primary)] border border-[var(--border)] text-xs focus:border-[var(--accent)] outline-none" __gchrome_uniqueid="57">
                </div>
                <div class="p-2 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border)]">
                    <div class="flex items-center gap-2 mb-1"><span class="text-sm"> ZenMusk</span></div>
                    <input type="password" id="key_zenmusk" placeholder="Enter API Key" class="w-full p-2 rounded bg-[var(--bg-primary)] border border-[var(--border)] text-xs focus:border-[var(--accent)] outline-none" __gchrome_uniqueid="58">
                </div>
                <div class="p-2 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border)]">
                    <div class="flex items-center gap-2 mb-1"><span class="text-sm"> io.net</span></div>
                    <input type="password" id="key_ionet" placeholder="Enter API Key" class="w-full p-2 rounded bg-[var(--bg-primary)] border border-[var(--border)] text-xs focus:border-[var(--accent)] outline-none" __gchrome_uniqueid="59">
                </div></div>
                </div>

                <div id="settings-instructions" class="settings-view space-y-3">
                    <div>
                        <label class="font-medium text-sm block mb-1">User Info</label>
                        <textarea id="customInstructionsUser" placeholder="What should SAHU know about you?" class="w-full p-3 text-xs rounded-xl bg-[var(--bg-tertiary)] border border-[var(--border)] h-24" __gchrome_uniqueid="40"></textarea>
                    </div>
                    <div>
                        <label class="font-medium text-sm block mb-1">Response Style</label>
                        <textarea id="customInstructionsResp" placeholder="How should SAHU respond?" class="w-full p-3 text-xs rounded-xl bg-[var(--bg-tertiary)] border border-[var(--border)] h-24" __gchrome_uniqueid="41"></textarea>
                    </div>
                     <div class="grid grid-cols-2 gap-3 mt-4">
                         <div>
                             <label class="text-xs text-[var(--text-secondary)] block mb-1">Temperature</label>
                             <input type="number" id="settingTemp" step="0.1" min="0" max="2" value="0.7" class="w-full p-2 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-xs" __gchrome_uniqueid="42">
                         </div>
                         <div>
                             <label class="text-xs text-[var(--text-secondary)] block mb-1">Default Max Tokens</label>
                             <input type="number" id="settingMaxTokens" step="1000" min="1000" value="8000" class="w-full p-2 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-xs" __gchrome_uniqueid="43">
                         </div>
                     </div>
                </div>

            </div>

            <div class="p-4 border-t border-[var(--border)] flex justify-end gap-3">
                <button onclick="closeSettings()" class="px-4 py-2.5 rounded-xl hover:bg-[var(--bg-tertiary)] transition-colors text-sm">Cancel</button>
                <button onclick="saveSettings()" class="px-5 py-2.5 rounded-xl bg-gradient-to-r from-[#667eea] to-[#764ba2] text-white font-medium text-sm active:scale-95">
                    <i class="fas fa-save mr-2"></i>Save All
                </button>
            </div>
        </div>
    </div>

    <div id="sourceCodeModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl w-full max-w-4xl max-h-[85vh] overflow-hidden shadow-2xl flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-[var(--border)]">
                <h2 class="text-lg font-bold flex items-center gap-2"><i class="fas fa-code text-[var(--accent)]"></i> App Source Code</h2>
                <button onclick="closeSourceCode()" class="p-2 rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 flex-1 overflow-hidden flex flex-col">
                 <div class="flex items-center justify-between mb-2">
                    <p class="text-xs text-[var(--text-secondary)]">Single file application.</p>
                    <button onclick="copySourceCode()" class="text-xs bg-[var(--accent)] text-white px-3 py-1.5 rounded-lg hover:bg-[var(--accent-hover)] transition-colors"><i class="fas fa-copy mr-1"></i> Copy All</button>
                </div>
                <textarea id="sourceCodeViewer" readonly="" class="w-full flex-1 p-3 text-xs font-mono bg-[var(--bg-tertiary)] border border-[var(--border)] rounded-xl resize-none focus:outline-none focus:border-[var(--accent)]" onclick="this.select()" __gchrome_uniqueid="44"></textarea>
            </div>
            <div class="p-4 border-t border-[var(--border)] flex justify-end">
                 <button onclick="closeSourceCode()" class="px-5 py-2.5 rounded-xl bg-gradient-to-r from-[#667eea] to-[#764ba2] text-white font-medium text-sm active:scale-95">Close</button>
            </div>
        </div>
    </div>

    <div id="modelSelectorModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl w-full max-w-4xl max-h-[85vh] overflow-hidden shadow-2xl flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-[var(--border)]">
                <h2 class="text-lg font-bold flex items-center gap-2"><i class="fas fa-cubes text-[var(--accent)]"></i> Model Configuration</h2>
                <button onclick="closeModelSelector()" class="p-2 rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 overflow-y-auto flex-1">
                <p class="text-sm text-[var(--text-secondary)] mb-4">Select models and assign aggregator stages (1/2/3). Use "Select All" to quickly select active provider models.</p>
                <div id="modelSelectorContent" class="space-y-4"></div>
            </div>
            <div class="p-4 border-t border-[var(--border)] flex justify-between items-center gap-3">
                <div class="text-sm text-[var(--text-secondary)]"><span id="modalSelectedCount">0</span> selected</div>
                <div class="flex gap-3">
                    <button onclick="closeModelSelector()" class="px-4 py-2.5 rounded-xl hover:bg-[var(--bg-tertiary)] transition-colors text-sm">Cancel</button>
                    <button onclick="saveModelSelection()" class="px-5 py-2.5 rounded-xl bg-gradient-to-r from-[#667eea] to-[#764ba2] text-white font-medium text-sm active:scale-95"><i class="fas fa-check mr-2"></i>Apply</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ... (Languages, Translations, Configs, Providers remain unchanged) ...
        const LANGUAGES = [
            {code:'en',name:'English'},{code:'es',name:'Spanish'},{code:'fr',name:'French'},{code:'de',name:'German'},{code:'it',name:'Italian'},{code:'pt',name:'Portuguese'},{code:'zh',name:'Chinese'},{code:'ja',name:'Japanese'},{code:'ko',name:'Korean'},{code:'ru',name:'Russian'},
            {code:'hi',name:'Hindi'},{code:'ar',name:'Arabic'},{code:'bn',name:'Bengali'},{code:'pa',name:'Punjabi'},{code:'jv',name:'Javanese'},{code:'vi',name:'Vietnamese'},{code:'te',name:'Telugu'},{code:'mr',name:'Marathi'},{code:'ta',name:'Tamil'},{code:'ur',name:'Urdu'},
            {code:'tr',name:'Turkish'},{code:'fa',name:'Persian'},{code:'gu',name:'Gujarati'},{code:'pl',name:'Polish'},{code:'uk',name:'Ukrainian'},{code:'ro',name:'Romanian'},{code:'nl',name:'Dutch'},{code:'el',name:'Greek'},{code:'hu',name:'Hungarian'},{code:'sv',name:'Swedish'},
            {code:'cs',name:'Czech'},{code:'th',name:'Thai'},{code:'id',name:'Indonesian'},{code:'ms',name:'Malay'},{code:'da',name:'Danish'},{code:'fi',name:'Finnish'},{code:'no',name:'Norwegian'},{code:'he',name:'Hebrew'},{code:'bg',name:'Bulgarian'},{code:'hr',name:'Croatian'},
            {code:'sr',name:'Serbian'},{code:'sk',name:'Slovak'},{code:'sl',name:'Slovenian'},{code:'et',name:'Estonian'},{code:'lv',name:'Latvian'},{code:'lt',name:'Lithuanian'},{code:'af',name:'Afrikaans'},{code:'sw',name:'Swahili'},{code:'ca',name:'Catalan'},{code:'eu',name:'Basque'},
            {code:'gl',name:'Galician'},{code:'is',name:'Icelandic'},{code:'ga',name:'Irish'},{code:'sq',name:'Albanian'},{code:'mk',name:'Macedonian'},{code:'bs',name:'Bosnian'},{code:'cy',name:'Welsh'},{code:'hy',name:'Armenian'},{code:'ka',name:'Georgian'},{code:'be',name:'Belarusian'},
            {code:'az',name:'Azerbaijani'},{code:'kk',name:'Kazakh'},{code:'ky',name:'Kyrgyz'},{code:'uz',name:'Uzbek'},{code:'tk',name:'Turkmen'},{code:'tg',name:'Tajik'},{code:'mn',name:'Mongolian'},{code:'ne',name:'Nepali'},{code:'si',name:'Sinhala'},{code:'my',name:'Burmese'},
            {code:'km',name:'Khmer'},{code:'lo',name:'Lao'},{code:'am',name:'Amharic'},{code:'so',name:'Somali'},{code:'yo',name:'Yoruba'},{code:'ig',name:'Igbo'},{code:'ha',name:'Hausa'},{code:'zu',name:'Zulu'},{code:'xh',name:'Xhosa'},{code:'st',name:'Sotho'},
            {code:'fil',name:'Filipino'},{code:'mg',name:'Malagasy'},{code:'ny',name:'Chichewa'},{code:'sn',name:'Shona'},{code:'co',name:'Corsican'},{code:'fy',name:'Frisian'},{code:'gd',name:'Scots Gaelic'},{code:'ht',name:'Haitian Creole'},{code:'haw',name:'Hawaiian'},{code:'hmn',name:'Hmong'},
            {code:'jw',name:'Javanese'},{code:'kn',name:'Kannada'},{code:'ku',name:'Kurdish'},{code:'lb',name:'Luxembourgish'},{code:'mi',name:'Maori'},{code:'ml',name:'Malayalam'},{code:'mt',name:'Maltese'},{code:'ps',name:'Pashto'},{code:'sd',name:'Sindhi'},{code:'sm',name:'Samoan'},
            {code:'su',name:'Sundanese'},{code:'yi',name:'Yiddish'}
        ];

        const UI_TRANSLATIONS = {
            'es': { 'newChat': 'Nuevo Chat', 'settings': 'Ajustes', 'install': 'Instalar App', 'send': 'Enviar', 'config': 'Configurar Modelos' },
            'fr': { 'newChat': 'Nouvelle Chat', 'settings': 'Paramtres', 'install': 'Installer App', 'send': 'Envoyer', 'config': 'Configurer Modles' },
            'de': { 'newChat': 'Neuer Chat', 'settings': 'Einstellungen', 'install': 'App Installieren', 'send': 'Senden', 'config': 'Modelle Konfig.' },
            'hi': { 'newChat': ' ', 'settings': '', 'install': '  ', 'send': '', 'config': '  ' },
            'zh': { 'newChat': '', 'settings': '', 'install': '', 'send': '', 'config': '' },
            'ja': { 'newChat': '', 'settings': '', 'install': '', 'send': '', 'config': '' },
            'ru': { 'newChat': ' ', 'settings': '', 'install': '', 'send': '', 'config': '' },
            'ar': { 'newChat': ' ', 'settings': '', 'install': ' ', 'send': '', 'config': ' ' },
            'pt': { 'newChat': 'Novo Chat', 'settings': 'Configuraes', 'install': 'Instalar App', 'send': 'Enviar', 'config': 'Configurar Modelos' }
        };

        const MODEL_CONFIGS = {
            'sarvamai/sarvam-m': { max_tokens: 30000 }, 'qwen/qwq-32b': { max_tokens: 30000 }, 'qwen/qwen2.5-7b-instruct': { max_tokens: 30000 }, 'mistralai/mamba-codestral-7b-v0.1': { max_tokens: 30000 },
            'google/gemma-3-1b-it': { max_tokens: 30000 }, 'google/gemma-3n-e4b-it': { max_tokens: 30000 }, 'microsoft/phi-4-mini-flash-reasoning': { max_tokens: 60000 },
            'mistralai/mixtral-8x22b-instruct-v0.1': { max_tokens: 60000 }, 
            'google/shieldgemma-9b': { max_tokens: 1000 },
            'google/gemma-7b': { max_tokens: 6000, noSystemRole: true },
            'google/gemma-2-27b-it': { max_tokens: 6000, noSystemRole: true },
            'thudm/chatglm3-6b': { max_tokens: 6000 },
            'nvidia/nemotron-4-mini-hindi-4b-instruct': { max_tokens: 3000 },
            'microsoft/phi-3-medium-4k-instruct': { max_tokens: 3000 },
            // Configured specific models to simulated streaming via noStream:true, with high token limit
            'deepseek-ai/deepseek-r1-distill-qwen-32b': { noStream: true, max_tokens: 30000 },
            'deepseek-ai/deepseek-r1-distill-llama-8b': { noStream: true, max_tokens: 30000 },
            'ibm/granite-3.3-8b-instruct': { noStream: true, max_tokens: 30000 },
            'z-ai/glm4.7': { noStream: true, max_tokens: 30000 }
        };

        const PROVIDERS = {
            nvidia: { name: 'Saksham Intelligence', endpoint: 'https://integrate.api.nvidia.com/v1/chat/completions', keyName: 'sahu_nvidia_key', color: 'nvidia', icon: '', models: { 
                'Cosmos Reason 2 8B': 'nvidia/cosmos-reason2-8b',
                'Phi 3.5 Vision': 'microsoft/phi-3.5-vision-instruct',
                'Stockmark 2 100B': 'stockmark/stockmark-2-100b-instruct',
                'PaliGemma': 'google/paligemma',
                'Llama 3.2 90B Vision': 'meta/llama-3.2-90b-vision-instruct',
                'Nvidia OCDRNet': 'nvidia/ocdrnet',
                'Nemo Retriever OCR': 'nvidia/nemoretriever-ocr-v1',
                'GLM 5': 'z-ai/glm5', 'MiniMax M2.5': 'minimaxai/minimax-m2.5', 'ShieldGemma 9B': 'google/shieldgemma-9b', 'MiniMax M2.1': 'minimaxai/minimax-m2.1', 'MiniMax M2': 'minimaxai/minimax-m2', 'GLM 4.7': 'z-ai/glm4.7', 'Jamba 1.5 Mini': 'ai21labs/jamba-1.5-mini-instruct', 'Seed OSS 36B': 'bytedance/seed-oss-36b-instruct', 'DeepSeek V3.2': 'deepseek-ai/deepseek-v3.2', 'DeepSeek V3.1': 'deepseek-ai/deepseek-v3.1', 'DeepSeek V3.1 Terminus': 'deepseek-ai/deepseek-v3.1-terminus', 'DeepSeek R1 Distill Qwen 32B': 'deepseek-ai/deepseek-r1-distill-qwen-32b', 'DeepSeek R1 Distill Llama 8B': 'deepseek-ai/deepseek-r1-distill-llama-8b', 'Gemma 3N E4B': 'google/gemma-3n-e4b-it', 'Gemma 3 27B': 'google/gemma-3-27b-it', 'Gemma 3 1B': 'google/gemma-3-1b-it', 'Gemma 2 27B': 'google/gemma-2-27b-it', 'Gemma 7B': 'google/gemma-7b', 'Granite 3.3 8B': 'ibm/granite-3.3-8b-instruct', 'Phi 4 Multimodal': 'microsoft/phi-4-multimodal-instruct', 'Phi 4 Mini Reasoning': 'microsoft/phi-4-mini-flash-reasoning', 'Phi 3 Medium': 'microsoft/phi-3-medium-4k-instruct', 'Llama 4 Maverick': 'meta/llama-4-maverick-17b-128e-instruct', 'Llama 4 Scout': 'meta/llama-4-scout-17b-16e-instruct', 'Llama 3.3 70B': 'meta/llama-3.3-70b-instruct', 'Llama 3.2 3B': 'meta/llama-3.2-3b-instruct', 'Kimi K2.5': 'moonshotai/kimi-k2.5', 'Kimi K2 Thinking': 'moonshotai/kimi-k2-thinking', 'Kimi K2 Instruct': 'moonshotai/kimi-k2-instruct', 'Devstral 2 123B': 'mistralai/devstral-2-123b-instruct-2512', 'Mistral Large 3 675B': 'mistralai/mistral-large-3-675b-instruct-2512', 'Ministral 14B': 'mistralai/ministral-14b-instruct-2512', 'Magistral Small': 'mistralai/magistral-small-2506', 'Mixtral 8x22B': 'mistralai/mixtral-8x22b-instruct-v0.1', 'Mamba Codestral 7B': 'mistralai/mamba-codestral-7b-v0.1', 'Step 3.5 Flash': 'stepfun-ai/step-3.5-flash', 'GPT OSS 120B': 'openai/gpt-oss-120b', 'GPT OSS 20B': 'openai/gpt-oss-20b', 'Sarvam M': 'sarvamai/sarvam-m', 'Qwen3 Next 80B': 'qwen/qwen3-next-80b-a3b-instruct', 'Qwen3 Next 80B Thinking': 'qwen/qwen3-next-80b-a3b-thinking', 'Qwen3 Coder 480B': 'qwen/qwen3-coder-480b-a35b-instruct', 'Qwen3 235B': 'qwen/qwen3-235b-a22b', 'QwQ 32B': 'qwen/qwq-32b', 'Qwen 2.5 7B': 'qwen/qwen2.5-7b-instruct', 'Nemotron 4 Mini Hindi': 'nvidia/nemotron-4-mini-hindi-4b-instruct', 'Nemotron 30B': 'nvidia/nemotron-3-nano-30b-a3b', 'Nemotron 12B VL': 'nvidia/nemotron-nano-12b-v2-vl', 'Nemotron 9B': 'nvidia/nvidia-nemotron-nano-9b-v2', 'Llama 3.3 Nemotron Super 49B': 'nvidia/llama-3.3-nemotron-super-49b-v1.5', 'ChatGLM3 6B': 'thudm/chatglm3-6b', 'USDCode Llama 3.1 70B': 'nvidia/usdcode-llama-3.1-70b-instruct' } },
            sambanova: { name: 'SambaNova', endpoint: 'https://api.sambanova.ai/v1/chat/completions', keyName: 'sahu_sambanova_key', color: 'sambanova', icon: '', models: { 'ALLaM 7B': 'ALLaM-7B-Instruct-preview', 'DeepSeek R1': 'DeepSeek-R1-0528', 'DeepSeek R1 Distill 70B': 'DeepSeek-R1-Distill-Llama-70B', 'DeepSeek V3.1': 'DeepSeek-V3.1', 'DeepSeek V3.1 Terminus': 'DeepSeek-V3.1-Terminus', 'DeepSeek V3.2': 'DeepSeek-V3.2', 'Llama Swallow 70B': 'Llama-3.3-Swallow-70B-Instruct-v0.4', 'Llama 4 Maverick': 'Llama-4-Maverick-17B-128E-Instruct', 'Llama 3.1 8B': 'Meta-Llama-3.1-8B-Instruct', 'Llama 3.3 70B': 'Meta-Llama-3.3-70B-Instruct', 'GPT OSS 120B': 'gpt-oss-120b', 'Qwen3 235B': 'Qwen3-235B', 'Qwen3 32B': 'Qwen3-32B' } },
            huggingface: { name: 'HuggingFace', endpoint: 'https://router.huggingface.co/v1/chat/completions', keyName: 'sahu_huggingface_key', color: 'huggingface', icon: '', models: { 'DeepSeek OCR': 'deepseek-ai/deepseek-ocr', 'DeepSeek OCR 2': 'deepseek-ai/deepseek-ocr-2', 'GLM 5': 'zai-org/GLM-5', 'MiniMax M2.5': 'minimaxai/MiniMax-M2.5', 'GLM 5 Flash': 'zai-org/GLM-5-Flash', 'GLM 4.7': 'zai-org/GLM-4.7', 'GLM 4.7 Flash': 'zai-org/GLM-4.7-Flash', 'ERNIE 4.5 VL': 'baidu/ERNIE-4.5-VL-424B-A47B-Base-PT', 'DeepSeek V3.2': 'deepseek-ai/DeepSeek-V3.2', 'DeepSeek R1': 'deepseek-ai/DeepSeek-R1', 'DeepSeek R1 Distill': 'deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B', 'Qwen3 Coder': 'Qwen/Qwen3-Coder-480B-A35B-Instruct', 'Qwen3 Thinking': 'Qwen/Qwen3-235B-A22B-Thinking-2507', 'Mistral 7B': 'mistralai/Mistral-7B-Instruct-v0.3', 'Kimi K2 Thinking': 'moonshotai/Kimi-K2-Thinking', 'Kimi K2': 'moonshotai/Kimi-K2-Instruct', 'Kimi K2.5': 'moonshotai/Kimi-K2.5', 'GPT OSS 120B': 'openai/gpt-oss-120b', 'GPT OSS 20B': 'openai/gpt-oss-20b', 'MiMo V2 Flash': 'XiaomiMiMo/MiMo-V2-Flash', 'MiniMax M2.1': 'MiniMaxAI/MiniMax-M2.1', 'Olmo 3.1': 'allenai/Olmo-3.1-32B-Instruct', 'Olmo 3.1 Think': 'allenai/Olmo-3.1-32B-Think', 'Llama 3.3 70B': 'meta-llama/Llama-3.3-70B-Instruct', 'NextCoder 32B': 'microsoft/NextCoder-32B', 'KAT Dev': 'Kwaipilot/KAT-Dev' } },
            openrouter: { name: 'OpenRouter', endpoint: 'https://openrouter.ai/api/v1/chat/completions', keyName: 'sahu_openrouter_key', color: 'openrouter', icon: '', models: { 'Trinity Large': 'arcee-ai/trinity-large-preview:free', 'Solar Pro 3': 'upstage/solar-pro-3:free', 'LFM Thinking': 'liquid/lfm-2.5-1.2b-thinking:free', 'LFM Instruct': 'liquid/lfm-2.5-1.2b-instruct:free', 'Molmo 2 8B': 'allenai/molmo-2-8b:free', 'Nemotron 30B': 'nvidia/nemotron-3-nano-30b-a3b:free', 'Trinity Mini': 'arcee-ai/trinity-mini:free', 'TNG R1T Chimera': 'tngtech/tng-r1t-chimera:free', 'Nemotron 12B VL': 'nvidia/nemotron-nano-12b-v2-vl:free', 'Qwen3 Next 80B': 'qwen/qwen3-next-80b-a3b-instruct:free', 'Nemotron 9B': 'nvidia/nemotron-nano-9b-v2:free', 'GLM 4.5 Air': 'z-ai/glm-4.5-air:free', 'Qwen3 Coder': 'qwen/qwen3-coder:free', 'DeepSeek R1T2 Chimera': 'tngtech/deepseek-r1t2-chimera:free', 'DeepSeek R1': 'deepseek/deepseek-r1-0528:free', 'Qwen3 4B': 'qwen/qwen3-4b:free', 'DeepSeek R1T Chimera': 'tngtech/deepseek-r1t-chimera:free', 'Mistral Small': 'mistralai/mistral-small-3.1-24b-instruct:free', 'Qwen 2.5 VL': 'qwen/qwen-2.5-vl-7b-instruct:free', 'Hermes 3 405B': 'nousresearch/hermes-3-llama-3.1-405b:free', 'Llama 3.1 405B': 'meta-llama/llama-3.1-405b-instruct:free', 'Nova 2 Lite': 'amazon/nova-2-lite-v1' } },
            groq: { name: 'Groq', endpoint: 'https://api.groq.com/openai/v1/chat/completions', keyName: 'sahu_groq_key', color: 'groq', icon: '', models: { 'GPT OSS 120B': 'openai/gpt-oss-120b', 'GPT OSS 20B': 'openai/gpt-oss-20b', 'Qwen3 32B': 'qwen/qwen3-32b', 'Llama 3.1 8B': 'llama-3.1-8b-instant', 'Llama 3.3 70B': 'llama-3.3-70b-versatile', 'Llama 4 Maverick': 'meta-llama/llama-4-maverick-17b-128e-instruct', 'Llama 4 Scout': 'meta-llama/llama-4-scout-17b-16e-instruct', 'Kimi K2 Instruct': 'moonshotai/kimi-k2-instruct', 'Kimi K2 0905': 'moonshotai/kimi-k2-instruct-0905', 'Groq Compound': 'groq/compound' } },
            together: { name: 'Together AI', endpoint: 'https://api.together.xyz/v1/chat/completions', keyName: 'sahu_together_key', color: 'together', icon: '', models: { 'GLM 5': 'z-ai/glm-5', 'MiniMax M2.5': 'minimaxai/MiniMax-M2.5', 'GLM 4.7': 'zai-org/GLM-4.7', 'Llama 4 Maverick': 'meta-llama/Llama-4-Maverick-17B-128E-Instruct-FP8', 'DeepSeek R1': 'deepseek-ai/DeepSeek-R1-0528-tput', 'Ministral 14B': 'mistralai/Ministral-3-14B-Instruct-2512', 'Trinity Mini': 'arcee-ai/trinity-mini', 'Cogito 671B': 'deepcogito/cogito-v2-1-671b', 'GLM 4.5 Air': 'zai-org/GLM-4.5-Air-FP8', 'Qwen3 Next 80B': 'Qwen/Qwen3-Next-80B-A3B-Thinking', 'Gemma 3N': 'google/gemma-3n-E4B-it', 'Nemotron 9B': 'nvidia/NVIDIA-Nemotron-Nano-9B-v2', 'Llama 4 Scout': 'meta-llama/Llama-4-Scout-17B-16E-Instruct', 'Cogito 405B': 'deepcogito/cogito-v2-preview-llama-405B', 'Cogito 109B': 'deepcogito/cogito-v2-preview-llama-109B-MoE' } },
            cerebras: { name: 'Cerebras', endpoint: 'https://api.cerebras.ai/v1/chat/completions', keyName: 'sahu_cerebras_key', color: 'cerebras', icon: '', models: { 'Qwen 3 32B': 'qwen-3-32b', 'Qwen 3 235B': 'qwen-3-235b-a22b-instruct-2507', 'GPT OSS 120B': 'gpt-oss-120b', 'Llama 3.3 70B': 'llama-3.3-70b', 'Llama 3.1 8B': 'llama3.1-8b', 'ZAI GLM 4.7': 'zai-glm-4.7' } },
            fireworks: { name: 'Fireworks AI', endpoint: 'https://api.fireworks.ai/inference/v1/chat/completions', keyName: 'sahu_fireworks_key', color: 'fireworks', icon: '', models: { 'GLM 5': 'accounts/fireworks/models/glm-5', 'MiniMax M2.5': 'accounts/fireworks/models/minimax-m2.5', 'DeepSeek OCR': 'accounts/fireworks/models/deepseek-ocr', 'DeepSeek OCR 2': 'accounts/fireworks/models/deepseek-ocr-2', 'Kimi K2.5': 'accounts/fireworks/models/kimi-k2p5', 'MiniMax M2.1': 'accounts/fireworks/models/minimax-m2p1', 'GLM 4.7': 'accounts/fireworks/models/glm-4p7', 'DeepSeek V3.2': 'accounts/fireworks/models/deepseek-v3p2', 'Qwen3 VL 235B': 'accounts/fireworks/models/qwen3-vl-235b-a22b-thinking', 'DeepSeek R1': 'accounts/fireworks/models/deepseek-r1-0528', 'Qwen3 235B': 'accounts/fireworks/models/qwen3-235b-a22b-thinking-2507', 'DeepSeek V3.1': 'accounts/fireworks/models/deepseek-v3p1', 'GLM 4.6': 'accounts/fireworks/models/glm-4p6', 'MiniMax M2': 'accounts/fireworks/models/minimax-m2', 'Qwen3 Coder 480B': 'accounts/fireworks/models/qwen3-coder-480b-a35b-instruct' } },
            routeway: { name: 'Routeway', endpoint: 'https://api.routeway.ai/v1/chat/completions', keyName: 'sahu_routeway_key', color: 'routeway', icon: '', models: { 'Opus 4.5': 'claude-opus-4.5', 'Sonnet 4.5': 'claude-sonnet-4.5', 'Haiku 4.5': 'claude-haiku-4.5', 'o3 Mini High': 'o3-mini-high', 'Command R+': 'command-r-plus-08-2024', 'Command A Reasoning': 'command-a-reasoning-08-2025', 'Command A': 'command-a-03-2025', 'TNG R1T Chimera': 'tng-r1t-chimera:free', 'Nemotron 30B': 'nemotron-3-nano-30b-a3b:free', 'Devstral': 'devstral-2512:free', 'Kimi K2 0905': 'kimi-k2-0905:free', 'MiniMax M2': 'minimax-m2:free', 'Nemotron 9B': 'nemotron-nano-9b-v2:free', 'DeepSeek R1T2 Chimera': 'deepseek-r1t2-chimera:free', 'DeepSeek R1T Chimera': 'deepseek-r1t-chimera:free', 'GPT OSS 120B': 'gpt-oss-120b:free', 'GLM 4.5 Air': 'glm-4.5-air:free', 'DeepSeek R1': 'deepseek-r1-0528:free', 'Mistral Nemo': 'mistral-nemo-instruct:free', 'DeepSeek R1 (Free)': 'deepseek-r1:free', 'DeepSeek R1 Distill 32B': 'deepseek-r1-distill-qwen-32b:free', 'Llama 3.2 3B': 'llama-3.2-3b-instruct:free', 'Llama 3.3 70B': 'llama-3.3-70b-instruct:free', 'Llama 3.1 8B': 'llama-3.1-8b-instruct:free', 'Llama 3.2 1B': 'llama-3.2-1b-instruct:free', 'Claude Opus 4.6': 'claude-opus-4-6', 'Claude Opus 4.6 Free': 'claude-opus-4-6:free' } },
            mistral: { name: 'Mistral', endpoint: 'https://api.mistral.ai/v1/agents/completions', keyName: 'sahu_mistral_key', color: 'mistral', icon: '', models: { 'Magistral Medium': 'ag_019bd61a73807623a04e608019bbd02f', 'Ministral 14B': 'ag_019bd61e5c1c751993fd59206f87615c', 'Mistral Large': 'ag_019bd5e9195c72c591ae1de889616331', 'Codestral': 'ag_019bd615fbb872f5a2f5dcaaa3de7c80', 'Devstral': 'ag_019bd5f9714b7062b5ee3544b9fd095e' } },
            gemini: { name: 'Gemini', endpoint: 'https://generativelanguage.googleapis.com/v1beta/openai/chat/completions', keyName: 'sahu_gemini_key', color: 'gemini', icon: '', models: { 'Gemini 3 Flash': 'gemini-3-flash-preview', 'Gemini 2.5 Pro': 'gemini-2.5-pro', 'Gemini 2.5 Flash': 'gemini-flash-latest', 'Gemini 2.5 Flash Lite': 'gemini-flash-lite-latest' } },
            longcat: { name: 'LongCat', endpoint: 'https://api.longcat.chat/openai/v1/chat/completions', keyName: 'sahu_longcat_key', color: 'longcat', icon: '', models: { 'LongCat Flash Chat': 'LongCat-Flash-Chat', 'LongCat Flash Thinking': 'LongCat-Flash-Thinking', 'LongCat Flash Thinking 2601': 'LongCat-Flash-Thinking-2601', 'LongCat Flash Lite': 'LongCat-Flash-Lite' } },
            ollama: { name: 'Ollama Cloud', endpoint: 'https://api.ollama.cloud/v1/chat/completions', keyName: 'sahu_ollama_key', color: 'ollama', icon: '', models: { 'Qwen3 Coder Next': 'qwen3-coder-next:cloud', 'Qwen3 VL': 'qwen3-vl:cloud', 'Qwen3 Next 80B': 'qwen3-next:80b-cloud', 'Kimi K2.5': 'kimi-k2.5:cloud', 'Kimi K2 Thinking': 'kimi-k2-thinking:cloud', 'Kimi K2 1T': 'kimi-k2:1t-cloud', 'MiniMax M2.1': 'minimax-m2.1:cloud', 'MiniMax M2': 'minimax-m2:cloud', 'DeepSeek V3.2': 'deepseek-v3.2:cloud', 'DeepSeek V3.1 671B': 'deepseek-v3.1:671b-cloud', 'GLM 4.6': 'glm-4.6:cloud', 'GLM 4.7': 'glm-4.7:cloud', 'Ministral 3 14B': 'ministral-3:14b-cloud', 'Ministral 3 8B': 'ministral-3:8b-cloud', 'Devstral Small 2 24B': 'devstral-small-2::24b-cloud', 'Devstral 2 123B': 'devstral-2:123b-cloud', 'Nemotron 3 Nano 30B': 'nemotron-3-nano:30b-cloud', 'Cogito 2.1 671B': 'cogito-2.1:671b-cloud', 'RNJ 1 8B': 'rnj-1:8b-cloud', 'Gemini 3 Pro': 'gemini-3-pro-preview', 'Gemini 3 Flash': 'gemini-3-flash-preview', 'GPT OSS 120B': 'gpt-oss:120b-cloud', 'Gemma 3 27B': 'gemma3:27b-cloud' } },
            zenmusk: { name: 'ZenMusk', endpoint: 'https://zenmux.ai/api/v1/chat/completions', keyName: 'sahu_zenmusk_key', color: 'zenmusk', icon: '', models: { 'GLM 5': 'z-ai/glm-5', 'GLM 5 Flash': 'z-ai/glm-5-flash', 'Claude Opus 4.6': 'anthropic/claude-opus-4.6', 'Step 3.5 Flash': 'stepfun/step-3.5-flash-free', 'MiniMax M2 Her': 'minimax/minimax-m2-her', 'Qwen3 Max': 'qwen/qwen3-max', 'Ernie 5.0 Thinking': 'baidu/ernie-5.0-thinking-preview', 'GLM 4.7 Flash': 'z-ai/glm-4.7-flash-free', 'MiMo V2 Flash': 'xiaomi/mimo-v2-flash-free', 'GPT 5.2 Pro': 'openai/gpt-5.2-pro', 'GPT 5.2': 'openai/gpt-5.2', 'GLM 4.6v Flash': 'z-ai/glm-4.6v-flash-free', 'Claude Opus 4.5': 'anthropic/claude-opus-4.5', 'Gemini 3 Pro': 'google/gemini-3-pro-preview', 'KAT Coder Pro': 'kuaishou/kat-coder-pro-v1-free', 'Grok Code Fast': 'x-ai/grok-code-fast-1' } },
            ionet: { name: 'io.net', endpoint: 'https://api.io.net/v1/chat/completions', keyName: 'sahu_ionet_key', color: 'ionet', icon: '', models: { 'Kimi K2 Thinking': 'Kimi-K2-Thinking', 'Kimi K2 Instruct 0905': 'Kimi-K2-Instruct-0905', 'GLM 4.7 Flash': 'GLM-4.7-Flash', 'GLM 4.7': 'GLM-4.7', 'DeepSeek V3.2': 'DeepSeek-V3.2', 'GPT OSS 120B': 'gpt-oss-120b', 'GPT OSS 20B': 'gpt-oss-20b', 'GLM 4.6': 'GLM-4.6', 'Qwen3 Next 80B': 'Qwen3-Next-80B-A3B-Instruct', 'Qwen3 Coder 480B': 'Qwen3-Coder-480B-A35B-Instruct-int4-mixed-ar', 'Llama 4 Maverick': 'Llama-4-Maverick-17B-128E-Instruct-FP8', 'Llama 3.3 70B': 'Llama-3.3-70B-Instruct', 'Mistral Nemo': 'Mistral-Nemo-Instruct-2407', 'Mistral Large': 'Mistral-Large-Instruct-2411' } }
        };

        const AGGREGATOR_PROMPTS = {
            stage1: `You are Stage 1 Aggregator. Analyze all expert answers, identify consensus, disagreements, and errors. Create an initial synthesis. Think step by step in <think> tags.`,
            stage2: `You are Stage 2 Aggregator. Verify the Stage 1 synthesis, resolve contradictions, fill gaps. Think deeply in <think> tags.`,
            stage3: `You are Stage 3 Final Aggregator. Produce a clean, polished final answer. No meta-commentary. Complete and authoritative. Think briefly in <think> tags. Use tools if necessary: SEARCH: <query> or CALC: <expr> or CODE: <python>. Cite sources as [1], [2] if provided.`
        };

        // Independent Search Configuration
        const SEARCH_ENGINES_CONFIG = {
            // API based (Fast & Direct)
            wikipedia: { name: 'Wikipedia', type: 'api', endpoint: 'https://en.wikipedia.org/w/api.php' },
            reddit: { name: 'Reddit', type: 'api', endpoint: 'https://www.reddit.com/search.json' },

            // General Search (SearXNG)
            google: { name: 'Google', type: 'searx', bang: '!g' },
            bing: { name: 'Bing', type: 'searx', bang: '!bing' },
            duckduckgo: { name: 'DuckDuckGo', type: 'searx', bang: '!ddg' },
            yahoo: { name: 'Yahoo', type: 'searx', bang: '!yahoo' },
            yandex: { name: 'Yandex', type: 'searx', bang: '!yandex' },
            qwant: { name: 'Qwant', type: 'searx', bang: '!qwant' },
            brave: { name: 'Brave', type: 'searx', bang: '!brave' },
            startpage: { name: 'Startpage', type: 'searx', bang: '!startpage' },
            baidu: { name: 'Baidu (English)', type: 'searx', bang: '!baidu' },
            youtube: { name: 'YouTube', type: 'searx', bang: '!yt' },
            twitter: { name: 'X (Twitter)', type: 'searx', bang: '!twitter' },
            
            // Site specific via SearXNG
            copilot: { name: 'Microsoft Copilot', type: 'searx', site: 'microsoft.com' },
            chatgpt: { name: 'ChatGPT', type: 'searx', site: 'openai.com' },
            chatglm: { name: 'ChatGLM', type: 'searx', site: 'chatglm.cn' },
            gemini: { name: 'Gemini', type: 'searx', site: 'gemini.google.com' },
            deepseek: { name: 'DeepSeek', type: 'searx', site: 'deepseek.com' },
            qwen: { name: 'Qwen', type: 'searx', site: 'aliyun.com' },
            kimi: { name: 'Kimi', type: 'searx', site: 'moonshot.cn' },
            mistral: { name: 'Mistral', type: 'searx', site: 'mistral.ai' },
            grok: { name: 'Grok', type: 'searx', site: 'x.ai' },
            minimax: { name: 'MiniMax', type: 'searx', site: 'minimaxi.com' },
            ernie: { name: 'ERNIE', type: 'searx', site: 'baidu.com' },
            perplexity: { name: 'Perplexity', type: 'searx', site: 'perplexity.ai' },
            discord: { name: 'Discord', type: 'searx', site: 'discord.com' },
            claude: { name: 'Claude', type: 'searx', site: 'anthropic.com' },
            facebook: { name: 'Facebook', type: 'searx', site: 'facebook.com' },
            instagram: { name: 'Instagram', type: 'searx', site: 'instagram.com' }
        };

        let state = {
            messages: [], chatHistory: [], currentChatId: null, isProcessing: false, theme: 'light',
            uploadedFile: null, uploadedFileContent: null, uploadedImage: null, // New image support
            selectedFile: { file: null, base64Data: null, mimeType: null }, // Added for robust file handling
            activeProviders: ['nvidia'], selectedModels: [],
            autoFallback: true, shieldGemmaEnabled: false, deepThinkEnabled: true, researchEnabled: false,
            mode: 'standard', examMode: false, pinnedMessages: [],
            totalTokens: 0, customInstructions: { user: '', resp: '' },
            searchProvider: 'ddg', selfConsistency: false, lastSources: [],
            temperature: 0.7, maxTokens: 8000, taskType: 'vibe',
            currentArtifact: { code: '', type: 'text' }, language: 'en',
            activeSearchEngines: [], // Will be populated on load
            perplexityMode: false 
        };

        let pyodide = null;

        // --- GLOBAL FUNCTIONS ---
        window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sidebarOverlay').classList.toggle('show'); };
        window.toggleDeepThink = () => {
            state.deepThinkEnabled = !state.deepThinkEnabled;
            const btn = document.getElementById('deepThinkBtn');
            btn.classList.toggle('text-[var(--accent)]', state.deepThinkEnabled);
            btn.classList.toggle('text-[var(--text-secondary)]', !state.deepThinkEnabled);
            showToast(state.deepThinkEnabled ? 'Deepthink Enabled (All Models)' : 'Deepthink Disabled');
        };

        window.updateMode = (mode) => {
            state.mode = mode;
            const btn = document.getElementById('taskTypeBtn');
            if(mode === 'task') {
                btn.classList.remove('hidden');
                showToast('Task Mode: Vibe Code Active (Canvas Enabled)');
            } else if (mode === 'search') {
                btn.classList.add('hidden');
                showToast('Search Mode: Conversational Search Active');
            } else {
                btn.classList.add('hidden');
                showToast('Mode: ' + mode.charAt(0).toUpperCase() + mode.slice(1));
            }
        };

        window.toggleTaskType = () => {
            // Cycle: vibe -> agentic -> creation -> vibe
            if (state.taskType === 'vibe') state.taskType = 'agentic';
            else if (state.taskType === 'agentic') state.taskType = 'creation';
            else state.taskType = 'vibe';

            const btn = document.getElementById('taskTypeBtn');
            const label = document.getElementById('taskTypeLabel');
            
            if(state.taskType === 'vibe') {
                label.textContent = 'VIBE';
                btn.className = 'p-2 rounded-xl task-btn-vibe transition-all active:scale-95 font-bold text-xs flex items-center gap-1';
            } else if (state.taskType === 'agentic') {
                label.textContent = 'AGENTIC';
                btn.className = 'p-2 rounded-xl task-btn-agentic transition-all active:scale-95 font-bold text-xs flex items-center gap-1';
            } else if (state.taskType === 'creation') {
                label.textContent = 'CREATION';
                btn.className = 'p-2 rounded-xl task-btn-creation transition-all active:scale-95 font-bold text-xs flex items-center gap-1';
            }
            showToast(`Task Type: ${state.taskType.charAt(0).toUpperCase() + state.taskType.slice(1)}`);
        };
        
        window.togglePerplexityMode = () => {
            state.perplexityMode = !state.perplexityMode;
            document.body.classList.toggle('perplexity-mode', state.perplexityMode);
            const status = document.getElementById('perplexityModeText');
            
            if(state.perplexityMode) {
                status.textContent = "Enabled";
                status.className = "text-xs bg-teal-500 text-white px-2 py-1 rounded border border-teal-600";
                
                // Force close sidebar when entering mode so it acts as a fresh overlay
                const sb = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                if(sb && sb.classList.contains('open')) {
                    sb.classList.remove('open');
                    if(overlay) overlay.classList.remove('show');
                }
                
                document.getElementById('shareBtn').classList.remove('hidden');
            } else {
                status.textContent = "Disabled";
                status.className = "text-xs bg-[var(--bg-secondary)] px-2 py-1 rounded border border-[var(--border)]";
                
                // Re-open sidebar if on desktop when exiting mode
                if(window.innerWidth >= 768) {
                    document.getElementById('sidebar').classList.add('open');
                }
                
                document.getElementById('shareBtn').classList.add('hidden');
            }
            
            localStorage.setItem('sahu_perplexity_mode', state.perplexityMode);
        };

        window.shareConversation = () => {
            // Use LZString to compress messages into URL hash
            const data = JSON.stringify(state.messages);
            const compressed = LZString.compressToEncodedURIComponent(data);
            const url = window.location.origin + window.location.pathname + '#' + compressed;
            
            navigator.clipboard.writeText(url).then(() => {
                showToast('Conversation URL copied to clipboard!', 'success');
            }).catch(e => {
                showToast('Failed to copy URL', 'error');
            });
        };

        window.openSettings = () => { 
            document.getElementById('settingsModal').classList.remove('hidden'); 
            navigateSettings('main'); // Reset to main view
            
            // Render content inside sections
            renderApiKeyInputs(); 
            renderProviderCheckboxes();
            renderLanguageSelector();
            renderSearchEngines();

            // Sync UI values
            document.getElementById('stageSelector').value = document.querySelector('#sidebar #stageSelector')?.value || '1'; 
            document.getElementById('autoFallback').checked = state.autoFallback;
            document.getElementById('shieldGemmaCheck').checked = state.shieldGemmaEnabled;
            document.getElementById('selfConsistencyCheck').checked = state.selfConsistency;
            document.getElementById('customInstructionsUser').value = state.customInstructions.user || ''; 
            document.getElementById('customInstructionsResp').value = state.customInstructions.resp || ''; 
            document.getElementById('settingTemp').value = state.temperature; 
            document.getElementById('settingMaxTokens').value = state.maxTokens; 
        };
        window.closeSettings = () => { document.getElementById('settingsModal').classList.add('hidden'); };

        // New Settings Navigation Logic
        window.navigateSettings = (view) => {
            // Hide all views
            document.querySelectorAll('.settings-view').forEach(el => el.classList.remove('active'));
            // Show target view
            document.getElementById(`settings-${view}`).classList.add('active');
            
            // Header Logic
            const title = document.getElementById('settingsTitle');
            const backBtn = document.getElementById('settingsBackBtn');
            
            if(view === 'main') {
                title.innerHTML = '<i class="fas fa-cog text-[var(--accent)]"></i> Settings';
                backBtn.classList.add('hidden');
            } else {
                let name = view.charAt(0).toUpperCase() + view.slice(1);
                if(view === 'keys') name = 'API Keys';
                if(view === 'search') name = 'Search Engines';
                title.textContent = name;
                backBtn.classList.remove('hidden');
            }
        };
        
        window.openSourceCode = () => { document.getElementById('sourceCodeModal').classList.remove('hidden'); document.getElementById('sourceCodeViewer').value = document.documentElement.outerHTML; };
        window.closeSourceCode = () => { document.getElementById('sourceCodeModal').classList.add('hidden'); };
        window.copySourceCode = () => { const viewer = document.getElementById('sourceCodeViewer'); viewer.select(); navigator.clipboard.writeText(viewer.value).then(() => showToast('Source Code Copied!')); };
        window.toggleTheme = () => { state.theme = state.theme === 'light' ? 'dark' : 'light'; document.body.classList.toggle('dark-mode'); localStorage.setItem('sahu_theme', state.theme); const icon = document.getElementById('themeIcon'); icon.className = state.theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon'; document.getElementById('themeText').textContent = state.theme === 'dark' ? 'Light Mode' : 'Dark Mode'; };
        
        window.saveSettings = () => { 
            Object.keys(PROVIDERS).forEach(k => { const i = document.getElementById(`key_${k}`); if(i) localStorage.setItem(PROVIDERS[k].keyName, i.value); }); 
            state.customInstructions = { user: document.getElementById('customInstructionsUser').value, resp: document.getElementById('customInstructionsResp').value }; 
            localStorage.setItem('sahu2_custom_instructions', JSON.stringify(state.customInstructions)); 
            
            // Save Settings
            state.temperature = parseFloat(document.getElementById('settingTemp').value);
            state.maxTokens = parseInt(document.getElementById('settingMaxTokens').value);
            localStorage.setItem('sahu2_temp', state.temperature);
            localStorage.setItem('sahu2_max_tokens', state.maxTokens);

            // Pipeline Settings
            state.autoFallback = document.getElementById('autoFallback').checked; localStorage.setItem('sahu_auto_fallback', state.autoFallback);
            state.shieldGemmaEnabled = document.getElementById('shieldGemmaCheck').checked; localStorage.setItem('sahu_shield_gemma', state.shieldGemmaEnabled);
            state.selfConsistency = document.getElementById('selfConsistencyCheck').checked; localStorage.setItem('sahu2_self_consistency', state.selfConsistency);
            
            // Search Engines
            localStorage.setItem('sahu_search_engines', JSON.stringify(state.activeSearchEngines));

            updateLanguage(state.language); // Enforce UI update
            localStorage.setItem('sahu_language', state.language);

            closeSettings(); showToast('Settings Saved!'); 
        };

        window.toggleProvider = (k, e) => { if(e) { if(!state.activeProviders.includes(k)) state.activeProviders.push(k); } else { state.activeProviders = state.activeProviders.filter(p => p !== k); } localStorage.setItem('sahu_active_providers', JSON.stringify(state.activeProviders)); renderProviderCheckboxes(); updateUI(); };
        
        // NEW: Search Engines Toggle Logic
        window.renderSearchEngines = () => {
            const list = document.getElementById('searchEngineList');
            if(!list) return;
            list.innerHTML = Object.entries(SEARCH_ENGINES_CONFIG).map(([key, config]) => `
                <label class="flex items-center gap-2 p-2 rounded-lg bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)]">
                    <input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" ${state.activeSearchEngines.includes(key) ? 'checked' : ''} onchange="toggleSearchEngine('${key}', this.checked)">
                    <div class="flex-1 text-sm font-medium">${config.name} <span class="text-[10px] text-[var(--text-secondary)]">${config.type === 'api' ? '(API)' : '(SearXNG)'}</span></div>
                </label>
            `).join('');
        };

        window.toggleSearchEngine = (key, checked) => {
            if(checked) {
                if(!state.activeSearchEngines.includes(key)) state.activeSearchEngines.push(key);
            } else {
                state.activeSearchEngines = state.activeSearchEngines.filter(k => k !== key);
            }
        };

        window.toggleAllSearchEngines = () => {
            const allKeys = Object.keys(SEARCH_ENGINES_CONFIG);
            if(state.activeSearchEngines.length === allKeys.length) {
                state.activeSearchEngines = [];
            } else {
                state.activeSearchEngines = [...allKeys];
            }
            renderSearchEngines();
        };

        window.openModelSelector = () => { document.getElementById('modelSelectorModal').classList.remove('hidden'); renderModelSelector(); };
        window.closeModelSelector = () => { document.getElementById('modelSelectorModal').classList.add('hidden'); };
        window.toggleAllModels = (k) => { const p = PROVIDERS[k]; const all = Object.entries(p.models); const sel = all.filter(([mk]) => state.selectedModels.find(m => m.provider === k && m.modelKey === mk)).length; const isAll = sel === all.length; if(isAll) state.selectedModels = state.selectedModels.filter(m => m.provider !== k); else all.forEach(([mk, mid]) => { if(!state.selectedModels.find(m => m.provider === k && m.modelKey === mk)) state.selectedModels.push({provider: k, modelKey: mk, modelId: mid, stage: 'none'}); }); renderModelSelector(); };
        window.toggleModelSelection = (p, mk, mid, s) => { if(s) { if(!state.selectedModels.find(m => m.provider === p && m.modelKey === mk)) state.selectedModels.push({provider: p, modelKey: mk, modelId: mid, stage: 'none'}); } else { state.selectedModels = state.selectedModels.filter(m => !(m.provider === p && m.modelKey === mk)); } renderModelSelector(); };
        window.setModelStage = (p, mk, mid, s, e) => { e.stopPropagation(); let m = state.selectedModels.find(x => x.provider === p && x.modelKey === mk); if(!m) { m = {provider: p, modelKey: mk, modelId: mid, stage: 'none'}; state.selectedModels.push(m); } if(m.stage === s) m.stage = 'none'; else { state.selectedModels.forEach(x => { if(x.stage === s) x.stage = 'none'; }); m.stage = s; } renderModelSelector(); };
        window.saveModelSelection = () => { localStorage.setItem('sahu_selected_models', JSON.stringify(state.selectedModels)); closeModelSelector(); updateUI(); showToast(`${state.selectedModels.length} models configured`); };
        
        window.newChat = () => { state.currentChatId = null; state.messages = []; document.getElementById('messagesContainer').innerHTML = ''; document.getElementById('messagesContainer').classList.add('hidden'); document.getElementById('welcomeScreen').classList.remove('hidden'); document.getElementById('userInput').value = ''; removeFile(); if(window.innerWidth < 768) toggleSidebar(); };
        window.triggerFileUpload = () => document.getElementById('fileInput').click();
        
        // --- IMAGE COMPRESSION & FILE UPLOAD ---
        window.compressImage = async (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        // Max dimension 1024 to stay well within free proxy limits
                        const MAX_SIZE = 1024; 
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_SIZE) {
                                height *= MAX_SIZE / width;
                                width = MAX_SIZE;
                            }
                        } else {
                            if (height > MAX_SIZE) {
                                width *= MAX_SIZE / height;
                                height = MAX_SIZE;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Compress to JPEG 0.6 quality
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                };
            });
        };

        window.handleFileUpload = async (e) => { 
            const f = e.target.files[0]; 
            if(!f) return; 
            
            state.uploadedFile = f;
            
            // Populate selectedFile state for robust file handling
            state.selectedFile.file = f;
            state.selectedFile.mimeType = f.type;
            state.selectedFile.base64Data = null; // Reset base64

            // Image handling for Vision Models with Compression
            if (f.type.startsWith('image/')) {
                // Compress image immediately to avoid "corsproxy pricing" error
                try {
                    const compressedDataUrl = await window.compressImage(f);
                    state.uploadedImage = compressedDataUrl; // Base64 data (compressed)
                    
                    // Set base64Data for future use (removing header)
                    state.selectedFile.base64Data = compressedDataUrl.split(',')[1];
                    state.selectedFile.mimeType = 'image/jpeg'; // Compressed images are jpeg

                    state.uploadedFileContent = `[IMAGE ATTACHED: ${f.name}]`; 
                    renderFilePreview(f, true);
                } catch(err) {
                    console.error("Compression failed", err);
                    showToast("Image processing failed", "error");
                }
                return;
            }

            state.uploadedImage = null; // Clear previous image
            
            // Advanced Text Extraction
            try {
                if (f.type === 'application/pdf') {
                    const arrayBuffer = await f.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                    let text = "";
                    for(let i=1; i<=pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(item => item.str).join(" ") + "\n";
                    }
                    state.uploadedFileContent = text.substring(0, 50000);
                } else if (f.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') { // DOCX
                    const arrayBuffer = await f.arrayBuffer();
                    const result = await mammoth.extractRawText({arrayBuffer: arrayBuffer});
                    state.uploadedFileContent = result.value.substring(0, 50000);
                } else {
                    // Fallback to text
                    state.uploadedFileContent = (await f.text()).substring(0, 50000);
                }
            } catch(e) {
                console.error("File read error:", e);
                state.uploadedFileContent = "Error reading file content. Please try converting to TXT.";
            }
            
            renderFilePreview(f, false);
        };

        function renderFilePreview(f, isImage) {
            document.getElementById('fileUploadPreview').innerHTML = `<div class="flex items-center gap-3 p-3 bg-[var(--bg-tertiary)] rounded-xl border border-[var(--border)]"><div class="w-10 h-10 bg-[var(--accent)] rounded-lg flex items-center justify-center text-white overflow-hidden">${isImage ? `<img src="${state.uploadedImage}" class="w-full h-full object-cover">` : '<i class="fas fa-file"></i>'}</div><div class="flex-1 min-w-0"><div class="font-medium text-sm truncate">${escapeHtml(f.name)}</div><div class="text-xs text-[var(--text-secondary)]">${(f.size/1024).toFixed(1)} KB  ${isImage ? 'Vision Ready' : 'Text Extracted'}</div></div><button class="p-2 rounded-lg hover:bg-[var(--bg-secondary)]" onclick="removeFile()"><i class="fas fa-times text-[var(--text-secondary)]"></i></button></div>`; 
            document.getElementById('fileUploadPreview').classList.remove('hidden'); 
        }

        window.removeFile = () => { 
            state.uploadedFile = null; 
            state.uploadedFileContent = null; 
            state.uploadedImage = null; 
            // Clear selectedFile state
            state.selectedFile = { file: null, base64Data: null, mimeType: null };
            document.getElementById('fileUploadPreview').classList.add('hidden'); 
            document.getElementById('fileInput').value = ''; 
        };
        window.handleKeyDown = (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } if(e.key === 'Escape') { state.isProcessing = false; } };
        window.autoResize = (t) => { t.style.height = 'auto'; t.style.height = Math.min(t.scrollHeight, 128) + 'px'; };
        window.quickPrompt = (t) => { document.getElementById('userInput').value = t; sendMessage(); };
        
        window.loadChat = (id) => { 
            const c = state.chatHistory.find(x => x.id === id); 
            if(c) { 
                state.currentChatId = id; 
                state.messages = c.messages || []; 
                
                // RENDER MESSAGES LOGIC (Fixing history display issue)
                const container = document.getElementById('messagesContainer');
                const welcome = document.getElementById('welcomeScreen');
                
                if(welcome) welcome.classList.add('hidden');
                if(container) {
                    container.classList.remove('hidden');
                    container.innerHTML = '';
                    
                    state.messages.forEach(msg => {
                        if(msg.role === 'user') {
                             container.innerHTML += `<div class="flex justify-end mb-4"><div class="message-user px-4 py-3 rounded-2xl max-w-[85%] shadow-lg"><p class="text-white text-sm whitespace-pre-wrap">${escapeHtml(msg.content)}</p></div></div>`;
                        } else if (msg.role === 'assistant') {
                             container.innerHTML += `<div class="flex justify-start mb-4"><div class="message-assistant px-4 py-3 rounded-2xl max-w-[85%] border border-[var(--border)] shadow-sm"><div class="prose max-w-none text-sm">${formatMarkdown(msg.content)}</div></div></div>`;
                        }
                    });
                    
                    // Scroll to bottom
                    setTimeout(() => container.scrollTop = container.scrollHeight, 100);
                }
            } 
            if(window.innerWidth < 768) toggleSidebar(); 
        };

        // --- GLOBAL DEFINITIONS FOR HTML EVENTS ---
        window.filterHistory = function(q) {
             if(!q) return renderChatHistory();
             try {
                 const fuse = new Fuse(state.chatHistory, { keys: ['title', 'messages.content'], threshold: 0.4 });
                 const res = fuse.search(q);
                 document.getElementById('chatHistory').innerHTML = res.slice(0, 10).map(r => `<div onclick="loadChat('${r.item.id}')" class="p-3 rounded-xl hover:bg-[var(--bg-tertiary)] cursor-pointer flex items-center gap-3 active:scale-98"><i class="fas fa-search text-[var(--accent)]"></i><span class="text-sm truncate flex-1">${escapeHtml(r.item.title)}</span></div>`).join('');
             } catch(e) { console.error(e); }
        };

        // --- UPDATED SEARCH LOGIC ---
        async function searchWeb(query) {
            // Limit logic: 10 for Deep Research, 3 for Standard/Task per engine
            const limit = (state.mode === 'research' || state.mode === 'task') ? 10 : 3;
            const encodedQuery = encodeURIComponent(query);
            const corsProxy = 'https://corsproxy.io/?'; 
            
            // Helper to fetch JSON with timeout
            const fetchJson = async (url) => {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), 10000); // 10s timeout
                try {
                    const res = await fetch(url, { signal: controller.signal });
                    clearTimeout(id);
                    if (!res.ok) return null;
                    return await res.json();
                } catch(e) { return null; }
            };

            // SearXNG Helper
            const querySearX = async (bang, site, sourceLabel) => {
                const instances = [
                    'https://searx.be', 
                    'https://search.mdosch.de',
                    'https://op.nx.is',
                    'https://searx.work' 
                ];
                
                let qParam = query;
                if(bang) qParam = `${bang} ${qParam}`;
                if(site) qParam = `${qParam} site:${site}`;
                
                const encodedQ = encodeURIComponent(qParam);

                for (const instance of instances) {
                    // Try JSON format
                    let url = `${instance}/search?q=${encodedQ}&format=json&language=en`; 
                    let data = await fetchJson(url);
                    if (!data) data = await fetchJson(`${corsProxy}${url}`); // Try proxy
                    
                    if (data && data.results) {
                        return data.results.slice(0, limit).map(r => ({
                            title: r.title,
                            link: r.url,
                            snippet: r.content || r.title,
                            source: sourceLabel,
                            date: r.publishedDate ? new Date(r.publishedDate).toISOString().split('T')[0] : null
                        }));
                    }
                }
                return [];
            };

            const promises = [];
            const activeEngines = state.activeSearchEngines.length > 0 ? state.activeSearchEngines : ['google', 'wikipedia', 'reddit'];

            activeEngines.forEach(key => {
                const config = SEARCH_ENGINES_CONFIG[key];
                if (!config) return;

                if (config.type === 'api') {
                    if (key === 'wikipedia') {
                        promises.push(async () => {
                            const data = await fetchJson(`https://en.wikipedia.org/w/api.php?action=opensearch&search=${encodedQuery}&limit=${limit}&namespace=0&format=json&origin=*`);
                            if (data && data[1]) {
                                return data[1].map((title, i) => ({ title, link: data[3][i], snippet: `Wikipedia: ${title}`, source: 'Wikipedia' }));
                            }
                            return [];
                        });
                    } else if (key === 'reddit') {
                        promises.push(async () => {
                            const data = await fetchJson(`https://www.reddit.com/search.json?q=${encodedQuery}&limit=${limit}&sort=relevance`);
                            if (data && data.data && data.data.children) {
                                return data.data.children.map(c => ({
                                    title: c.data.title,
                                    link: `https://www.reddit.com${c.data.permalink}`,
                                    snippet: c.data.selftext?.substring(0, 150) || `r/${c.data.subreddit}`,
                                    source: 'Reddit',
                                    date: new Date(c.data.created_utc * 1000).toISOString().split('T')[0]
                                }));
                            }
                            return [];
                        });
                    }
                } else if (config.type === 'searx') {
                    promises.push(() => querySearX(config.bang, config.site, config.name));
                }
            });

            // Execute all
            const resultsNested = await Promise.all(promises.map(p => p().catch(e => [])));
            const flat = resultsNested.flat().filter(x => x && x.title && x.link);
            const unique = flat.filter((v,i,a) => a.findIndex(t => t.link === v.link) === i);
            
            state.lastSources = unique;
            return JSON.stringify(unique);
        }

        async function executeTool(cmd) {
            const firstColon = cmd.indexOf(':');
            const tool = cmd.substring(0, firstColon).trim();
            const arg = cmd.substring(firstColon + 1).trim();
            
            if(tool === 'SEARCH') {
                return `SEARCH RESULTS: ${await searchWeb(arg)}`;
            }
            if(tool === 'CALC') { try { return `CALC: ${eval(arg.replace(/[^-()\d/*+.]/g, ''))}`; } catch(e) { return "CALC ERROR"; } }
            if(tool === 'CODE') {
                if(!pyodide) return "PYTHON ERROR: Pyodide not loaded";
                try {
                    pyodide.runPython(`import sys\nfrom io import StringIO\nsys.stdout = StringIO()`);
                    await pyodide.runPythonAsync(arg);
                    const stdout = pyodide.runPython("sys.stdout.getvalue()");
                    return `CODE OUTPUT:\n${stdout}`;
                } catch(e) { return `CODE ERROR: ${e.message}`; }
            }
            
            // New File Creation Tool logic
            if(tool === 'CREATE_FILE') {
                try {
                    // Expecting JSON: { type: 'pdf|docx|txt|xlsx|pptx|zip', filename: '...', content: '...' }
                    // Content for simple files is string, for Excel/PPT might need structure
                    const data = JSON.parse(arg);
                    await executeFileCreation(data);
                    return `FILE CREATED: ${data.filename} (${data.type})`;
                } catch(e) {
                    console.error(e);
                    return `FILE ERROR: ${e.message}. Ensure JSON format for CREATE_FILE tool.`;
                }
            }
            
            return "UNKNOWN TOOL";
        }
        
        // --- SAHU 2.0 LOGIC ---
        document.addEventListener('DOMContentLoaded', async () => {
            loadSettings(); loadChatHistory(); initTheme(); renderProviderCheckboxes(); renderApiKeyInputs(); updateUI(); renderPinned();
            document.addEventListener('keydown', e => {
               if(e.ctrlKey && e.key === 'Enter') sendMessage();
               if(e.ctrlKey && e.key === 'k') { e.preventDefault(); document.getElementById('historySearch').focus(); }
            });
            // Init Pyodide in background
            try { pyodide = await loadPyodide(); await pyodide.loadPackage("micropip"); } catch(e) { console.warn("Pyodide init failed", e); }
        });

        function loadSettings() {
            try { state.activeProviders = JSON.parse(localStorage.getItem('sahu_active_providers') || '["nvidia"]'); } catch(e){}
            
            // Default Models Configuration
            const defaultModels = [
                {provider: 'nvidia', modelKey: 'Kimi K2.5', modelId: 'moonshotai/kimi-k2.5', stage: 'none'},
                {provider: 'nvidia', modelKey: 'GLM 5', modelId: 'z-ai/glm5', stage: '1'}, // New Default
                {provider: 'nvidia', modelKey: 'Kimi K2 Thinking', modelId: 'moonshotai/kimi-k2-thinking', stage: 'none'},
                {provider: 'nvidia', modelKey: 'GPT OSS 120B', modelId: 'openai/gpt-oss-120b', stage: 'none'},
                {provider: 'nvidia', modelKey: 'GLM 4.7', modelId: 'z-ai/glm4.7', stage: 'none'},
                {provider: 'nvidia', modelKey: 'MiniMax M2.1', modelId: 'minimaxai/minimax-m2.1', stage: 'none'}
            ];

            try { 
                const stored = localStorage.getItem('sahu_selected_models');
                // If no stored models, use default
                state.selectedModels = (stored && JSON.parse(stored).length > 0) ? JSON.parse(stored) : defaultModels; 
            } catch(e){
                state.selectedModels = defaultModels;
            }

            state.autoFallback = localStorage.getItem('sahu_auto_fallback') !== 'false';
            state.shieldGemmaEnabled = localStorage.getItem('sahu_shield_gemma') === 'true';
            try { state.customInstructions = JSON.parse(localStorage.getItem('sahu2_custom_instructions') || '{"user":"","resp":""}'); } catch(e){}
            try { state.pinnedMessages = JSON.parse(localStorage.getItem('sahu2_pinned') || '[]'); } catch(e){}
            
            // Search Engine Loading - Default to All if empty/null
            try { 
                const allEngines = Object.keys(SEARCH_ENGINES_CONFIG);
                const storedEngines = localStorage.getItem('sahu_search_engines');
                // If stored is null, use allEngines. If stored is valid JSON, use it.
                state.activeSearchEngines = storedEngines ? JSON.parse(storedEngines) : allEngines;
            } catch(e){ 
                state.activeSearchEngines = Object.keys(SEARCH_ENGINES_CONFIG); 
            }
            
            state.temperature = parseFloat(localStorage.getItem('sahu2_temp') || '0.7');
            state.maxTokens = parseInt(localStorage.getItem('sahu2_max_tokens') || '8000');
            state.selfConsistency = localStorage.getItem('sahu2_self_consistency') === 'true';
            
            // Perplexity Mode
            state.perplexityMode = localStorage.getItem('sahu_perplexity_mode') === 'true';
            if(state.perplexityMode) {
                document.body.classList.add('perplexity-mode');
                document.getElementById('perplexityModeText').textContent = "Enabled";
                document.getElementById('perplexityModeText').className = "text-xs bg-teal-500 text-white px-2 py-1 rounded border border-teal-600";
                document.getElementById('shareBtn').classList.remove('hidden');
            }

            state.language = localStorage.getItem('sahu_language') || 'en';
            updateLanguage(state.language);
        }

        function initTheme() {
            state.theme = localStorage.getItem('sahu_theme') || 'light';
            if(state.theme === 'dark') { document.body.classList.add('dark-mode'); document.getElementById('themeIcon').className = 'fas fa-sun'; document.getElementById('themeText').textContent = 'Light Mode'; }
        }

        function renderProviderCheckboxes() {
            const container = document.getElementById('providerCheckboxes');
            if(!container) return;
            container.innerHTML = Object.entries(PROVIDERS).map(([k, p]) => `
                <label class="flex items-center gap-2 p-3 rounded-xl bg-[var(--bg-tertiary)] cursor-pointer hover:bg-[var(--border)] transition-colors border border-transparent ${state.activeProviders.includes(k) ? 'border-[var(--accent)] bg-opacity-50' : ''}">
                    <input type="checkbox" class="w-5 h-5 accent-[var(--accent)]" ${state.activeProviders.includes(k) ? 'checked' : ''} onchange="toggleProvider('${k}', this.checked)">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 font-medium text-sm"><span>${p.icon}</span> ${p.name}</div>
                    </div>
                </label>`).join('');
        }

        function renderApiKeyInputs() {
            const c = document.getElementById('apiKeyInputs');
            if(!c) return;
            c.innerHTML = Object.entries(PROVIDERS).map(([k, p]) => `
                <div class="p-2 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border)]">
                    <div class="flex items-center gap-2 mb-1"><span class="text-sm">${p.icon} ${p.name}</span></div>
                    <input type="password" id="key_${k}" placeholder="Enter API Key" class="w-full p-2 rounded bg-[var(--bg-primary)] border border-[var(--border)] text-xs focus:border-[var(--accent)] outline-none">
                </div>`).join('');
            Object.keys(PROVIDERS).forEach(k => { const v = localStorage.getItem(PROVIDERS[k].keyName); if(v) document.getElementById(`key_${k}`).value = v; });
        }
        
        function renderLanguageSelector() {
            const sel = document.getElementById('languageSelector');
            if(!sel) return;
            sel.innerHTML = LANGUAGES.map(l => `<option value="${l.code}" ${state.language === l.code ? 'selected' : ''}>${l.name}</option>`).join('');
        }

        function updateLanguage(langCode) {
            state.language = langCode;
            const t = UI_TRANSLATIONS[langCode];
            
            // UI Translation Helpers
            const setTxt = (id, key, def) => { const el = document.getElementById(id); if(el) el.innerHTML = (t && t[key]) ? (t[key].includes('<') ? t[key] : (el.innerHTML.includes('<i') ? el.innerHTML.replace(/<\/i>\s*(.*)/, `</i> ${t[key]}`) : t[key])) : el.innerHTML.replace(/<\/i>\s*(.*)/, `</i> ${def || el.innerText.trim()}`); };
            const setAttr = (id, attr, key) => { const el = document.getElementById(id); if(el && t && t[key]) el.setAttribute(attr, t[key]); };

            // Apply translations to visible elements
            if(t) {
                // Sidebar
                const nc = document.getElementById('btn-new-chat'); if(nc) nc.innerHTML = `<i class="fas fa-plus"></i> ${t.newChat || 'New Chat'}`;
                const inst = document.getElementById('btn-install'); if(inst) inst.innerHTML = `<i class="fab fa-android text-green-600"></i><span>${t.install || 'Install Android App'}</span>`;
                const sets = document.getElementById('btn-settings'); if(sets) sets.innerHTML = `<i class="fas fa-cog text-[var(--text-secondary)]"></i><span class="text-sm">${t.settings || 'Settings'}</span>`;
                const conf = document.getElementById('btn-config-models'); if(conf) conf.innerHTML = `<span class="flex items-center gap-2"><i class="fas fa-cubes text-[var(--accent)]"></i>${t.config || 'Configure Models'}</span><span id="selectedModelCount" class="text-xs bg-[var(--accent)] text-white px-2 py-0.5 rounded-full">${state.selectedModels.length}</span>`;
            } else {
                // Revert to English roughly if needed, usually defaults handle it or reload
                if(langCode === 'en') {
                   const nc = document.getElementById('btn-new-chat'); if(nc) nc.innerHTML = `<i class="fas fa-plus"></i> New Chat`;
                   // ... assume default HTML is english
                }
            }
        }

        function renderModelSelector() {
            const c = document.getElementById('modelSelectorContent');
            let h = '';
            state.activeProviders.forEach(pk => {
                const p = PROVIDERS[pk];
                h += `<div class="border border-[var(--border)] rounded-xl overflow-hidden"><div class="bg-[var(--bg-tertiary)] p-3 flex items-center justify-between"><div class="flex items-center gap-2"><span>${p.icon}</span><span class="font-semibold text-sm">${p.name}</span><span class="text-xs text-[var(--text-secondary)]">(${Object.keys(p.models).length})</span></div><button onclick="toggleAllModels('${pk}')" class="text-xs px-2 py-1 bg-[var(--bg-secondary)] border border-[var(--border)] rounded hover:bg-[var(--accent)] hover:text-white transition-colors">All/None</button></div><div class="p-3 grid grid-cols-1 gap-2">${Object.entries(p.models).map(([mk, mid]) => {
                    const ex = state.selectedModels.find(m => m.provider === pk && m.modelKey === mk);
                    const s = ex?.stage || 'none';
                    return `<div class="model-card ${ex ? 'selected' : ''}"><input type="checkbox" class="w-4 h-4 accent-[var(--accent)]" ${ex ? 'checked' : ''} onchange="toggleModelSelection('${pk}', '${mk}', '${mid}', this.checked)"><div class="flex-1 min-w-0"><div class="text-sm font-medium truncate">${mk}</div></div><div class="flex gap-1"><button class="stage-btn ${s==='1'?'active-1':''}" onclick="setModelStage('${pk}','${mk}','${mid}','1',event)">1</button><button class="stage-btn ${s==='2'?'active-2':''}" onclick="setModelStage('${pk}','${mk}','${mid}','2',event)">2</button><button class="stage-btn ${s==='3'?'active-3':''}" onclick="setModelStage('${pk}','${mk}','${mid}','3',event)">3</button></div></div>`;
                }).join('')}</div></div>`;
            });
            c.innerHTML = h || '<div class="text-center py-8 text-[var(--text-secondary)]">Select a provider.</div>';
            document.getElementById('modalSelectedCount').textContent = state.selectedModels.length;
        }

        function updateUI() { document.getElementById('selectedModelCount').textContent = state.selectedModels.length; updateTokenCounter(); }
        function loadChatHistory() { const s = localStorage.getItem('sahu_chat_history'); if(s) { state.chatHistory = JSON.parse(s); renderChatHistory(); } }
        function renderChatHistory() { document.getElementById('chatHistory').innerHTML = state.chatHistory.slice(0, 10).map(c => `<div onclick="loadChat('${c.id}')" class="p-3 rounded-xl hover:bg-[var(--bg-tertiary)] cursor-pointer flex items-center gap-3 active:scale-98"><i class="fas fa-message text-[var(--text-secondary)]"></i><span class="text-sm truncate flex-1">${escapeHtml(c.title)}</span></div>`).join(''); }
        
        function showToast(msg, type='success') { const t = document.createElement('div'); t.className = `toast ${type==='error'?'bg-red-500':'bg-green-500'}`; t.innerHTML = `<i class="fas fa-${type==='error'?'exclamation-circle':'check-circle'}"></i><span>${msg}</span>`; document.body.appendChild(t); setTimeout(() => t.remove(), 3000); }
        function escapeHtml(t) { 
            if(t === null || t === undefined) return '';
            const d = document.createElement('div'); 
            d.textContent = t; 
            return d.innerHTML; 
        }

        // --- PINNING ---
        function renderPinned() {
             const c = document.getElementById('pinnedList');
             const s = document.getElementById('pinnedSection');
             if(state.pinnedMessages.length === 0) { s.classList.add('hidden'); return; }
             s.classList.remove('hidden');
             c.innerHTML = state.pinnedMessages.map((msg, i) => `<div class="p-2 bg-[var(--bg-tertiary)] rounded-lg text-xs truncate cursor-pointer" onclick="showToast('Jump to message')"><i class="fas fa-thumbtack text-yellow-500 mr-2"></i>${escapeHtml(msg.substring(0, 30))}...</div>`).join('');
        }
        window.togglePin = (txt) => {
            const idx = state.pinnedMessages.indexOf(txt);
            if(idx > -1) state.pinnedMessages.splice(idx, 1);
            else state.pinnedMessages.push(txt);
            localStorage.setItem('sahu2_pinned', JSON.stringify(state.pinnedMessages));
            renderPinned();
        };

        // --- TOKEN COUNTER ---
        function updateTokenCounter() {
            state.totalTokens = Math.ceil((window.lastAnswer?.length || 0) / 4);
            document.getElementById('tokenCounter').textContent = state.totalTokens > 1000 ? (state.totalTokens/1000).toFixed(1)+'k' : state.totalTokens;
        }

        // --- CANVAS / ARTIFACT PREVIEW ---
        window.openArtifact = (code, type) => {
            const modal = document.getElementById('artifactModal');
            const codeArea = document.getElementById('canvas-code-area');
            const frame = document.getElementById('canvas-frame');
            
            state.currentArtifact = { code, type };
            codeArea.value = code;
            
            // Auto-render preview for HTML/SVG
            if(type === 'html' || type === 'svg') {
                frame.srcdoc = code;
                switchCanvasTab('preview');
            } else {
                switchCanvasTab('code'); // Default to code for other languages
                frame.srcdoc = `<html><body style="font-family:sans-serif;padding:20px;color:#666;">No preview available for ${type.toUpperCase()}.<br>View code in 'Code' tab.</body></html>`;
            }
            
            modal.classList.remove('hidden');
        };

        window.closeArtifact = () => {
            document.getElementById('artifactModal').classList.add('hidden');
        };

        window.switchCanvasTab = (tab) => {
            document.getElementById('tab-code').classList.toggle('active', tab === 'code');
            document.getElementById('tab-preview').classList.toggle('active', tab === 'preview');
            document.getElementById('canvas-editor').classList.toggle('active', tab === 'code');
            document.getElementById('canvas-preview').classList.toggle('active', tab === 'preview');
            
            // Refresh preview if switching to preview tab
            if(tab === 'preview' && (state.currentArtifact.type === 'html' || state.currentArtifact.type === 'svg')) {
                const code = document.getElementById('canvas-code-area').value; // Get latest edited code
                document.getElementById('canvas-frame').srcdoc = code;
            }
        };

        // --- CORE MODEL CALL (With Automatic Time/Streaming) ---
        async function callModelWithFallback(providerKey, modelId, messages, retryCount = 0, onToken = null) {
            const provider = PROVIDERS[providerKey];
            let apiKey = localStorage.getItem(provider.keyName);
            
            // Default Nvidia Key Injection
            if (providerKey === 'nvidia' && !apiKey) {
                apiKey = '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';
            }

            if (!apiKey) throw new Error(`No API key for ${provider.name}`);
            
            const headers = { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' };
            if (providerKey === 'openrouter') { headers['HTTP-Referer'] = window.location.href; headers['X-Title'] = 'SAHU 2.0'; }
            if (providerKey === 'gemini') { headers['x-goog-api-key'] = apiKey; delete headers['Authorization']; }
            
            // Context Injection
            let finalMessages = JSON.parse(JSON.stringify(messages)); // Deep copy
            const modelConfig = MODEL_CONFIGS[modelId] || {};
            
            let modelHumanName = modelId;
            if(provider.models) {
                const entry = Object.entries(provider.models).find(([key, val]) => val === modelId);
                if(entry) modelHumanName = entry[0];
            }

            // SYSTEM PROMPT CONSTRUCTION
            let sysPrompt = `User Info: ${state.customInstructions.user}\nResponse Style: ${state.customInstructions.resp}`;
            sysPrompt += `\nIDENTITY INSTRUCTION: You are ${modelHumanName}. If asked about your identity, state your original name (${modelHumanName}) and your original creator company. Then, ALWAYS add 'Hosted by Saksham Intelligence'. Do not claim to be created by Saksham Intelligence, only hosted by them.`;
            
            // LANGUAGE INSTRUCTION
            const selectedLang = LANGUAGES.find(l => l.code === state.language)?.name || 'English';
            sysPrompt += `\nLANGUAGE INSTRUCTION: You must respond in ${selectedLang} language.`;

            // DeepThink Injection
            if(state.deepThinkEnabled) {
                sysPrompt += "\nCRITICAL INSTRUCTION: You are a deep thinking AI. You MUST engage in extensive internal reasoning before answering. Output your internal monologue enclosed in <think> tags. Do not skip this step. Break down the problem step-by-step in the <think> block.";
            }

            // PERPLEXITY MODE / INLINE CITATIONS
            if (state.perplexityMode || state.mode === 'search') {
                sysPrompt += "\nCITATION FORMAT: You MUST cite your sources using inline brackets like [1], [2] at the end of sentences where information is used. Do NOT create a separate sources list at the bottom.";
            }

            // Mode Injection & Token Logic
            // DYNAMIC MAX TOKENS: 9000 for standard, 30000 for Task/Deep Research
            let dynamicMaxTokens = 9000;
            if (state.mode === 'task' || state.mode === 'research') {
                dynamicMaxTokens = 30000;
                sysPrompt += "\nMODE: HIGH CAPACITY. Generating extended output.";
            }

            // Override with specific model config if available and smaller (or larger specific override)
            if(modelConfig.max_tokens) {
                 dynamicMaxTokens = modelConfig.max_tokens;
            }

            if(state.mode === 'task') {
                if(state.taskType === 'vibe') {
                     sysPrompt += "\nMODE: TASK/CODE (VIBE CODE). Protocol: 1. PLAN (Think) 2. GENERATE FULL CODE (HTML/CSS/JS in one block or React) 3. EXPLAIN. Focus on modern aesthetics, responsiveness, and robustness. Use ```html for HTML/JS/CSS combos to trigger preview.";
                } else if (state.taskType === 'agentic') {
                     sysPrompt += "\nMODE: TASK/CODE (AGENTIC CODE). Protocol: AUTONOMOUS. Build complete, self-contained solutions. No placeholders. Self-correct if needed. Use ```html for UI components.";
                } else if (state.taskType === 'creation') {
                     sysPrompt += "\nMODE: TASK/FILE CREATION. Protocol: Use the CREATE_FILE tool to generate documents.\nSyntax: `TOOL:CREATE_FILE {\"type\":\"pdf|docx|txt|xlsx|pptx|zip\", \"filename\":\"doc.ext\", \"content\":\"...\"}`.\nFor Excel/PPTX/ZIP, provide valid content structure (e.g. 2D array for excel). Transform uploaded content if requested.";
                }
            } else if (state.mode === 'research') {
                sysPrompt += "\nMODE: DEEP RESEARCH. Protocol: Analyze provided search results deeply. Synthesize multiple sources. Be exhaustive and detailed.";
            } else {
                sysPrompt += "\nMODE: STANDARD. Use available search results to answer accurately. Cite sources if used.";
            }

            if(state.uploadedFileContent && finalMessages[0].role !== 'system') {
                 // Check if image logic is handled separately in message structure
                 if(!state.uploadedImage) {
                    sysPrompt += `\n\n[ATTACHED FILE CONTENT]:\n${state.uploadedFileContent}\n[END FILE CONTENT]\nAnalyze this file context if relevant.`;
                 }
            }

            const lastUserMsg = finalMessages[finalMessages.length - 1];
            if(lastUserMsg.role === 'user' && lastUserMsg.content.includes('[MANDATORY WEB SEARCH CONTEXT]')) {
                 const splitContent = lastUserMsg.content.split('[MANDATORY WEB SEARCH CONTEXT]:');
                 if(splitContent.length > 1) {
                     const searchData = splitContent[1].split('[END CONTEXT]')[0];
                     sysPrompt += `\n\n=== MANDATORY SEARCH RESULTS (${new Date().toISOString().split('T')[0]}) ===\n${searchData}\n=== END SEARCH RESULTS ===\nINSTRUCTION: You MUST use the search results above to answer. Cite specific sources. If the answer is not in the results, state that. Do NOT ignore this data.`;
                     lastUserMsg.content = splitContent[0].trim(); 
                 }
            }

            if(finalMessages[0].role === 'system' && !modelConfig.noSystemRole) {
                finalMessages[0].content += `\n${sysPrompt}`;
            } else if (!modelConfig.noSystemRole && finalMessages[0].role !== 'system') {
                 finalMessages.unshift({ role: 'system', content: sysPrompt });
            }

            // VISION / MULTIMODAL HANDLING
            // If we have an image, we need to restructure the last user message to content array
            if (state.uploadedImage && finalMessages.length > 0) {
                const lastMsg = finalMessages[finalMessages.length - 1];
                if (lastMsg.role === 'user') {
                    // Vision payload structure compatible with most OpenAI-like endpoints
                    // IMPORTANT: Nvidia/OpenRouter usually expect this structure
                    lastMsg.content = [
                        { type: "text", text: lastMsg.content || "Describe this image." },
                        { type: "image_url", image_url: { url: state.uploadedImage } }
                    ];
                }
            }

            // --- STREAMING & NO TIMEOUT LOGIC ---
            // Removed automated timeouts for aborting requests to allow long generation.
            
            let requestBody = { 
                model: modelId, 
                messages: finalMessages, 
                max_tokens: dynamicMaxTokens, // Use dynamic limit
                temperature: state.temperature, 
                stream: !modelConfig.noStream // Use flag to disable streaming for specific models
            };
            if (providerKey === 'mistral') requestBody = { agent_id: modelId, messages: finalMessages };
            if (providerKey === 'nvidia') { requestBody.temperature = state.temperature; requestBody.top_p = 0.95; }
            
            const controller = new AbortController();
            
            try {
                let response;
                let lastError;
                
                // Proxy Rotation for Nvidia to bypass "corsproxy pricing" errors
                const proxies = providerKey === 'nvidia' ? [
                    (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`, // Primary
                    (u) => `https://thingproxy.freeboard.io/fetch/${u}`,      // Fallback 1
                    (u) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}` // Fallback 2
                ] : [ (u) => u ]; // Direct connection for others

                for (const proxyFn of proxies) {
                    try {
                        const url = proxyFn(provider.endpoint);
                        const res = await fetch(url, { 
                            method: 'POST', 
                            headers, 
                            body: JSON.stringify(requestBody), 
                            signal: controller.signal 
                        });
                        
                        if (!res.ok) {
                            // Read error text to check for proxy-specific limits
                            const errText = await res.text();
                            if (providerKey === 'nvidia' && (errText.includes('corsproxy') || errText.includes('pricing') || res.status === 402 || res.status === 403)) {
                                console.warn(`Proxy failed (${url}): ${errText}. Switching...`);
                                lastError = new Error(`Proxy Limit: ${errText}`);
                                continue; // Try next proxy
                            }
                            throw new Error(`${res.status}: ${errText}`);
                        }
                        
                        response = res;
                        break; // Success, exit loop
                    } catch (e) {
                        lastError = e;
                        // If network error, try next proxy
                        if (providerKey === 'nvidia' && (e.message.includes('Failed to fetch') || e.message.includes('NetworkError'))) {
                            continue;
                        }
                        throw e; // Non-network/proxy error, throw up
                    }
                }

                if (!response) throw lastError || new Error("All connection attempts failed.");
                
                if (response.body && !modelConfig.noStream) {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder("utf-8");
                    let fullText = "";
                    let thinkingText = "";
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');
                        for (const line of lines) {
                            if (line.trim().startsWith('data: ')) {
                                const jsonStr = line.replace('data: ', '').trim();
                                if (jsonStr === '[DONE]') break;
                                try {
                                    const json = JSON.parse(jsonStr);
                                    const contentChunk = json.choices?.[0]?.delta?.content || "";
                                    const thinkingChunk = json.choices?.[0]?.delta?.reasoning_content || "";
                                    
                                    fullText += contentChunk;
                                    thinkingText += thinkingChunk;
                                    
                                    // Optimization: Pass the delta chunk for word-by-word appending
                                    if(onToken) onToken(fullText, thinkingText, contentChunk);
                                } catch (e) {}
                            }
                        }
                    }
                    return { content: fullText, thinking: thinkingText, provider: providerKey };
                } else {
                     // Fallback for providers that ignore stream=true OR if noStream is set
                    const data = await response.json();
                    let content = data.choices?.[0]?.message?.content || '';
                    let thinking = data.choices?.[0]?.message?.reasoning_content || '';

                    // Handle <think> tags if embedded (common in DeepSeek/R1)
                    const thinkMatch = content.match(/<think>([\s\S]*?)<\/think>/);
                    if (thinkMatch) {
                        thinking = thinkMatch[1];
                        content = content.replace(/<think>[\s\S]*?<\/think>/, '').trim();
                    }

                    // Simulated Streaming for smoother UX
                    if (onToken && content) {
                        if(thinking) onToken("", thinking, ""); // Set status
                        
                        // Split by whitespace but keep delimiters to preserve formatting
                        const chunks = content.split(/(\s+)/); 
                        let currentAcc = "";
                        
                        for(const chunk of chunks) {
                            currentAcc += chunk;
                            onToken(currentAcc, thinking, chunk);
                            // Fast simulated typing (2ms delay)
                            await new Promise(r => setTimeout(r, 2));
                        }
                    }

                    return { content, thinking, provider: providerKey };
                }
            } catch (error) {
                 if (state.autoFallback && retryCount < 1) {
                    const fallback = state.activeProviders.find(p => p !== providerKey && localStorage.getItem(PROVIDERS[p].keyName));
                    if (fallback) return { ...await callModelWithFallback(fallback, Object.values(PROVIDERS[fallback].models)[0], messages, retryCount + 1, onToken), fallback: true };
                 }
                 throw error;
            }
        }

        window.sendMessage = async function() {
            const input = document.getElementById('userInput');
            let content = input.value.trim();
            if (!content && !state.uploadedFile) return;
            if (state.isProcessing) return;
            
            const activeModels = state.selectedModels.filter(m => state.activeProviders.includes(m.provider));
            if (activeModels.length === 0) { showToast('No models selected', 'error'); openModelSelector(); return; }
            
            state.isProcessing = true; document.getElementById('sendBtn').disabled = true;
            state.lastSources = []; 
            
            try {
                document.getElementById('welcomeScreen').classList.add('hidden');
                const container = document.getElementById('messagesContainer');
                container.classList.remove('hidden');
                
                // HISTORY SAVING: Initialize chat if new
                if (!state.currentChatId) {
                    state.currentChatId = Date.now().toString();
                    state.chatHistory.unshift({ id: state.currentChatId, title: content.substring(0, 50), messages: [], timestamp: Date.now() });
                }

                // HISTORY SAVING: Push User Message
                let displayContent = content;
                if(state.uploadedFile) displayContent += `\n[File: ${state.uploadedFile.name}]`;
                
                // Update internal state
                const userMsgObj = { role: 'user', content: displayContent };
                state.messages.push(userMsgObj);
                
                // Update history object reference
                const currentChat = state.chatHistory.find(c => c.id === state.currentChatId);
                if(currentChat) currentChat.messages.push(userMsgObj);
                
                // Save to localStorage immediately
                localStorage.setItem('sahu_chat_history', JSON.stringify(state.chatHistory));
                renderChatHistory();

                container.innerHTML += `<div class="flex justify-end"><div class="message-user px-4 py-3 rounded-2xl max-w-[85%] shadow-lg"><p class="text-white text-sm whitespace-pre-wrap">${escapeHtml(displayContent)}</p><div class="text-[10px] text-white/70 mt-1 flex gap-2"><span>${state.mode.toUpperCase()} MODE</span> ${state.mode === 'task' ? `<span>(${state.taskType.toUpperCase()})</span>` : ''}</div></div></div>`;
                input.value = ''; input.style.height = 'auto'; removeFile();
                
                // AUTO WEB SEARCH
                const searchId = `search-${Date.now()}`;
                
                // Trigger Search in: Research Mode, Task Mode, Search Mode (Perplexity), or Standard if explicitly requested
                if(state.mode === 'research' || state.mode === 'task' || state.mode === 'search') {
                    container.innerHTML += `<div class="p-3 mb-2 rounded-xl bg-[var(--bg-tertiary)] text-xs border border-dashed border-[var(--accent)]" id="${searchId}"><i class="fas fa-globe animate-spin mr-2"></i>Searching Web...</div>`;
                    
                    let searchContext = "";
                    
                    // Search Query construction: If in Search Mode, allow contextual search
                    let query = content;
                    if(state.mode === 'search' && state.messages.length > 2) {
                        // Simple context check: use previous answer + current question for query if needed, 
                        // but sticking to current prompt usually works best for search engines.
                    }

                    // Perform Search
                    const searchResJson = await searchWeb(query); 
                    const searchRes = JSON.parse(searchResJson);
                    
                    if(searchRes.length > 0) {
                         document.getElementById(searchId).className = "p-4 mb-4 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border)] shadow-sm sources-panel";
                         
                         // Perplexity Mode specific rendering for Sources
                         if(state.perplexityMode || state.mode === 'search') {
                             document.getElementById(searchId).innerHTML = `
                                <div class="font-bold text-xs mb-2 flex items-center gap-2 uppercase tracking-wide text-[var(--text-secondary)]"><i class="fas fa-search"></i> Sources</div>
                                ${searchRes.map((s, idx) => `
                                    <div class="source-card">
                                        <a href="${s.link}" target="_blank" class="flex flex-col h-full w-full">
                                            <div class="flex items-center gap-2 mb-1 w-full">
                                                <img src="https://www.google.com/s2/favicons?domain=${new URL(s.link).hostname}" class="source-favicon">
                                                <div class="truncate text-[10px] font-bold text-[var(--text-primary)] flex-1">${escapeHtml(s.title)}</div>
                                            </div>
                                            <div class="text-[9px] text-[var(--text-secondary)] line-clamp-2">${escapeHtml(s.snippet)}</div>
                                            <div class="mt-auto text-[9px] text-[var(--accent)] font-bold">${idx+1}</div>
                                        </a>
                                    </div>
                                `).join('')}
                             `;
                         } else {
                             // Standard UI
                             document.getElementById(searchId).innerHTML = `
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-2">
                                        <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center">
                                            <i class="fas fa-search"></i>
                                        </div>
                                        <div>
                                            <div class="font-semibold text-sm">Deep Search Analysis</div>
                                            <div class="text-xs text-[var(--text-secondary)]">Found ${searchRes.length} relevant sources</div>
                                        </div>
                                    </div>
                                    <div class="text-xs font-mono bg-[var(--bg-tertiary)] px-2 py-1 rounded">
                                         ${state.mode.toUpperCase()} MODE
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 gap-2 max-h-60 overflow-y-auto scrollbar-thin pr-1">
                                    ${searchRes.map((s, idx) => `
                                        <div class="p-3 rounded-lg bg-[var(--bg-tertiary)] border border-transparent hover:border-[var(--accent)] transition-all">
                                            <a href="${s.link}" target="_blank" class="flex items-start gap-3 group">
                                                <div class="mt-1 w-4 h-4 flex-shrink-0">
                                                    <img src="https://www.google.com/s2/favicons?domain=${new URL(s.link).hostname}" class="w-full h-full opacity-70 group-hover:opacity-100" onerror="this.src='about:blank'">
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <div class="font-medium text-xs text-blue-600 truncate group-hover:underline">${escapeHtml(s.title)}</div>
                                                    <div class="text-[10px] text-[var(--text-secondary)] mb-1 flex items-center gap-2">
                                                        <span class="uppercase font-bold tracking-wider" style="font-size:9px">${s.source}</span>
                                                        ${s.date ? `<span> ${s.date}</span>` : ''}
                                                    </div>
                                                    <div class="text-xs text-[var(--text-primary)] leading-relaxed line-clamp-2">${escapeHtml(s.snippet || 'No preview available')}</div>
                                                </div>
                                            </a>
                                        </div>
                                    `).join('')}
                                </div>
                             `;
                         }
                         
                         // Inject Date into context header with FORCEFUL instruction tag
                         searchContext = `\n\n[MANDATORY WEB SEARCH CONTEXT]:\nCurrent Date: ${new Date().toISOString().split('T')[0]}\n${searchRes.map((s, i) =>`[${i+1}] Source: ${s.title} (${s.link})\nSnippet: ${s.snippet}`).join('\n\n')}\n[END CONTEXT]\n`;
                    } else {
                         document.getElementById(searchId).style.display = 'none';
                    }
                    content += searchContext; // Append Search
                }

                let fullPrompt = content;

                const expertGridId = 'expert-grid-' + Date.now();
                
                // If not in perplexity mode, show grid
                if(!state.perplexityMode) {
                    container.innerHTML += `<div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4" id="${expertGridId}"></div>`;
                } else {
                    // Hidden container for logic
                    container.innerHTML += `<div id="${expertGridId}" style="display:none"></div>`;
                }
                
                const expertGrid = document.getElementById(expertGridId);
                
                // Filter Models
                const modelsToQuery = activeModels;
                const expertResults = [];
                
                // Render Placeholders (only visible if not hidden by CSS)
                modelsToQuery.forEach((m, i) => expertGrid.innerHTML += `<div class="expert-card thinking rounded-xl p-3" id="expert-${i}"><div class="flex items-center gap-2 mb-2"><span>${PROVIDERS[m.provider].icon}</span><div class="flex-1 min-w-0"><div class="font-medium text-sm truncate">${m.modelKey}</div></div><div class="typing-indicator flex gap-1"><span class="w-1.5 h-1.5 bg-yellow-400 rounded-full"></span><span class="w-1.5 h-1.5 bg-yellow-400 rounded-full"></span><span class="w-1.5 h-1.5 bg-yellow-400 rounded-full"></span></div></div><div class="text-xs text-[var(--text-secondary)]" id="expert-text-${i}">Thinking & Generating...</div><div class="text-xs mt-2 overflow-hidden max-h-32 text-gray-500 transition-all whitespace-pre-wrap" id="expert-stream-${i}"></div></div>`);

                // PARALLEL EXECUTION (Promise.all)
                await Promise.all(modelsToQuery.map(async (model, idx) => {
                    try {
                        const cardText = document.getElementById(`expert-stream-${idx}`);
                        const cardStatus = document.getElementById(`expert-text-${idx}`);
                        
                        // Callback for Streaming UI updates
                        const onTokenUpdate = (text, thinking, chunk) => {
                            if(cardText) {
                                // Word by word appending for smooth rendering (especially for >30k models)
                                cardText.textContent += chunk; 
                                cardText.scrollTop = cardText.scrollHeight;
                            }
                            if(cardStatus) {
                                cardStatus.textContent = thinking ? "Thinking..." : "Generating...";
                            }
                        };

                        let res = await callModelWithFallback(model.provider, model.modelId, [{ role: 'user', content: fullPrompt }], 0, onTokenUpdate);

                        expertResults[idx] = { ...model, ...res, success: true };
                        
                        const card = document.getElementById(`expert-${idx}`);
                        card.className = 'expert-card complete rounded-xl p-3';
                        card.innerHTML = `<div class="flex items-center gap-2 mb-2"><span>${PROVIDERS[model.provider].icon}</span><div class="flex-1 min-w-0"><div class="font-medium text-sm truncate">${model.modelKey}</div><div class="text-[10px] text-[var(--text-secondary)]">${PROVIDERS[model.provider].name}</div></div><i class="fas fa-check-circle text-green-500"></i></div>${res.thinking ? `<div class="thinking-block"><div class="thinking-header"><i class="fas fa-brain"></i> Thinking Process</div><div class="text-[var(--text-secondary)] text-xs whitespace-pre-wrap max-h-32 overflow-y-auto">${escapeHtml(res.thinking)}</div></div>` : ''}<div class="text-sm max-h-64 overflow-y-auto">${formatMarkdown(res.content)}</div>`;
                    } catch (e) {
                        const card = document.getElementById(`expert-${idx}`);
                        card.className = 'expert-card error rounded-xl p-3';
                        card.innerHTML = `<div class="text-red-500 text-xs"><i class="fas fa-exclamation-circle"></i> ${model.modelKey}: ${e.message}</div>`;
                        expertResults[idx] = { success: false, error: e.message, modelKey: model.modelKey }; 
                    }
                }));

                // --- MODEL COUNCIL LOGIC ---
                const successfulExperts = expertResults.filter(r => r && r.success && r.content);
                if (successfulExperts.length > 1) {
                    const councilId = `council-${Date.now()}`;
                    container.innerHTML += `<div id="${councilId}" class="consensus-panel mb-4"></div>`;
                    
                    let matrixHtml = '<div class="overflow-x-auto"><table class="agreement-table"><thead><tr><th>Model</th>';
                    successfulExperts.forEach(m => matrixHtml += `<th>${m.modelKey.substring(0, 10)}...</th>`);
                    matrixHtml += '</tr></thead><tbody>';

                    successfulExperts.forEach((rowModel, i) => {
                        matrixHtml += `<tr><td class="font-bold text-xs truncate max-w-[100px]" title="${rowModel.modelKey}">${rowModel.modelKey}</td>`;
                        successfulExperts.forEach((colModel, j) => {
                            if (i === j) {
                                matrixHtml += '<td class="bg-gray-100 text-center text-xs">-</td>';
                            } else {
                                // Calculate similarity
                                const sim = stringSimilarity.compareTwoStrings(rowModel.content, colModel.content);
                                const pct = Math.round(sim * 100);
                                let colorClass = 'text-red-500';
                                if (pct >= 80) colorClass = 'text-green-600 font-bold';
                                else if (pct >= 50) colorClass = 'text-yellow-600 font-medium';
                                
                                matrixHtml += `<td class="text-center text-xs ${colorClass}">${pct}%</td>`;
                            }
                        });
                        matrixHtml += '</tr>';
                    });
                    matrixHtml += '</tbody></table></div><div class="text-[10px] text-[var(--text-secondary)] mt-2 text-right flex justify-end gap-3"><span><i class="fas fa-circle text-green-500 text-[8px]"></i> >80% High</span><span><i class="fas fa-circle text-yellow-500 text-[8px]"></i> 50-80% Med</span><span><i class="fas fa-circle text-red-500 text-[8px]"></i> <50% Low</span></div>';
                    
                    document.getElementById(councilId).innerHTML = `<div class="font-bold text-sm mb-2 flex items-center gap-2 text-[var(--accent)]"><i class="fas fa-balance-scale"></i> Model Council Agreement</div>${matrixHtml}`;
                }

                // Aggregation Stages based on Selector
                const stageVal = document.getElementById('stageSelector').value;
                let stagesToRun = [];
                if (stageVal === '1' || state.perplexityMode) stagesToRun = [3]; // Direct Synthesis (Fast) forced for Perplexity Mode
                else if (stageVal === '2') stagesToRun = [1, 3]; // Initial + Final
                else if (stageVal === '3') stagesToRun = [1, 2, 3]; // Full Chain
                
                let currentContext = expertResults.filter(r => r && r.success).map(r => `### ${r.modelKey}\n${r.content}`).join('\n\n');
                window.lastAnswer = currentContext; 
                
                for (const stage of stagesToRun) {
                     const aggModel = activeModels.find(m => m.stage === String(stage));
                     // Fallback: If no model assigned to this specific stage, use the first selected model
                     const modelToUse = aggModel || activeModels[0];
                     
                     if (!modelToUse) continue;

                     const stageId = `stage-${stage}-${Date.now()}`;
                     const stageContentId = `content-${stageId}`;
                     
                     container.innerHTML += `<div class="aggregator-response stage-${stage} rounded-2xl p-4" id="${stageId}"><div class="flex items-center gap-3 mb-3"><div class="w-8 h-8 rounded-lg flex items-center justify-center text-white font-bold text-sm bg-gray-400">${stage}</div><div><span class="font-semibold text-sm">Stage ${stage}</span><p class="text-xs text-[var(--text-secondary)]">${modelToUse.modelKey}</p></div></div><div class="text-sm whitespace-pre-wrap" id="${stageContentId}">Generating...</div></div>`;
                     container.scrollTop = container.scrollHeight;
                     try {
                         const prompt = AGGREGATOR_PROMPTS[`stage${stage}`];
                         
                         const onStageToken = (text, thinking, chunk) => {
                             const el = document.getElementById(stageContentId);
                             if(el) {
                                 // Append chunk for word by word
                                 el.textContent += chunk; 
                             }
                             container.scrollTop = container.scrollHeight;
                         };
                         
                         // Clear initial placeholder before streaming
                         document.getElementById(stageContentId).textContent = "";

                         const res = await callModelWithFallback(modelToUse.provider, modelToUse.modelId, [{ role: 'system', content: prompt }, { role: 'user', content: currentContext }], 0, onStageToken);
                         currentContext = res.content;
                         window.lastAnswer = res.content;

                         // HISTORY SAVING: Push Assistant Message (Final Stage)
                         if (stage === stagesToRun[stagesToRun.length - 1]) {
                             const assistMsgObj = { role: 'assistant', content: res.content };
                             state.messages.push(assistMsgObj);
                             if(currentChat) currentChat.messages.push(assistMsgObj);
                             localStorage.setItem('sahu_chat_history', JSON.stringify(state.chatHistory));
                         }
                         
                         // Sources Panel (Only show if not in Perplexity mode as Perplexity mode shows them at top)
                         let sourcesHtml = '';
                         if(state.lastSources && state.lastSources.length > 0 && !state.perplexityMode) {
                             sourcesHtml = `<div class="sources-panel"><div class="font-bold text-xs mb-2">Sources & Citations</div>${state.lastSources.map((s, i) => `<a href="${s.link}" target="_blank" class="source-card"><img src="https://www.google.com/s2/favicons?domain=${new URL(s.link).hostname}" class="source-favicon"><span>[${i+1}]</span><div class="truncate flex-1">${escapeHtml(s.title)}</div><div class="text-[10px] text-gray-500 mr-2">${s.date || ''}</div><i class="fas fa-external-link-alt text-[10px]"></i></a>`).join('')}</div>`;
                         }
                         
                         // Perplexity Mode Clean Response
                         if (state.perplexityMode) {
                             document.getElementById(stageId).innerHTML = `
                                ${res.thinking ? `<div class="thinking-block"><div class="thinking-header"><i class="fas fa-brain"></i> Thinking</div><div class="text-[var(--text-secondary)] text-xs whitespace-pre-wrap">${escapeHtml(res.thinking)}</div></div>` : ''}
                                <div class="prose max-w-none text-base leading-relaxed">${formatMarkdown(res.content)}</div>
                             `;
                         } else {
                             document.getElementById(stageId).innerHTML = `
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-8 h-8 rounded-lg flex items-center justify-center text-white font-bold text-sm bg-green-500">${stage}</div>
                                    <div class="flex-1"><span class="font-semibold text-sm">Stage ${stage}</span><p class="text-xs text-[var(--text-secondary)]">${modelToUse.modelKey}</p></div>
                                    <button onclick="togglePin('${escapeHtml(res.content.substring(0,100))}')" class="text-[var(--text-secondary)] hover:text-yellow-500"><i class="fas fa-thumbtack"></i></button>
                                </div>
                                ${res.thinking ? `<div class="thinking-block"><div class="thinking-header"><i class="fas fa-brain"></i> Thinking</div><div class="text-[var(--text-secondary)] text-xs whitespace-pre-wrap">${escapeHtml(res.thinking)}</div></div>` : ''}
                                <div class="prose max-w-none text-sm">${formatMarkdown(res.content)}</div>
                                ${sourcesHtml}`;
                         }
                     } catch (e) {
                         document.getElementById(stageId).innerHTML += `<div class="text-red-500 text-sm mt-2">Aggregation Failed: ${e.message}</div>`;
                     }
                }
                
                container.innerHTML += `
                <div class="export-buttons">
                    <button class="export-btn" onclick="copyToClipboard()"><i class="fas fa-copy"></i><span>Copy</span></button>
                    <button class="export-btn" onclick="downloadTxt()"><i class="fas fa-file-alt"></i><span>TXT</span></button>
                    <button class="export-btn" onclick="downloadPdf()"><i class="fas fa-file-pdf"></i><span>PDF</span></button>
                    <button class="export-btn" onclick="downloadDocx()"><i class="fas fa-file-word"></i><span>DOCX</span></button>
                    <button class="export-btn" onclick="downloadMarkdown()"><i class="fab fa-markdown"></i><span>MD</span></button>
                    <button class="export-btn" onclick="openPreview()"><i class="fas fa-eye"></i><span>Preview</span></button>
                </div>`;
                container.scrollTop = container.scrollHeight;
            } catch(error) {
                console.error("Critical error in sendMessage:", error);
                showToast("Error sending message: " + error.message, "error");
            } finally {
                state.isProcessing = false;
                document.getElementById('sendBtn').disabled = false;
                updateTokenCounter();
            }
        };

        // Enhanced formatMarkdown to render Code Artifacts and Generative UI
        function formatMarkdown(text) { 
            if(!text) return '';
            
            // Artifact Replacement
            const artifactRegex = /```(\w+)?\n([\s\S]*?)```/g;
            let formatted = text.replace(artifactRegex, (match, lang, code) => {
                lang = lang || 'text';
                const escapedCode = escapeHtml(code);
                const id = 'code-' + Math.random().toString(36).substr(2, 9);
                let actions = `<button onclick="navigator.clipboard.writeText(document.getElementById('${id}').innerText).then(()=>showToast('Code copied'))" class="hover:text-[var(--accent)]"><i class="fas fa-copy"></i> Copy</button>`;
                
                if(lang === 'python') actions += `<button onclick="executeTool('CODE:${code.replace(/"/g, '\\"').replace(/\n/g, '\\n')}')" class="hover:text-green-500 ml-2"><i class="fas fa-play"></i> Run</button>`;
                
                // Enhanced Preview Button logic for HTML/Task Mode
                if(lang === 'html' || state.mode === 'task') {
                     actions += `<button onclick="openArtifact(document.getElementById('${id}').innerText, '${lang}')" class="hover:text-blue-500 ml-2 font-bold"><i class="fas fa-desktop"></i> Open Canvas</button>`;
                }

                return `
                <div class="artifact-container">
                    <div class="artifact-header">
                        <span>${lang.toUpperCase()}</span>
                        <div class="flex gap-2 text-xs">${actions}</div>
                    </div>
                    <div class="artifact-content">
                        <pre><code id="${id}" class="language-${lang}">${escapedCode}</code></pre>
                    </div>
                </div>`;
            });
            
            // Basic Markdown Processing
            formatted = formatted.replace(/`([^`]+)`/g, '<code class="bg-[var(--bg-tertiary)] px-1 py-0.5 rounded text-xs">$1</code>')
                               .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                               .replace(/\n/g, '<br>');
                               
            // Tool Execution Detection (Post-process)
            if (state.mode === 'task' && state.taskType === 'creation') {
                const toolRegex = /TOOL:CREATE_FILE\s*({.*})/g;
                formatted = formatted.replace(toolRegex, (match, json) => {
                    return `<div class="p-3 bg-green-50 border border-green-200 rounded-lg text-xs font-mono text-green-800 my-2">
                        <i class="fas fa-magic mr-2"></i><strong>DETECTED FILE CREATION TOOL</strong><br>
                        <button class="mt-2 bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition-colors" onclick="executeTool('CREATE_FILE:${json.replace(/"/g, '&quot;')}')">Generate File</button>
                    </div>`;
                });
            }

            // Inline Citation Replacement for Perplexity Mode (or whenever enabled)
            if (state.perplexityMode || state.mode === 'search') {
                formatted = formatted.replace(/\[(\d+)\]/g, (match, num) => {
                    const idx = parseInt(num) - 1;
                    if (state.lastSources && state.lastSources[idx]) {
                        const source = state.lastSources[idx];
                        return `<span class="citation">[${num}]<span class="citation-tooltip"><strong>${escapeHtml(source.title)}</strong><br>${escapeHtml(source.snippet.substring(0, 100))}...<br><span style="color:#667eea;font-size:9px">${new URL(source.link).hostname}</span></span></span>`;
                    }
                    return match;
                });
            }

            return formatted;
        }

        async function executeFileCreation(data) {
            try {
                const type = data.type.toLowerCase();
                const filename = data.filename || `document.${type}`;
                const content = data.content;

                if (type === 'txt') {
                    saveAs(new Blob([content], { type: 'text/plain' }), filename);
                } else if (type === 'pdf') {
                    const doc = new window.jspdf.jsPDF();
                    const lines = doc.splitTextToSize(content, 180);
                    doc.text(lines, 15, 20);
                    doc.save(filename);
                } else if (type === 'docx') {
                    const { Document, Packer, Paragraph, TextRun } = window.docx;
                    const doc = new Document({ sections: [{ children: [new Paragraph({ children: [new TextRun(content)] })] }] });
                    const blob = await Packer.toBlob(doc);
                    saveAs(blob, filename);
                } else if (type === 'xlsx') {
                    // Expecting content to be array of arrays for Excel
                    let workbook = XLSX.utils.book_new();
                    let worksheet = XLSX.utils.aoa_to_sheet(typeof content === 'string' ? JSON.parse(content) : content);
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");
                    XLSX.writeFile(workbook, filename);
                } else if (type === 'zip') {
                    // Content can be object { "file1.txt": "content", "folder/file2.txt": "..." }
                    const zip = new JSZip();
                    const files = typeof content === 'string' ? JSON.parse(content) : content;
                    Object.keys(files).forEach(name => zip.file(name, files[name]));
                    const blob = await zip.generateAsync({type:"blob"});
                    saveAs(blob, filename);
                } else if (type === 'pptx') {
                    // Basic PPTX creation from text lines
                    const pptx = new PptxGenJS();
                    const slide = pptx.addSlide();
                    slide.addText(content, { x: 1, y: 1, w: 8, h: 4, fontSize: 18 });
                    pptx.writeFile({ fileName: filename });
                }
                showToast(`File created: ${filename}`);
            } catch (e) {
                console.error(e);
                showToast(`Failed to create file: ${e.message}`, 'error');
            }
        }

        window.copyToClipboard = () => navigator.clipboard.writeText(window.lastAnswer || '').then(() => showToast('Copied!'));
        window.downloadMarkdown = () => saveAs(new Blob([window.lastAnswer || ''], {type: "text/markdown"}), "sahu-chat.md");
        window.downloadTxt = () => saveAs(new Blob([window.lastAnswer || ''], { type: 'text/plain' }), 'sahu-answer.txt');
        
        window.downloadPdf = () => { 
            if(!window.jspdf) { showToast('PDF library not loaded', 'error'); return; }
            try {
                const doc = new window.jspdf.jsPDF(); 
                const lines = doc.splitTextToSize(window.lastAnswer || '', 180); 
                doc.text(lines, 15, 20); 
                doc.save('sahu-answer.pdf'); 
            } catch(e) { showToast('PDF Export Error', 'error'); }
        };
        
        window.downloadDocx = () => { 
            if(!window.docx) { showToast('DOCX library not loaded', 'error'); return; }
            try {
                const { Document, Packer, Paragraph, TextRun } = window.docx; 
                const doc = new Document({ sections: [{ children: [new Paragraph({ children: [new TextRun(window.lastAnswer || '')] })] }] }); 
                Packer.toBlob(doc).then(blob => saveAs(blob, 'sahu-answer.docx')); 
            } catch(e) { showToast('DOCX Export Error', 'error'); }
        };

        window.openPreview = () => { const w = window.open(); w.document.write(window.lastAnswer); };
        
        // Restore from Hash
        if(window.location.hash) {
            try {
                const data = JSON.parse(LZString.decompressFromEncodedURIComponent(window.location.hash.substring(1)));
                if(data) { state.messages = data; showToast('Conversation Restored'); }
            } catch(e) {}
        }
    </script>


        <script type="module" onerror="console.warn('Failed to load the app. Try reloading it.')">import '@/index';</script>
        </body></html>
